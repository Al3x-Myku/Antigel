<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Task Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 text-white min-h-screen p-4">

    <!-- Login Screen -->
    <div id="loginScreen" class="max-w-md mx-auto">
        <div class="text-center mb-8">
            <div class="text-8xl mb-6">üîê</div>
            <h1 class="text-5xl font-bold mb-4 bg-gradient-to-r from-cyan-400 to-purple-400 bg-clip-text text-transparent">
                Community Task Manager
            </h1>
            <p class="text-gray-400 mb-8">Connect your wallet to get started</p>
        </div>

        <div class="bg-gray-800/50 backdrop-blur-lg p-8 rounded-xl shadow-2xl border border-gray-700">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold mb-2">Welcome!</h2>
                <p class="text-gray-400 text-sm">Connect with MetaMask to access the task marketplace</p>
            </div>
            
            <button id="loginButton" class="w-full bg-gradient-to-r from-orange-500 to-pink-500 hover:from-orange-600 hover:to-pink-600 text-white font-bold py-4 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-orange-500/50 flex items-center justify-center gap-3 text-lg">
                <svg class="w-8 h-8" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M38 20C38 29.9411 29.9411 38 20 38C10.0589 38 2 29.9411 2 20C2 10.0589 10.0589 2 20 2C29.9411 2 38 10.0589 38 20Z" fill="#E17726" stroke="#E17726" stroke-width="0.25"/>
                    <path d="M20 2L14 16L20 20L26 16L20 2Z" fill="#E27625"/>
                    <path d="M20 20L14 16L11 23L20 27L29 23L26 16L20 20Z" fill="#F5841F"/>
                    <path d="M20 27L11 23L9 31L20 38L31 31L29 23L20 27Z" fill="#C0AC9D"/>
                </svg>
                Connect with MetaMask
            </button>

            <div class="mt-6 p-4 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                <p class="text-sm text-blue-300 flex items-start gap-2">
                    <span class="text-xl">‚ÑπÔ∏è</span>
                    <span>Make sure you're connected to <strong>Sepolia Testnet</strong> in MetaMask</span>
                </p>
            </div>

            <div class="mt-6 text-center text-sm text-gray-500">
                <p>Need Sepolia ETH? Get free testnet tokens:</p>
                <a href="https://sepoliafaucet.com/" target="_blank" class="text-cyan-400 hover:text-cyan-300 underline">Sepolia Faucet</a>
            </div>
        </div>

        <div class="mt-8 text-center text-gray-500 text-sm">
            <p>üîí Secure ¬∑ üåê Decentralized ¬∑ ‚ö° Fast</p>
        </div>
    </div>

    <!-- Main App (hidden until logged in) -->
    <div id="mainApp" class="max-w-6xl mx-auto py-8 hidden">
        
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-5xl font-bold mb-2 bg-gradient-to-r from-cyan-400 to-purple-400 bg-clip-text text-transparent">
                Community Task Manager
            </h1>
            <p class="text-gray-400">Create tasks, earn rewards, build community</p>
        </div>

        <!-- Wallet Connection -->
        <div class="bg-gray-800/50 backdrop-blur-lg p-6 rounded-xl shadow-2xl border border-gray-700 mb-6">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-pink-500 rounded-full flex items-center justify-center text-2xl">
                        üë§
                    </div>
                    <div>
                        <h2 class="text-xl font-semibold mb-1">Connected</h2>
                        <p class="text-sm text-gray-400">Sepolia Testnet</p>
                    </div>
                </div>
                <button id="disconnectWallet" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm">
                    Disconnect
                </button>
            </div>
            <div class="mt-4">
                <div class="bg-gray-700/50 rounded-lg p-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <span class="text-gray-400 text-sm">Address:</span>
                            <p id="userAddress" class="text-white font-mono text-sm break-all"></p>
                        </div>
                        <div>
                            <span class="text-gray-400 text-sm">Balance:</span>
                            <p id="userBalance" class="text-white font-mono text-sm"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            
            <!-- Create Task -->
            <div class="bg-gray-800/50 backdrop-blur-lg p-6 rounded-xl shadow-2xl border border-gray-700">
                <h2 class="text-2xl font-semibold mb-4 flex items-center">
                    <span class="text-3xl mr-2">üìù</span> Create Task
                </h2>
                <form id="createTaskForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Task Description (URI)</label>
                        <input type="text" id="taskMetadata" placeholder="ipfs://QmExample..." 
                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Reward Token ID</label>
                        <input type="number" id="rewardId" value="0" placeholder="0 for Community Token"
                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500">
                        <p class="text-xs text-gray-500 mt-1">ID 0 = Community Token (fungible), 1+ = NFT Badges</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Reward Amount</label>
                        <input type="number" id="rewardAmount" value="100" placeholder="100"
                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500">
                        <p class="text-xs text-gray-500 mt-1">For fungible tokens, amount in tokens (e.g., 100)</p>
                    </div>
                    <button type="submit" class="w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg">
                        Create Task
                    </button>
                </form>
                <div id="createTaskResult" class="mt-4 p-3 bg-gray-700/50 rounded-lg text-sm text-gray-300 hidden"></div>
            </div>

            <!-- Task List -->
            <div class="bg-gray-800/50 backdrop-blur-lg p-6 rounded-xl shadow-2xl border border-gray-700">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-semibold flex items-center">
                        <span class="text-3xl mr-2">üìã</span> Task List
                    </h2>
                    <button id="refreshTasks" class="bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition duration-300 text-sm">
                        üîÑ Refresh
                    </button>
                </div>
                <div id="taskList" class="space-y-3 max-h-96 overflow-y-auto">
                    <p class="text-gray-400 text-center py-8">Connect wallet to view tasks</p>
                </div>
            </div>
        </div>

        <!-- Task Actions -->
        <div class="bg-gray-800/50 backdrop-blur-lg p-6 rounded-xl shadow-2xl border border-gray-700">
            <h2 class="text-2xl font-semibold mb-4 flex items-center">
                <span class="text-3xl mr-2">‚ö°</span> Task Actions
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                
                <!-- Claim Task -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Claim Task</label>
                    <div class="flex gap-2">
                        <input type="number" id="claimTaskId" placeholder="Task ID"
                            class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="claimTaskBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold px-4 py-2 rounded-lg transition duration-300">
                            Claim
                        </button>
                    </div>
                    <div id="claimResult" class="mt-2 text-xs text-gray-400 hidden"></div>
                </div>

                <!-- Complete Task -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Complete Task</label>
                    <div class="flex gap-2">
                        <input type="number" id="completeTaskId" placeholder="Task ID"
                            class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-yellow-500">
                        <button id="completeTaskBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold px-4 py-2 rounded-lg transition duration-300">
                            Complete
                        </button>
                    </div>
                    <div id="completeResult" class="mt-2 text-xs text-gray-400 hidden"></div>
                </div>

                <!-- Verify Task -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Verify & Reward</label>
                    <div class="flex gap-2">
                        <input type="number" id="verifyTaskId" placeholder="Task ID"
                            class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-green-500">
                        <button id="verifyTaskBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold px-4 py-2 rounded-lg transition duration-300">
                            Verify
                        </button>
                    </div>
                    <div id="verifyResult" class="mt-2 text-xs text-gray-400 hidden"></div>
                </div>
            </div>
        </div>

        <!-- My Rewards -->
        <div class="bg-gray-800/50 backdrop-blur-lg p-6 rounded-xl shadow-2xl border border-gray-700 mt-6">
            <h2 class="text-2xl font-semibold mb-4 flex items-center">
                <span class="text-3xl mr-2">üèÜ</span> My Rewards
            </h2>
            <div id="rewardsList" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <p class="text-gray-400 text-center py-8 col-span-3">Connect wallet to view rewards</p>
            </div>
        </div>
    </div>

    <script>
        // Contract addresses and ABIs from deployment.json
        const REWARD_CONTRACT_ADDRESS = "0x8a564BdbbbD1Faf313a3380B10d373c1e2622167";
        const TASK_CONTRACT_ADDRESS = "0xa564E0967A252E813051Cb278BF84fE567617D2E";
        
        const TASK_CONTRACT_ABI = [{"inputs":[{"internalType":"address","name":"_rewardContractAddress","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":true,"internalType":"address","name":"completer","type":"address"}],"name":"TaskClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":true,"internalType":"address","name":"completer","type":"address"}],"name":"TaskCompleted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":true,"internalType":"address","name":"creator","type":"address"},{"indexed":false,"internalType":"string","name":"metadataURI","type":"string"}],"name":"TaskCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":true,"internalType":"address","name":"verifier","type":"address"}],"name":"TaskVerified","type":"event"},{"inputs":[{"internalType":"uint256","name":"_taskId","type":"uint256"}],"name":"claimTask","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_taskId","type":"uint256"}],"name":"completeTask","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_metadataURI","type":"string"},{"internalType":"uint256[]","name":"_rewardIds","type":"uint256[]"},{"internalType":"uint256[]","name":"_rewardAmounts","type":"uint256[]"}],"name":"createTask","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_taskId","type":"uint256"}],"name":"getTask","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"creator","type":"address"},{"internalType":"address","name":"completer","type":"address"},{"internalType":"string","name":"metadataURI","type":"string"},{"internalType":"enum TaskContract.TaskStatus","name":"status","type":"uint8"},{"internalType":"uint256[]","name":"rewardIds","type":"uint256[]"},{"internalType":"uint256[]","name":"rewardAmounts","type":"uint256[]"}],"internalType":"struct TaskContract.Task","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"rewardContract","outputs":[{"internalType":"contract IRewardContract","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"taskCounter","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"tasks","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"creator","type":"address"},{"internalType":"address","name":"completer","type":"address"},{"internalType":"string","name":"metadataURI","type":"string"},{"internalType":"enum TaskContract.TaskStatus","name":"status","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_taskId","type":"uint256"}],"name":"verifyTask","outputs":[],"stateMutability":"nonpayable","type":"function"}];
        
        const REWARD_CONTRACT_ABI = [{"inputs":[{"internalType":"address","name":"admin","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Paused","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"previousAdminRole","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"newAdminRole","type":"bytes32"}],"name":"RoleAdminChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"}],"name":"RoleGranted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"}],"name":"RoleRevoked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256[]","name":"ids","type":"uint256[]"},{"indexed":false,"internalType":"uint256[]","name":"values","type":"uint256[]"}],"name":"TransferBatch","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"TransferSingle","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"value","type":"string"},{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"}],"name":"URI","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Unpaused","type":"event"},{"inputs":[],"name":"COMMUNITY_TOKE_ID","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"DEFAULT_ADMIN_ROLE","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MINTER_ROLE","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"PAUSER_ROLE","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"id","type":"uint256"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address[]","name":"accounts","type":"address[]"},{"internalType":"uint256[]","name":"ids","type":"uint256[]"}],"name":"balanceOfBatch","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"}],"name":"getRoleAdmin","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"grantRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"hasRole","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256[]","name":"ids","type":"uint256[]"},{"internalType":"uint256[]","name":"amounts","type":"uint256[]"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"mintBatchReward","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"mintReward","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"pause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"renounceRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"revokeRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256[]","name":"ids","type":"uint256[]"},{"internalType":"uint256[]","name":"amounts","type":"uint256[]"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"safeBatchTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"unpause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"uri","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"}];

        let provider;
        let signer;
        let userAddress;
        let taskContract;
        let rewardContract;

        const statusLabels = ['Created', 'InProgress', 'Completed', 'Verified'];
        const statusColors = ['bg-blue-500', 'bg-yellow-500', 'bg-purple-500', 'bg-green-500'];

        // Login with MetaMask
        document.getElementById('loginButton').addEventListener('click', async () => {
            if (typeof window.ethereum === 'undefined') {
                alert('MetaMask is not installed!\n\nPlease install MetaMask extension to continue.\n\nVisit: https://metamask.io');
                return;
            }

            const loginBtn = document.getElementById('loginButton');
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<span class="animate-pulse">üîÑ Connecting...</span>';

            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                // Check network - Sepolia chainId is 11155111
                const network = await provider.getNetwork();
                if (network.chainId !== 11155111) {
                    alert('‚ö†Ô∏è Wrong Network!\n\nPlease switch to Sepolia Testnet in MetaMask.\n\nCurrent network: ' + network.name);
                    
                    // Try to switch network automatically
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0xaa36a7' }], // 11155111 in hex
                        });
                        // Reload after switch
                        window.location.reload();
                    } catch (switchError) {
                        console.error('Network switch error:', switchError);
                        loginBtn.disabled = false;
                        loginBtn.innerHTML = `
                            <svg class="w-8 h-8" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M38 20C38 29.9411 29.9411 38 20 38C10.0589 38 2 29.9411 2 20C2 10.0589 10.0589 2 20 2C29.9411 2 38 10.0589 38 20Z" fill="#E17726" stroke="#E17726" stroke-width="0.25"/>
                                <path d="M20 2L14 16L20 20L26 16L20 2Z" fill="#E27625"/>
                                <path d="M20 20L14 16L11 23L20 27L29 23L26 16L20 20Z" fill="#F5841F"/>
                                <path d="M20 27L11 23L9 31L20 38L31 31L29 23L20 27Z" fill="#C0AC9D"/>
                            </svg>
                            Connect with MetaMask
                        `;
                    }
                    return;
                }
                
                taskContract = new ethers.Contract(TASK_CONTRACT_ADDRESS, TASK_CONTRACT_ABI, signer);
                rewardContract = new ethers.Contract(REWARD_CONTRACT_ADDRESS, REWARD_CONTRACT_ABI, signer);

                const balance = await provider.getBalance(userAddress);
                
                document.getElementById('userAddress').textContent = userAddress;
                document.getElementById('userBalance').textContent = ethers.utils.formatEther(balance) + ' ETH (Sepolia)';
                
                // Hide login screen, show main app
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');

                await loadTasks();
                await loadRewards();
            } catch (error) {
                console.error('Connection error:', error);
                
                let errorMsg = 'Failed to connect wallet';
                if (error.code === 4001) {
                    errorMsg = 'Connection rejected.\n\nPlease approve the connection in MetaMask to continue.';
                } else if (error.message) {
                    errorMsg = error.message;
                }
                
                alert('‚ùå ' + errorMsg);
                loginBtn.disabled = false;
                loginBtn.innerHTML = `
                    <svg class="w-8 h-8" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M38 20C38 29.9411 29.9411 38 20 38C10.0589 38 2 29.9411 2 20C2 10.0589 10.0589 2 20 2C29.9411 2 38 10.0589 38 20Z" fill="#E17726" stroke="#E17726" stroke-width="0.25"/>
                        <path d="M20 2L14 16L20 20L26 16L20 2Z" fill="#E27625"/>
                        <path d="M20 20L14 16L11 23L20 27L29 23L26 16L20 20Z" fill="#F5841F"/>
                        <path d="M20 27L11 23L9 31L20 38L31 31L29 23L20 27Z" fill="#C0AC9D"/>
                    </svg>
                    Connect with MetaMask
                `;
            }
        });

        // Disconnect Wallet
        document.getElementById('disconnectWallet').addEventListener('click', () => {
            // Clear state
            provider = null;
            signer = null;
            userAddress = null;
            taskContract = null;
            rewardContract = null;
            
            // Show login screen, hide main app
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        });

        // Create Task
        document.getElementById('createTaskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!taskContract) {
                alert('Please connect wallet first');
                return;
            }

            const metadata = document.getElementById('taskMetadata').value;
            const rewardId = document.getElementById('rewardId').value;
            const rewardAmount = document.getElementById('rewardAmount').value;

            const resultDiv = document.getElementById('createTaskResult');
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<span class="text-yellow-400">‚è≥ Creating task...</span>';

            try {
                const amount = ethers.utils.parseEther(rewardAmount);
                const tx = await taskContract.createTask(metadata, [rewardId], [amount]);
                resultDiv.innerHTML = '<span class="text-blue-400">‚è≥ Waiting for confirmation...</span>';
                
                const receipt = await tx.wait();
                resultDiv.innerHTML = '<span class="text-green-400">‚úÖ Task created successfully!</span>';
                
                document.getElementById('createTaskForm').reset();
                setTimeout(() => loadTasks(), 2000);
            } catch (error) {
                console.error('Create task error:', error);
                resultDiv.innerHTML = `<span class="text-red-400">‚ùå Error: ${error.message}</span>`;
            }
        });

        // Load Tasks
        async function loadTasks() {
            if (!taskContract) return;

            try {
                const taskCount = await taskContract.taskCounter();
                const taskListDiv = document.getElementById('taskList');
                
                if (taskCount.eq(0)) {
                    taskListDiv.innerHTML = '<p class="text-gray-400 text-center py-8">No tasks yet. Create the first one!</p>';
                    return;
                }

                taskListDiv.innerHTML = '';
                
                for (let i = 1; i <= taskCount.toNumber(); i++) {
                    const task = await taskContract.getTask(i);
                    const statusIndex = task.status;
                    
                    const taskCard = document.createElement('div');
                    taskCard.className = 'bg-gray-700/50 rounded-lg p-4 border border-gray-600 hover:border-cyan-500 transition';
                    taskCard.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-semibold text-lg">Task #${i}</h3>
                            <span class="${statusColors[statusIndex]} text-xs px-2 py-1 rounded-full">${statusLabels[statusIndex]}</span>
                        </div>
                        <p class="text-sm text-gray-400 mb-2 break-all">${task.metadataURI}</p>
                        <div class="text-xs text-gray-500">
                            <p>Creator: ${task.creator.slice(0, 6)}...${task.creator.slice(-4)}</p>
                            ${task.completer !== ethers.constants.AddressZero ? `<p>Worker: ${task.completer.slice(0, 6)}...${task.completer.slice(-4)}</p>` : ''}
                            <p>Reward: ${ethers.utils.formatEther(task.rewardAmounts[0])} tokens (ID: ${task.rewardIds[0]})</p>
                        </div>
                    `;
                    taskListDiv.appendChild(taskCard);
                }
            } catch (error) {
                console.error('Load tasks error:', error);
            }
        }

        // Claim Task
        document.getElementById('claimTaskBtn').addEventListener('click', async () => {
            if (!taskContract) {
                alert('Please connect wallet first');
                return;
            }

            const taskId = document.getElementById('claimTaskId').value;
            const resultDiv = document.getElementById('claimResult');
            
            if (!taskId) {
                alert('Please enter a task ID');
                return;
            }

            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<span class="text-yellow-400">‚è≥ Claiming task...</span>';

            try {
                const tx = await taskContract.claimTask(taskId);
                resultDiv.innerHTML = '<span class="text-blue-400">‚è≥ Confirming...</span>';
                await tx.wait();
                resultDiv.innerHTML = '<span class="text-green-400">‚úÖ Task claimed!</span>';
                setTimeout(() => loadTasks(), 2000);
            } catch (error) {
                console.error('Claim error:', error);
                resultDiv.innerHTML = `<span class="text-red-400">‚ùå ${error.message}</span>`;
            }
        });

        // Complete Task
        document.getElementById('completeTaskBtn').addEventListener('click', async () => {
            if (!taskContract) {
                alert('Please connect wallet first');
                return;
            }

            const taskId = document.getElementById('completeTaskId').value;
            const resultDiv = document.getElementById('completeResult');
            
            if (!taskId) {
                alert('Please enter a task ID');
                return;
            }

            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<span class="text-yellow-400">‚è≥ Completing task...</span>';

            try {
                const tx = await taskContract.completeTask(taskId);
                resultDiv.innerHTML = '<span class="text-blue-400">‚è≥ Confirming...</span>';
                await tx.wait();
                resultDiv.innerHTML = '<span class="text-green-400">‚úÖ Task completed!</span>';
                setTimeout(() => loadTasks(), 2000);
            } catch (error) {
                console.error('Complete error:', error);
                resultDiv.innerHTML = `<span class="text-red-400">‚ùå ${error.message}</span>`;
            }
        });

        // Verify Task
        document.getElementById('verifyTaskBtn').addEventListener('click', async () => {
            if (!taskContract) {
                alert('Please connect wallet first');
                return;
            }

            const taskId = document.getElementById('verifyTaskId').value;
            const resultDiv = document.getElementById('verifyResult');
            
            if (!taskId) {
                alert('Please enter a task ID');
                return;
            }

            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<span class="text-yellow-400">‚è≥ Verifying task and minting rewards...</span>';

            try {
                const tx = await taskContract.verifyTask(taskId);
                resultDiv.innerHTML = '<span class="text-blue-400">‚è≥ Confirming...</span>';
                await tx.wait();
                resultDiv.innerHTML = '<span class="text-green-400">‚úÖ Task verified & rewards minted!</span>';
                setTimeout(() => {
                    loadTasks();
                    loadRewards();
                }, 2000);
            } catch (error) {
                console.error('Verify error:', error);
                resultDiv.innerHTML = `<span class="text-red-400">‚ùå ${error.message}</span>`;
            }
        });

        // Refresh Tasks
        document.getElementById('refreshTasks').addEventListener('click', loadTasks);

        // Load Rewards
        async function loadRewards() {
            if (!rewardContract || !userAddress) return;

            try {
                const rewardsDiv = document.getElementById('rewardsList');
                rewardsDiv.innerHTML = '';

                // Check balances for token IDs 0-10
                const tokenIds = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
                let hasRewards = false;

                for (const tokenId of tokenIds) {
                    const balance = await rewardContract.balanceOf(userAddress, tokenId);
                    
                    if (!balance.isZero()) {
                        hasRewards = true;
                        const card = document.createElement('div');
                        card.className = 'bg-gradient-to-br from-purple-600/20 to-pink-600/20 rounded-lg p-4 border border-purple-500/50';
                        card.innerHTML = `
                            <div class="text-center">
                                <div class="text-4xl mb-2">${tokenId === 0 ? 'ü™ô' : 'üèÖ'}</div>
                                <h3 class="font-semibold text-lg">${tokenId === 0 ? 'Community Tokens' : `Badge #${tokenId}`}</h3>
                                <p class="text-2xl font-bold text-cyan-400 mt-2">${ethers.utils.formatEther(balance)}</p>
                                <p class="text-xs text-gray-400 mt-1">${tokenId === 0 ? 'Fungible Token' : 'NFT Badge'}</p>
                            </div>
                        `;
                        rewardsDiv.appendChild(card);
                    }
                }

                if (!hasRewards) {
                    rewardsDiv.innerHTML = '<p class="text-gray-400 text-center py-8 col-span-3">No rewards yet. Complete and verify tasks to earn!</p>';
                }
            } catch (error) {
                console.error('Load rewards error:', error);
            }
        }

        // Check if already connected on page load
        window.addEventListener('load', async () => {
            if (window.ethereum && window.ethereum.selectedAddress) {
                // Auto-login if already connected
                document.getElementById('loginButton').click();
            }
        });

        // Listen for account changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    // User disconnected
                    document.getElementById('disconnectWallet').click();
                } else {
                    // Account changed, reload
                    window.location.reload();
                }
            });

            window.ethereum.on('chainChanged', () => {
                // Network changed, reload
                window.location.reload();
            });
        }
    </script>

</body>
</html>
