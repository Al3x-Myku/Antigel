<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community - SideQuests</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        /* Gradient backgrounds */
        .gradient-primary {
            background: linear-gradient(135deg, #DDD92A 0%, #EAE151 100%);
        }
        .gradient-card {
            background: linear-gradient(135deg, #3A3740 0%, #2D2A32 100%);
        }
        /* Dropdown animation */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .dropdown-menu {
            animation: slideDown 0.2s ease-out;
        }
        /* Glassmorphism */
        .glass {
            background: rgba(58, 55, 64, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#DDD92A",
                        "primary-light": "#EAE151",
                        "background-dark": "#2D2A32",
                        "card-dark": "#3A3740",
                        "border-dark": "#4A4750",
                        "text-muted-dark": "#B0ADB5",
                        "cream": "#FAFDF6",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"]
                    },
                },
            },
        }
    </script>
</head>
<body class="font-display bg-background-dark text-cream min-h-screen">
    <!-- Header -->
    <header class="border-b border-border-dark px-6 py-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="size-6 text-primary">
                    <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                        <path d="M24 45.8096C19.6865 45.8096 15.4698 44.5305 11.8832 42.134C8.29667 39.7376 5.50128 36.3314 3.85056 32.3462C2.19985 28.361 1.76794 23.9758 2.60947 19.7452C3.451 15.5145 5.52816 11.6284 8.57829 8.5783C11.6284 5.52817 15.5145 3.45101 19.7452 2.60948C23.9758 1.76795 28.361 2.19986 32.3462 3.85057C36.3314 5.50129 39.7376 8.29668 42.134 11.8833C44.5305 15.4698 45.8096 19.6865 45.8096 24L24 24L24 45.8096Z" fill="currentColor"></path>
                    </svg>
                </div>
                <h2 class="text-xl font-bold">SideQuests</h2>
            </div>
            <a href="/my-communities" class="text-sm hover:text-primary transition-colors flex items-center gap-2">
                <span class="material-symbols-outlined text-sm">arrow_back</span>
                My Communities
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-8">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
            <p class="text-text-muted-dark">Loading community...</p>
        </div>

        <!-- Community Content -->
        <div id="communityContent" class="hidden space-y-8">
            <!-- Community Header -->
            <div class="relative rounded-xl overflow-hidden glass">
                <div id="communityBanner" class="h-40 gradient-card flex items-end p-6">
                    <div class="flex items-center justify-between w-full">
                        <div class="flex-1 min-w-0">
                            <h1 id="communityName" class="text-3xl font-bold mb-1 truncate">Community Name</h1>
                            <p id="communityDescription" class="text-text-muted-dark text-sm line-clamp-2">Description</p>
                        </div>
                        <!-- Settings Dropdown -->
                        <div class="relative" id="settingsDropdown">
                            <button onclick="toggleSettings()" 
                                    class="p-3 glass hover:bg-primary hover:text-background-dark text-white rounded-lg transition-all duration-300 transform hover:scale-110">
                                <span class="material-symbols-outlined text-2xl">settings</span>
                            </button>
                            <div id="settingsMenu" class="hidden absolute right-0 mt-2 w-48 glass rounded-lg shadow-xl z-50 dropdown-menu">
                                <button onclick="leaveCommunity()" 
                                        class="w-full px-4 py-3 text-left text-white hover:bg-primary hover:text-background-dark transition-colors flex items-center gap-3 rounded-t-lg">
                                    <span class="material-symbols-outlined">logout</span>
                                    Leave Community
                                </button>
                                <button id="deleteMenuButton" onclick="showDeleteModal()" 
                                        class="w-full px-4 py-3 text-left text-red-400 hover:bg-red-600 hover:text-white transition-colors flex items-center gap-3 rounded-b-lg hidden">
                                    <span class="material-symbols-outlined">delete</span>
                                    Delete Community
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="glass p-4 hover:border-primary transition-all cursor-pointer transform hover:scale-105">
                    <p class="text-text-muted-dark text-sm">Members</p>
                    <p id="memberCount" class="text-2xl font-bold gradient-primary bg-clip-text text-transparent">0</p>
                </div>
                <div class="glass p-4 hover:border-primary transition-all cursor-pointer transform hover:scale-105">
                    <p class="text-text-muted-dark text-sm">Active Tasks</p>
                    <p id="activeTasksCount" class="text-2xl font-bold gradient-primary bg-clip-text text-transparent">0</p>
                </div>
                <div class="glass p-4 hover:border-primary transition-all cursor-pointer transform hover:scale-105">
                    <p class="text-text-muted-dark text-sm">Completed</p>
                    <p id="completedTasksCount" class="text-2xl font-bold gradient-primary bg-clip-text text-transparent">0</p>
                </div>
                <div id="prizePoolCard" class="hidden glass border-primary p-4 hover:scale-105 transition-all cursor-pointer">
                    <p class="text-text-muted-dark text-sm">Prize Pool</p>
                    <p id="prizePool" class="text-primary text-2xl font-bold">0 HLP</p>
                </div>
            </div>

            <!-- Members Section -->
            <div class="glass rounded-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold">Members</h2>
                    <span id="totalMembers" class="text-text-muted-dark text-sm">0 members</span>
                </div>
                <div id="membersContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                    <div class="text-center py-4 col-span-full text-text-muted-dark text-sm">Loading members...</div>
                </div>
            </div>

            <!-- Create Blockchain Task Section (Admin Only) -->
            <div id="createTaskSection" class="hidden glass rounded-lg p-6">
                <div class="flex items-center gap-3 mb-6">
                    <div class="size-10 rounded-full gradient-primary flex items-center justify-center">
                        <span class="material-symbols-outlined text-background-dark text-2xl">link</span>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold">Create Blockchain Task</h2>
                        <p class="text-text-muted-dark text-sm">Deploy task on-chain with smart contracts</p>
                    </div>
                </div>
                
                <div class="mb-4 p-3 bg-blue-500/10 border border-blue-500 rounded-lg">
                    <p class="text-blue-400 text-sm">
                        <strong>‚ÑπÔ∏è Admin Feature:</strong> This section is only visible to community admins. You can create tasks that will be stored on the Sepolia blockchain.
                    </p>
                </div>
                
                <div id="walletStatus" class="mb-4 p-3 bg-background-dark/50 rounded-lg border border-border-dark">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-text-muted-dark">Wallet Status:</span>
                        <button id="connectWalletBtn" onclick="connectWallet()" 
                                class="px-4 py-2 gradient-primary text-background-dark rounded-lg font-bold hover:opacity-90 transition-opacity">
                            Connect MetaMask
                        </button>
                        <span id="walletAddress" class="hidden text-sm text-primary font-mono"></span>
                    </div>
                </div>

                <form id="blockchainTaskForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Task Title</label>
                        <input type="text" id="taskTitle" required
                               class="w-full px-4 py-3 bg-background-dark border border-border-dark rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all"
                               placeholder="Enter task title">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Task Description</label>
                        <textarea id="taskDescription" required rows="4"
                                  class="w-full px-4 py-3 bg-background-dark border border-border-dark rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all resize-none"
                                  placeholder="Describe the task requirements"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Reward Amount (HLP)</label>
                        <input type="number" id="taskReward" required step="0.001" min="0"
                               class="w-full px-4 py-3 bg-background-dark border border-border-dark rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all"
                               placeholder="100">
                    </div>

                    <button type="submit" id="createTaskBtn"
                            class="w-full px-6 py-4 gradient-primary text-background-dark rounded-lg font-bold hover:opacity-90 transition-all transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">rocket_launch</span>
                        Deploy Task to Blockchain
                    </button>
                </form>

                <div id="transactionStatus" class="hidden mt-4 p-4 rounded-lg border">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-primary"></div>
                        <span class="font-medium" id="statusText">Processing transaction...</span>
                    </div>
                    <a id="txLink" target="_blank" class="text-sm text-primary hover:underline hidden"></a>
                </div>
            </div>

            <!-- Tasks Section -->
            <div class="glass rounded-lg p-6">
                <h2 class="text-xl font-bold mb-4">Community Tasks</h2>
                <div id="tasksContainer" class="space-y-3">
                    <div class="text-center py-4 text-text-muted-dark text-sm">Loading tasks...</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Leave Modal -->
    <div id="leaveModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-card-dark border-2 border-red-500/50 rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="flex items-center gap-4 mb-6">
                <div class="size-12 rounded-full bg-red-500/20 flex items-center justify-center">
                    <span class="material-symbols-outlined text-red-400 text-3xl">logout</span>
                </div>
                <h3 class="text-2xl font-bold">Leave Community?</h3>
            </div>
            <p class="text-text-muted-dark mb-8">
                Are you sure you want to leave this community? You'll lose access to all tasks and discussions.
            </p>
            <div class="flex gap-4">
                <button id="cancelLeaveBtn" class="flex-1 px-6 py-3 rounded-xl bg-card-dark border-2 border-border-dark font-bold hover:border-primary transition-colors">
                    Cancel
                </button>
                <button id="confirmLeaveBtn" class="flex-1 px-6 py-3 rounded-xl bg-red-500 text-white font-bold hover:bg-red-600 transition-colors">
                    Leave
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-card-dark border-2 border-red-600 rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="flex items-center gap-4 mb-6">
                <div class="size-12 rounded-full bg-red-600/20 flex items-center justify-center">
                    <span class="material-symbols-outlined text-red-500 text-3xl">delete_forever</span>
                </div>
                <h3 class="text-2xl font-bold">Delete Community?</h3>
            </div>
            <p class="text-text-muted-dark mb-4">
                ‚ö†Ô∏è This action is <span class="text-red-500 font-bold">PERMANENT</span> and cannot be undone!
            </p>
            <p class="text-text-muted-dark text-sm mb-6">
                All tasks, members, and data will be deleted. Type <strong class="text-cream">DELETE</strong> to confirm:
            </p>
            <input type="text" id="deleteConfirmInput" class="w-full bg-background-dark border-2 border-red-500 rounded-lg px-4 py-3 text-cream mb-6 outline-none focus:border-red-400" placeholder="Type DELETE">
            <div class="flex gap-4">
                <button id="cancelDeleteBtn" class="flex-1 px-6 py-3 rounded-xl bg-card-dark border-2 border-border-dark font-bold hover:border-primary transition-colors">
                    Cancel
                </button>
                <button id="confirmDeleteBtn" class="flex-1 px-6 py-3 rounded-xl bg-red-600 text-white font-bold hover:bg-red-700 transition-colors">
                    Delete Forever
                </button>
            </div>
        </div>
    </div>

    <!-- Blockchain Task Modal -->
    <div id="blockchainTaskModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="glass rounded-2xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-2xl font-bold" id="modalTaskTitle">Task Details</h3>
                    <p class="text-text-muted-dark text-sm" id="modalTaskId">Task #1</p>
                </div>
                <button onclick="closeBlockchainTaskModal()" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
                    <span class="material-symbols-outlined text-2xl">close</span>
                </button>
            </div>

            <div id="modalTaskContent" class="space-y-4">
                <!-- Content will be dynamically loaded -->
            </div>

            <div id="modalActions" class="mt-6 flex gap-3 flex-wrap">
                <!-- Action buttons will be dynamically loaded -->
            </div>
        </div>
    </div>

    <!-- Firebase & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, updateDoc, deleteDoc, 
            arrayRemove, increment, collection, query, where, getDocs 
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCBV3CuuYD_8w843LgPQqAICGnmvDtOt5k",
            authDomain: "taskmatch-openhack2025.firebaseapp.com",
            projectId: "taskmatch-openhack2025",
            storageBucket: "taskmatch-openhack2025.firebasestorage.app",
            messagingSenderId: "1071810532798",
            appId: "1:1071810532798:web:c8e7b6b25ec68c9df8cdda"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let communityId = null;
        let communityData = null;
        let isAdmin = false;
        let isMember = false;

        // Get community ID from URL
        const pathParts = window.location.pathname.split('/');
        communityId = pathParts[pathParts.length - 1];

        if (!communityId) {
            alert('Invalid community URL');
            window.location.href = '/my-communities';
        }

        // Auth check
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = '/login';
                return;
            }
            currentUser = user;
            await loadCommunity();
        });

        async function loadCommunity() {
            try {
                console.log('Loading community:', communityId);
                
                // Get community data
                const communityRef = doc(db, 'communities', communityId);
                const communitySnap = await getDoc(communityRef);

                if (!communitySnap.exists()) {
                    alert('Community not found');
                    window.location.href = '/my-communities';
                    return;
                }

                communityData = { id: communitySnap.id, ...communitySnap.data() };
                
                // Check user permissions
                isMember = communityData.members && communityData.members.includes(currentUser.uid);
                isAdmin = communityData.admins && communityData.admins.includes(currentUser.uid);

                console.log('Is member:', isMember, 'Is admin:', isAdmin);

                // Update UI
                document.getElementById('communityName').textContent = communityData.name || 'Unnamed Community';
                document.getElementById('communityDescription').textContent = communityData.description || 'No description';
                document.getElementById('memberCount').textContent = communityData.memberCount || 0;
                
                // Show prize pool if applicable
                if (communityData.type === 'prize-pool') {
                    document.getElementById('prizePoolCard').classList.remove('hidden');
                    document.getElementById('prizePool').textContent = `${communityData.prizePool || 0} HLP`;
                }

                // Show delete button in settings for admins
                if (isAdmin) {
                    console.log('User is admin - showing blockchain task section');
                    const deleteMenuBtn = document.getElementById('deleteMenuButton');
                    const taskSection = document.getElementById('createTaskSection');
                    
                    if (deleteMenuBtn) deleteMenuBtn.classList.remove('hidden');
                    if (taskSection) {
                        taskSection.classList.remove('hidden');
                        console.log('Blockchain task section should now be visible');
                        // Double-check visibility
                        setTimeout(() => {
                            const isVisible = !taskSection.classList.contains('hidden');
                            console.log('Task section visible after timeout:', isVisible);
                        }, 500);
                    } else {
                        console.error('createTaskSection element not found!');
                    }
                } else {
                    console.log('User is not admin - blockchain section hidden');
                }

                // Debug: Force show for testing (REMOVE THIS LATER)
                console.log('Admin status:', isAdmin);
                console.log('Community admins:', communityData.admins);
                console.log('Current user:', currentUser.uid);

                // Load members and tasks
                await loadMembers();
                await loadTasks();

                // Show content
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('communityContent').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading community:', error);
                alert('Error loading community: ' + error.message);
                window.location.href = '/my-communities';
            }
        }

        async function loadMembers() {
            const container = document.getElementById('membersContainer');
            const memberIds = communityData.members || [];
            
            document.getElementById('totalMembers').textContent = `${memberIds.length} member${memberIds.length !== 1 ? 's' : ''}`;

            if (memberIds.length === 0) {
                container.innerHTML = '<p class="text-text-muted-dark text-center py-4 col-span-full text-sm">No members yet</p>';
                return;
            }

            container.innerHTML = '';

            for (const memberId of memberIds) {
                try {
                    const userRef = doc(db, 'users', memberId);
                    const userSnap = await getDoc(userRef);

                    if (!userSnap.exists()) continue;

                    const userData = userSnap.data();
                    const isUserAdmin = communityData.admins && communityData.admins.includes(memberId);

                    const memberCard = document.createElement('div');
                    memberCard.className = 'glass hover:border-primary/50 hover:shadow-md hover:shadow-primary/10 transition-all transform hover:scale-105 p-3 rounded-lg';
                    
                    const initial = (userData.displayName || userData.email || 'U')[0].toUpperCase();
                    const displayName = userData.displayName || userData.email?.split('@')[0] || 'User';
                    const tasksCompleted = userData.tasksCompleted || 0;

                    memberCard.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="size-12 rounded-full gradient-primary flex items-center justify-center flex-shrink-0">
                                <span class="text-background-dark font-bold text-lg">${initial}</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2">
                                    <p class="text-cream font-semibold truncate">${displayName}</p>
                                    ${isUserAdmin ? '<span class="text-xs px-2 py-1 rounded-full gradient-primary text-background-dark font-bold">Admin</span>' : ''}
                                </div>
                                <p class="text-text-muted-dark text-xs flex items-center gap-1">
                                    <span class="material-symbols-outlined text-xs">task_alt</span>
                                    ${tasksCompleted} completed
                                </p>
                            </div>
                        </div>
                    `;

                    container.appendChild(memberCard);
                } catch (error) {
                    console.error('Error loading member:', memberId, error);
                }
            }
        }

        async function loadTasks() {
            const container = document.getElementById('tasksContainer');
            
            try {
                // Query Firebase tasks for this community
                const tasksRef = collection(db, 'tasks');
                const q = query(tasksRef, where('communityId', '==', communityId));
                const querySnapshot = await getDocs(q);

                // Fetch blockchain tasks
                let blockchainTasks = [];
                if (window.ethers && taskContract) {
                    try {
                        const taskCount = await taskContract.getTasksCount();
                        console.log('Total blockchain tasks:', taskCount.toString());
                        
                        for (let i = 1; i <= taskCount.toNumber(); i++) {
                            try {
                                const task = await taskContract.getTask(i);
                                // Only show non-canceled tasks (worker is not 0x0...dead which indicates canceled)
                                const canceledAddress = '0x000000000000000000000000000000000000dEaD';
                                if (task.worker.toLowerCase() !== canceledAddress.toLowerCase()) {
                                    blockchainTasks.push({ id: i, ...task, isBlockchain: true });
                                }
                            } catch (err) {
                                console.log(`Blockchain task ${i} not found or deleted`);
                            }
                        }
                    } catch (error) {
                        console.log('Could not load blockchain tasks:', error.message);
                    }
                }

                const totalTasks = querySnapshot.size + blockchainTasks.length;
                console.log(`Found ${querySnapshot.size} Firebase tasks + ${blockchainTasks.length} blockchain tasks`);

                if (totalTasks === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <span class="material-symbols-outlined text-4xl text-text-muted-dark mb-2">assignment</span>
                            <p class="text-text-muted-dark text-sm">No tasks yet</p>
                            ${isAdmin ? '<p class="text-primary text-xs mt-2">Create a blockchain task above to get started!</p>' : ''}
                        </div>
                    `;
                    document.getElementById('activeTasksCount').textContent = '0';
                    document.getElementById('completedTasksCount').textContent = '0';
                    return;
                }

                container.innerHTML = '';
                let activeTasks = 0;
                let completedTasks = 0;

                // Display Firebase tasks
                querySnapshot.forEach((taskDoc) => {
                    const task = taskDoc.data();
                    
                    if (task.status === 'completed') {
                        completedTasks++;
                    } else {
                        activeTasks++;
                    }

                    createTaskCard(taskDoc.id, task, false);
                });

                // Display blockchain tasks
                blockchainTasks.forEach((task) => {
                    if (task.completed) {
                        completedTasks++;
                    } else {
                        activeTasks++;
                    }
                    createTaskCard(task.id.toString(), task, true);
                });

                document.getElementById('activeTasksCount').textContent = activeTasks;
                document.getElementById('completedTasksCount').textContent = completedTasks;

            } catch (error) {
                console.error('Error loading tasks:', error);
                container.innerHTML = `
                    <div class="text-center py-4 text-red-400 text-sm">
                        Error loading tasks: ${error.message}
                    </div>
                `;
            }
        }

        function createTaskCard(taskId, task, isBlockchain) {
            const container = document.getElementById('tasksContainer');
            const taskCard = document.createElement('div');
            taskCard.className = 'glass hover:border-primary/80 hover:shadow-lg hover:shadow-primary/10 transition-all transform hover:scale-[1.02] cursor-pointer p-4 rounded-lg';
            
            if (isBlockchain) {
                taskCard.onclick = () => showBlockchainTaskModal(taskId, task);
            } else {
                taskCard.onclick = () => window.location.href = `/task/${taskId}`;
            }

            let statusColor, statusIcon, statusText;
            if (isBlockchain) {
                if (task.completed) {
                    statusColor = 'bg-green-500/20 text-green-400 border-green-500';
                    statusIcon = 'verified';
                    statusText = 'verified';
                } else if (task.worker !== ethers.constants.AddressZero) {
                    statusColor = 'bg-blue-500/20 text-blue-400 border-blue-500';
                    statusIcon = 'pending';
                    statusText = 'in progress';
                } else {
                    statusColor = 'bg-primary/20 text-primary border-primary';
                    statusIcon = 'work';
                    statusText = 'open';
                }
            } else {
                statusColor = task.status === 'completed' ? 'bg-green-500/20 text-green-400 border-green-500' : 
                             task.status === 'in-progress' ? 'bg-blue-500/20 text-blue-400 border-blue-500' : 
                             'bg-primary/20 text-primary border-primary';
                statusIcon = task.status === 'completed' ? 'check_circle' : 
                            task.status === 'in-progress' ? 'pending' : 
                            'radio_button_unchecked';
                statusText = task.status || 'open';
            }

            const rewardText = isBlockchain ? 
                `${ethers.utils.formatEther(task.reward)} HLP` : 
                `${task.reward || 0} HLP`;

            const blockchainBadge = isBlockchain ? 
                '<span class="text-xs px-2 py-1 rounded-full bg-blue-500/20 text-blue-400 border border-blue-500">‚õìÔ∏è On-Chain</span>' : 
                '';

            taskCard.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-3 mb-2 flex-wrap">
                            <span class="material-symbols-outlined ${statusColor.split(' ')[1]}">${statusIcon}</span>
                            <p class="text-cream font-bold truncate text-lg">${task.title || 'Untitled Task'}</p>
                            <span class="text-xs px-3 py-1 rounded-full ${statusColor} border font-semibold uppercase flex-shrink-0">${statusText}</span>
                            ${blockchainBadge}
                        </div>
                        <p class="text-text-muted-dark text-sm truncate ml-9">${task.description || 'No description'}</p>
                    </div>
                    <div class="flex items-center gap-4 flex-shrink-0 ml-4">
                        <div class="text-right bg-primary/10 px-4 py-2 rounded-lg border border-primary/30">
                            <p class="text-primary font-bold text-xl">${rewardText}</p>
                            <p class="text-text-muted-dark text-xs">Reward</p>
                        </div>
                        <span class="material-symbols-outlined text-primary text-3xl">chevron_right</span>
                    </div>
                </div>
            `;

            container.appendChild(taskCard);
        }

        // Show Blockchain Task Modal
        window.showBlockchainTaskModal = async function(taskId, task) {
            const modal = document.getElementById('blockchainTaskModal');
            const titleEl = document.getElementById('modalTaskTitle');
            const idEl = document.getElementById('modalTaskId');
            const contentEl = document.getElementById('modalTaskContent');
            const actionsEl = document.getElementById('modalActions');

            titleEl.textContent = task.title || 'Untitled Task';
            idEl.textContent = `Task #${taskId} ‚Ä¢ On-Chain`;

            // Get applicants
            let applicants = [];
            try {
                applicants = await taskContract.getTaskApplicants(taskId);
            } catch (err) {
                console.log('No applicants yet');
            }

            const isCreator = userAddress && task.creator.toLowerCase() === userAddress.toLowerCase();
            const isWorker = userAddress && task.worker.toLowerCase() === userAddress.toLowerCase();
            const hasApplied = userAddress && applicants.some(addr => addr.toLowerCase() === userAddress.toLowerCase());
            const isAssigned = task.worker !== ethers.constants.AddressZero;

            // Content
            let statusBadge = '';
            let workflowInfo = '';
            
            if (task.completed) {
                statusBadge = '<span class="px-3 py-1 rounded-full bg-green-500/20 text-green-400 border border-green-500 text-sm font-semibold">‚úì COMPLETED & VERIFIED</span>';
                workflowInfo = `
                    <div class="glass p-3 rounded-lg bg-green-500/10 border border-green-500">
                        <p class="text-green-400 text-sm">
                            <strong>‚úÖ Workflow Complete:</strong> Task has been completed by the worker and verified by the creator. Reward has been distributed!
                        </p>
                    </div>
                `;
            } else if (isAssigned) {
                statusBadge = '<span class="px-3 py-1 rounded-full bg-blue-500/20 text-blue-400 border border-blue-500 text-sm font-semibold">üîÑ IN PROGRESS</span>';
                workflowInfo = `
                    <div class="glass p-3 rounded-lg bg-blue-500/10 border border-blue-500">
                        <p class="text-blue-400 text-sm">
                            <strong>üìù Step 3:</strong> Worker is completing the task. Once done, they will submit for verification.
                        </p>
                    </div>
                `;
            } else if (applicants.length > 0) {
                statusBadge = '<span class="px-3 py-1 rounded-full bg-yellow-500/20 text-yellow-400 border border-yellow-500 text-sm font-semibold">‚è≥ PENDING APPROVAL</span>';
                workflowInfo = `
                    <div class="glass p-3 rounded-lg bg-yellow-500/10 border border-yellow-500">
                        <p class="text-yellow-400 text-sm">
                            <strong>üëÄ Step 2:</strong> Waiting for creator to review applications and assign a worker.
                        </p>
                    </div>
                `;
            } else {
                statusBadge = '<span class="px-3 py-1 rounded-full bg-primary/20 text-primary border border-primary text-sm font-semibold">üì¢ OPEN FOR APPLICATIONS</span>';
                workflowInfo = `
                    <div class="glass p-3 rounded-lg bg-primary/10 border border-primary">
                        <p class="text-primary text-sm">
                            <strong>üöÄ Step 1:</strong> Apply for this task to be considered by the creator.
                        </p>
                    </div>
                `;
            }

            contentEl.innerHTML = `
                <div class="flex items-center gap-2 flex-wrap">
                    ${statusBadge}
                    ${isCreator ? '<span class="px-3 py-1 rounded-full gradient-primary text-background-dark text-sm font-bold">üëë You Created This</span>' : ''}
                    ${isWorker ? '<span class="px-3 py-1 rounded-full bg-blue-600 text-white text-sm font-bold">üë∑ You Are Assigned</span>' : ''}
                    ${hasApplied && !isWorker ? '<span class="px-3 py-1 rounded-full bg-yellow-600 text-white text-sm font-bold">‚úã You Applied</span>' : ''}
                </div>

                ${workflowInfo}

                <div class="glass p-4 rounded-lg">
                    <h4 class="text-sm font-semibold text-text-muted-dark mb-2">Description</h4>
                    <p class="text-cream">${task.description}</p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="glass p-4 rounded-lg">
                        <h4 class="text-sm font-semibold text-text-muted-dark mb-1">Reward</h4>
                        <p class="text-primary font-bold text-2xl">${ethers.utils.formatEther(task.reward)} HLP</p>
                    </div>
                    <div class="glass p-4 rounded-lg">
                        <h4 class="text-sm font-semibold text-text-muted-dark mb-1">Applicants</h4>
                        <p class="text-cream font-bold text-2xl">${applicants.length}</p>
                    </div>
                </div>

                <div class="glass p-4 rounded-lg">
                    <h4 class="text-sm font-semibold text-text-muted-dark mb-2">Creator</h4>
                    <p class="text-cream font-mono text-sm break-all">${task.creator}</p>
                    ${isCreator ? '<p class="text-primary text-xs mt-1">This is you!</p>' : ''}
                </div>

                ${task.worker !== ethers.constants.AddressZero ? `
                    <div class="glass p-4 rounded-lg">
                        <h4 class="text-sm font-semibold text-text-muted-dark mb-2">Assigned Worker</h4>
                        <p class="text-cream font-mono text-sm break-all">${task.worker}</p>
                        ${isWorker ? '<p class="text-blue-400 text-xs mt-1">This is you!</p>' : ''}
                    </div>
                ` : ''}

                ${applicants.length > 0 ? `
                    <div class="glass p-4 rounded-lg">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-sm font-semibold text-text-muted-dark">Applications (${applicants.length})</h4>
                            ${isCreator && !isAssigned && !task.completed ? 
                                '<span class="text-xs text-yellow-400">‚ö†Ô∏è Review and assign a worker</span>' : ''}
                        </div>
                        <div class="space-y-2">
                            ${applicants.map(applicant => `
                                <div class="flex items-center justify-between bg-background-dark/50 p-3 rounded-lg">
                                    <div class="flex-1 min-w-0">
                                        <p class="text-cream font-mono text-sm break-all">${applicant}</p>
                                        ${applicant.toLowerCase() === userAddress?.toLowerCase() ? 
                                            '<span class="text-primary text-xs font-bold mt-1 block">‚úã This is you</span>' : ''}
                                    </div>
                                    ${isCreator && !isAssigned && !task.completed ? 
                                        `<button onclick="assignTaskToApplicant(${taskId}, '${applicant}')" 
                                            class="ml-3 px-4 py-2 gradient-primary text-background-dark rounded-lg font-bold hover:opacity-90 transition-opacity flex-shrink-0 flex items-center gap-2">
                                            <span class="material-symbols-outlined text-sm">check</span>
                                            Approve & Assign
                                        </button>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : `
                    <div class="text-center py-6 glass rounded-lg">
                        <span class="material-symbols-outlined text-4xl text-text-muted-dark mb-2">person_search</span>
                        <p class="text-text-muted-dark text-sm">No applications yet</p>
                        ${!isCreator ? '<p class="text-primary text-xs mt-1">Be the first to apply!</p>' : ''}
                    </div>
                `}
            `;

            // Actions
            actionsEl.innerHTML = '';
            
            // Step 1: Apply for task (if open and user hasn't applied)
            if (!task.completed && !isAssigned && !hasApplied && !isCreator && userAddress) {
                actionsEl.innerHTML += `
                    <button onclick="applyForBlockchainTask(${taskId})" 
                        class="flex-1 px-6 py-3 gradient-primary text-background-dark rounded-lg font-bold hover:opacity-90 transition-opacity flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">person_add</span>
                        Apply for Task
                    </button>
                `;
            }

            // Show waiting message if already applied
            if (hasApplied && !isAssigned && !isCreator) {
                actionsEl.innerHTML += `
                    <div class="flex-1 px-6 py-3 bg-yellow-500/20 border-2 border-yellow-500 text-yellow-400 rounded-lg font-bold text-center">
                        ‚è≥ Waiting for approval from creator
                    </div>
                `;
            }

            // Step 3: Submit for completion (worker marks as done)
            if (isWorker && !task.completed) {
                actionsEl.innerHTML += `
                    <button onclick="submitTaskCompletion(${taskId})" 
                        class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">task_alt</span>
                        Submit for Verification
                    </button>
                `;
            }

            // Step 4: Verify completion (creator verifies and distributes reward)
            if (isCreator && isAssigned && !task.completed) {
                actionsEl.innerHTML += `
                    <button onclick="verifyTaskCompletion(${taskId})" 
                        class="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition-colors flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">verified</span>
                        Verify & Distribute Reward
                    </button>
                `;
            }

            // Cancel task (creator only, before assignment)
            if (isCreator && !task.completed && !isAssigned) {
                actionsEl.innerHTML += `
                    <button onclick="cancelBlockchainTask(${taskId})" 
                        class="px-6 py-3 bg-red-600/20 border-2 border-red-600 text-red-400 rounded-lg font-bold hover:bg-red-600/30 transition-colors flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">cancel</span>
                        Cancel Task
                    </button>
                `;
            }

            // Connect wallet prompt
            if (!userAddress) {
                actionsEl.innerHTML += `
                    <button onclick="connectWallet()" 
                        class="flex-1 px-6 py-3 gradient-primary text-background-dark rounded-lg font-bold hover:opacity-90 transition-opacity flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">account_balance_wallet</span>
                        Connect Wallet to Interact
                    </button>
                `;
            }

            // Show completion message
            if (task.completed) {
                actionsEl.innerHTML = `
                    <div class="flex-1 px-6 py-3 bg-green-500/20 border-2 border-green-500 text-green-400 rounded-lg font-bold text-center flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">check_circle</span>
                        Task Completed & Reward Distributed
                    </div>
                `;
            }

            modal.classList.remove('hidden');
        };

        window.closeBlockchainTaskModal = function() {
            document.getElementById('blockchainTaskModal').classList.add('hidden');
        };

        window.applyForBlockchainTask = async function(taskId) {
            if (!taskContract) {
                alert('Please connect wallet first');
                return;
            }

            try {
                const tx = await taskContract.applyForTask(taskId);
                alert('Application submitted! Waiting for confirmation...');
                await tx.wait();
                alert('‚úÖ Successfully applied for task!');
                closeBlockchainTaskModal();
                await loadTasks();
            } catch (error) {
                console.error('Error applying:', error);
                alert('Error: ' + (error.message || 'Transaction failed'));
            }
        };

        window.assignTaskToApplicant = async function(taskId, workerAddress) {
            if (!taskContract) {
                alert('Please connect wallet first');
                return;
            }

            if (!confirm(`Assign this task to ${workerAddress.substring(0, 10)}...?\n\nThis approves their application and assigns them to work on the task.`)) {
                return;
            }

            try {
                const tx = await taskContract.assignTask(taskId, workerAddress);
                alert('‚úÖ Assignment submitted! Waiting for confirmation...');
                await tx.wait();
                alert('üéâ Task assigned successfully!\n\nThe worker can now start working on the task.');
                closeBlockchainTaskModal();
                await loadTasks();
            } catch (error) {
                console.error('Error assigning:', error);
                alert('‚ùå Error: ' + (error.message || 'Transaction failed'));
            }
        };

        window.submitTaskCompletion = async function(taskId) {
            if (!taskContract) {
                alert('Please connect wallet first');
                return;
            }

            if (!confirm('Submit this task for verification?\n\nThe creator will review and verify your work before distributing the reward.')) {
                return;
            }

            try {
                const tx = await taskContract.completeTask(taskId);
                alert('‚úÖ Submission sent! Waiting for confirmation...');
                await tx.wait();
                alert('üéâ Task submitted for verification!\n\nWait for the creator to verify and approve your work.');
                closeBlockchainTaskModal();
                await loadTasks();
            } catch (error) {
                console.error('Error submitting:', error);
                alert('‚ùå Error: ' + (error.message || 'Transaction failed'));
            }
        };

        window.verifyTaskCompletion = async function(taskId) {
            if (!taskContract) {
                alert('Please connect wallet first');
                return;
            }

            if (!confirm('Verify this task as complete?\n\nThis will:\n‚úÖ Mark the task as completed\nüí∞ Transfer the HLP reward to the worker\n\nMake sure the work is satisfactory before confirming!')) {
                return;
            }

            try {
                const tx = await taskContract.completeTask(taskId);
                alert('‚úÖ Verification submitted! Processing reward distribution...');
                await tx.wait();
                alert('üéâ Task verified and reward distributed!\n\nThe worker has received their HLP tokens.');
                closeBlockchainTaskModal();
                await loadTasks();
            } catch (error) {
                console.error('Error verifying:', error);
                alert('‚ùå Error: ' + (error.message || 'Transaction failed'));
            }
        };

        window.cancelBlockchainTask = async function(taskId) {
            if (!taskContract) {
                alert('Please connect wallet first');
                return;
            }

            if (!confirm('Cancel this task?\n\n‚ö†Ô∏è This will:\n‚ùå Remove the task from the list\n‚ùå Reject all applications\n\nThis action cannot be undone!')) {
                return;
            }

            try {
                const tx = await taskContract.cancelTask(taskId);
                alert('üóëÔ∏è Cancellation submitted! Removing task...');
                await tx.wait();
                alert('‚úÖ Task cancelled and removed from the list.');
                closeBlockchainTaskModal();
                await loadTasks();
            } catch (error) {
                console.error('Error cancelling:', error);
                alert('‚ùå Error: ' + (error.message || 'Transaction failed'));
            }
        };

        // Leave Community (called from settings dropdown)
        window.leaveCommunity = function() {
            document.getElementById('leaveModal').classList.remove('hidden');
            document.getElementById('settingsMenu').classList.add('hidden');
        };

        // Show Delete Modal (called from settings dropdown)
        window.showDeleteModal = function() {
            document.getElementById('deleteModal').classList.remove('hidden');
            document.getElementById('settingsMenu').classList.add('hidden');
        };

        document.getElementById('cancelLeaveBtn').addEventListener('click', () => {
            document.getElementById('leaveModal').classList.add('hidden');
        });

        document.getElementById('confirmLeaveBtn').addEventListener('click', async () => {
            try {
                const communityRef = doc(db, 'communities', communityId);
                const userRef = doc(db, 'users', currentUser.uid);

                await updateDoc(communityRef, {
                    members: arrayRemove(currentUser.uid),
                    memberCount: increment(-1)
                });

                await updateDoc(userRef, {
                    joinedCommunities: arrayRemove(communityId)
                });

                alert('You have left the community');
                window.location.href = '/my-communities';
            } catch (error) {
                console.error('Error leaving community:', error);
                alert('Error: ' + error.message);
            }
        });

        document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
            document.getElementById('deleteModal').classList.add('hidden');
            document.getElementById('deleteConfirmInput').value = '';
        });

        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            const confirmText = document.getElementById('deleteConfirmInput').value;
            
            if (confirmText !== 'DELETE') {
                alert('Please type DELETE to confirm');
                return;
            }

            try {
                await deleteDoc(doc(db, 'communities', communityId));
                alert('Community deleted successfully');
                window.location.href = '/my-communities';
            } catch (error) {
                console.error('Error deleting community:', error);
                alert('Error: ' + error.message);
            }
        });

        // Close modals on outside click
        document.getElementById('leaveModal').addEventListener('click', (e) => {
            if (e.target.id === 'leaveModal') {
                document.getElementById('leaveModal').classList.add('hidden');
            }
        });

        document.getElementById('deleteModal').addEventListener('click', (e) => {
            if (e.target.id === 'deleteModal') {
                document.getElementById('deleteModal').classList.add('hidden');
                document.getElementById('deleteConfirmInput').value = '';
            }
        });

        // Settings Dropdown Toggle
        window.toggleSettings = function() {
            const menu = document.getElementById('settingsMenu');
            menu.classList.toggle('hidden');
        };

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('settingsDropdown');
            if (dropdown && !dropdown.contains(e.target)) {
                document.getElementById('settingsMenu').classList.add('hidden');
            }
        });

        // Show/hide delete button in settings based on admin status
        function updateSettingsMenu() {
            const deleteMenuBtn = document.getElementById('deleteMenuButton');
            if (isAdmin && deleteMenuBtn) {
                deleteMenuBtn.classList.remove('hidden');
            }
        }

        // Call after admin check
        setTimeout(updateSettingsMenu, 1000);
    </script>

    <!-- Blockchain Integration -->
    <script>
        // Contract addresses and ABIs from deployment.json
        const TASK_CONTRACT_ADDRESS = "0x77bD0b58d5786587614a00688Ddc9db7A592449E";
        const REWARD_CONTRACT_ADDRESS = "0xFD1b4a56B7Dc1321a674265F68400fE09E7101A5";
        const ACHIEVEMENT_BADGE_ADDRESS = "0x101546970B89156d33EC9cDC576DAbfc1BE3C13D";
        
        const TASK_CONTRACT_ABI = [{"inputs":[{"internalType":"address","name":"_rewardToken","type":"address"},{"internalType":"address","name":"_achievementBadge","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"taskId","type":"uint256"},{"indexed":false,"internalType":"address","name":"applicant","type":"address"}],"name":"TaskApplied","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"taskId","type":"uint256"},{"indexed":false,"internalType":"address","name":"worker","type":"address"}],"name":"TaskAssigned","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"taskId","type":"uint256"}],"name":"TaskCancelled","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"taskId","type":"uint256"},{"indexed":false,"internalType":"address","name":"worker","type":"address"},{"indexed":false,"internalType":"uint256","name":"reward","type":"uint256"}],"name":"TaskCompleted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"taskId","type":"uint256"},{"indexed":false,"internalType":"string","name":"title","type":"string"},{"indexed":false,"internalType":"string","name":"description","type":"string"},{"indexed":false,"internalType":"uint256","name":"reward","type":"uint256"},{"indexed":false,"internalType":"address","name":"creator","type":"address"}],"name":"TaskCreated","type":"event"},{"inputs":[],"name":"achievementBadge","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_taskId","type":"uint256"}],"name":"applyForTask","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_taskId","type":"uint256"},{"internalType":"address","name":"_worker","type":"address"}],"name":"assignTask","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_taskId","type":"uint256"}],"name":"cancelTask","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_taskId","type":"uint256"}],"name":"completeTask","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_title","type":"string"},{"internalType":"string","name":"_description","type":"string"},{"internalType":"uint256","name":"_reward","type":"uint256"}],"name":"createTask","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_taskId","type":"uint256"}],"name":"getTask","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"title","type":"string"},{"internalType":"string","name":"description","type":"string"},{"internalType":"uint256","name":"reward","type":"uint256"},{"internalType":"bool","name":"completed","type":"bool"},{"internalType":"address","name":"worker","type":"address"},{"internalType":"address","name":"creator","type":"address"}],"internalType":"struct TaskContract.TaskStruct","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_taskId","type":"uint256"}],"name":"getTaskApplicants","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTasksCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getUserTasks","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasApplied","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"rewardToken","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_achievementBadge","type":"address"}],"name":"setAchievementBadge","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_rewardToken","type":"address"}],"name":"setRewardToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"taskApplicants","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"taskCounter","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"tasks","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"title","type":"string"},{"internalType":"string","name":"description","type":"string"},{"internalType":"uint256","name":"reward","type":"uint256"},{"internalType":"bool","name":"completed","type":"bool"},{"internalType":"address","name":"worker","type":"address"},{"internalType":"address","name":"creator","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"userTasks","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}];

        let provider = null;
        let signer = null;
        let taskContract = null;
        let userAddress = null;

        // Connect Wallet
        window.connectWallet = async function() {
            try {
                if (!window.ethereum) {
                    alert('Please install MetaMask to use blockchain features!');
                    window.open('https://metamask.io/download/', '_blank');
                    return;
                }

                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];

                // Initialize provider and signer
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                taskContract = new ethers.Contract(TASK_CONTRACT_ADDRESS, TASK_CONTRACT_ABI, signer);

                // Update UI
                document.getElementById('connectWalletBtn').classList.add('hidden');
                const walletAddressEl = document.getElementById('walletAddress');
                walletAddressEl.textContent = `Connected: ${userAddress.substring(0, 6)}...${userAddress.substring(38)}`;
                walletAddressEl.classList.remove('hidden');

                console.log('Wallet connected:', userAddress);

                // Check network (Sepolia = chainId 11155111)
                const network = await provider.getNetwork();
                if (network.chainId !== 11155111) {
                    alert('Please switch to Sepolia Test Network in MetaMask');
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0xaa36a7' }], // Sepolia chainId in hex
                        });
                    } catch (switchError) {
                        console.error('Error switching network:', switchError);
                    }
                }
            } catch (error) {
                console.error('Error connecting wallet:', error);
                alert('Failed to connect wallet: ' + error.message);
            }
        };

        // Create Blockchain Task
        document.addEventListener('DOMContentLoaded', () => {
            const blockchainForm = document.getElementById('blockchainTaskForm');
            if (!blockchainForm) return; // Form only exists for admins

            blockchainForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                if (!taskContract) {
                    alert('Please connect your wallet first!');
                    return;
                }

                const title = document.getElementById('taskTitle').value.trim();
                const description = document.getElementById('taskDescription').value.trim();
                const rewardEth = parseFloat(document.getElementById('taskReward').value);

                if (!title || !description || rewardEth <= 0) {
                    alert('Please fill in all fields with valid values');
                    return;
                }

                const createTaskBtn = document.getElementById('createTaskBtn');
                const statusDiv = document.getElementById('transactionStatus');
                const statusText = document.getElementById('statusText');
                const txLink = document.getElementById('txLink');

                try {
                    // Disable button
                    createTaskBtn.disabled = true;
                    createTaskBtn.innerHTML = '<span class="animate-spin material-symbols-outlined">progress_activity</span> Deploying...';

                    // Show status
                    statusDiv.classList.remove('hidden');
                    statusDiv.className = 'mt-4 p-4 rounded-lg border border-primary bg-primary/10';
                    statusText.textContent = 'Waiting for transaction approval...';
                    txLink.classList.add('hidden');

                    // Convert ETH to Wei (smallest unit)
                    const rewardWei = ethers.utils.parseEther(rewardEth.toString());

                    console.log('Creating task:', { title, description, rewardWei: rewardWei.toString() });

                    // Call smart contract
                    const tx = await taskContract.createTask(title, description, rewardWei);
                    
                    statusText.textContent = 'Transaction submitted! Waiting for confirmation...';
                    txLink.textContent = `View on Sepolia Etherscan: ${tx.hash}`;
                    txLink.href = `https://sepolia.etherscan.io/tx/${tx.hash}`;
                    txLink.classList.remove('hidden');

                    // Wait for confirmation
                    const receipt = await tx.wait();
                    console.log('Transaction confirmed:', receipt);

                    // Extract task ID from event
                    const taskCreatedEvent = receipt.events?.find(e => e.event === 'TaskCreated');
                    const taskId = taskCreatedEvent?.args?.taskId?.toString();

                    // Success
                    statusDiv.className = 'mt-4 p-4 rounded-lg border border-green-500 bg-green-500/10';
                    statusText.innerHTML = `‚úÖ Task deployed successfully! <span class="text-primary">Task ID: #${taskId || receipt.transactionHash.substring(0, 8)}</span>`;

                    // Reset form
                    blockchainForm.reset();

                    // Reload tasks after 2 seconds
                    setTimeout(() => {
                        location.reload();
                    }, 2000);

                } catch (error) {
                    console.error('Error creating blockchain task:', error);
                    
                    statusDiv.className = 'mt-4 p-4 rounded-lg border border-red-500 bg-red-500/10';
                    statusText.textContent = `‚ùå Error: ${error.message || 'Transaction failed'}`;
                    
                    // Re-enable button
                    createTaskBtn.disabled = false;
                    createTaskBtn.innerHTML = '<span class="material-symbols-outlined">rocket_launch</span> Deploy Task to Blockchain';
                }
            });
        });

        // Auto-connect wallet if previously connected
        if (window.ethereum) {
            window.ethereum.request({ method: 'eth_accounts' }).then(accounts => {
                if (accounts.length > 0) {
                    window.connectWallet();
                }
            });
        }
    </script>
</body>
</html>
