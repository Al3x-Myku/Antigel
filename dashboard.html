<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SideQuests</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <style>
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }
        
        /* Dropdown animation */
        #profileDropdown {
            animation: slideDown 0.2s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Modal animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.2s ease-out;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#DDD92A",
                        "primary-light": "#EAE151",
                        "primary-pale": "#EEEFA8",
                        "secondary": "#DDD92A",
                        "background-dark": "#2D2A32",
                        "card-dark": "#3A3740",
                        "border-dark": "#4A4750",
                        "text-muted-dark": "#B0ADB5",
                        "cream": "#FAFDF6",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "1rem",
                        "lg": "1.5rem",
                        "xl": "2rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
</head>
<body class="font-display bg-background-dark text-cream">
    <div class="relative flex h-auto min-h-screen w-full flex-col overflow-x-hidden">
        <div class="layout-container flex h-full grow flex-col">
            <div class="flex flex-1 justify-center py-5">
                <div class="layout-content-container flex flex-col w-full max-w-7xl px-4 sm:px-6 lg:px-8">
                    <!-- TopNavBar -->
                    <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-border-dark px-4 sm:px-6 py-4">
                        <div class="flex items-center gap-4">
                            <div class="size-6 text-primary">
                                <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M24 45.8096C19.6865 45.8096 15.4698 44.5305 11.8832 42.134C8.29667 39.7376 5.50128 36.3314 3.85056 32.3462C2.19985 28.361 1.76794 23.9758 2.60947 19.7452C3.451 15.5145 5.52816 11.6284 8.57829 8.5783C11.6284 5.52817 15.5145 3.45101 19.7452 2.60948C23.9758 1.76795 28.361 2.19986 32.3462 3.85057C36.3314 5.50129 39.7376 8.29668 42.134 11.8833C44.5305 15.4698 45.8096 19.6865 45.8096 24L24 24L24 45.8096Z" fill="currentColor"></path>
                                </svg>
                            </div>
                            <h2 class="text-cream text-xl font-bold leading-tight tracking-[-0.015em]">SideQuests</h2>
                        </div>
                        <div class="flex flex-1 justify-end items-center gap-3">
                            <!-- Notifications Button -->
                            <div class="relative">
                                <button id="notificationsBtn" class="relative flex items-center justify-center size-10 rounded-full bg-card-dark border border-border-dark hover:border-primary transition-colors" title="Notifications">
                                    <span class="material-symbols-outlined text-cream">notifications</span>
                                    <span id="notificationBadge" class="hidden absolute -top-1 -right-1 size-5 rounded-full bg-primary text-background-dark text-xs font-bold flex items-center justify-center">0</span>
                                </button>
                                
                                <!-- Notifications Dropdown -->
                                <div id="notificationsDropdown" class="hidden absolute right-0 mt-2 w-96 max-h-96 overflow-y-auto rounded-lg bg-card-dark border border-border-dark shadow-xl z-50">
                                    <div class="p-4 border-b border-border-dark flex items-center justify-between">
                                        <div class="flex items-center gap-2">
                                            <span class="material-symbols-outlined text-primary">notifications_active</span>
                                            <span class="text-cream font-bold" id="notificationCount">0</span>
                                        </div>
                                        <button id="markAllRead" class="text-xs text-text-muted-dark hover:text-primary transition-colors">Clear all</button>
                                    </div>
                                    <div id="notificationsList" class="p-2">
                                        <p class="text-center text-text-muted-dark py-4 text-sm">No notifications</p>
                                    </div>
                                </div>
                            </div>

                            <button id="myCommunitiesBtn" class="hidden sm:flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-card-dark border border-border-dark text-cream text-sm font-bold leading-normal tracking-[0.015em] hover:border-primary transition-colors">
                                <span class="truncate">My Communities</span>
                            </button>
                            <button id="joinCommunityBtn" class="hidden sm:flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-primary text-background-dark text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary-light transition-colors">
                                <span class="truncate">Join Community</span>
                            </button>
                            <button id="createCommunityBtn" class="hidden sm:flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-card-dark border-2 border-primary text-primary text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/10 transition-colors">
                                <span class="truncate">Create Community</span>
                            </button>
                            
                            <!-- Profile Dropdown -->
                            <div class="relative">
                                <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 border-2 border-border-dark hover:border-primary transition-colors cursor-pointer" id="userAvatar" style='background-image: url("https://via.placeholder.com/40");'></div>
                                
                                <!-- Dropdown Menu (hidden by default) -->
                                <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-48 rounded-lg bg-card-dark border border-border-dark shadow-xl z-50">
                                    <div class="py-2">
                                        <button id="settingsBtn" class="w-full px-4 py-2 text-left text-cream hover:bg-primary/10 transition-colors flex items-center gap-3" disabled title="Coming soon">
                                            <span class="material-symbols-outlined text-lg">settings</span>
                                            <span>Settings</span>
                                        </button>
                                        <button id="logoutBtn" class="w-full px-4 py-2 text-left text-cream hover:bg-primary/10 transition-colors flex items-center gap-3">
                                            <span class="material-symbols-outlined text-lg">logout</span>
                                            <span>Logout</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main class="flex flex-col gap-8 mt-8">
                        <!-- Page Heading -->
                        <div class="flex flex-wrap justify-between gap-3 px-4 sm:px-6">
                            <div class="flex min-w-72 flex-col gap-3">
                                <p class="text-cream text-4xl font-bold leading-tight tracking-[-0.033em]" id="welcomeText">Welcome back!</p>
                                <p class="text-text-muted-dark text-base font-normal leading-normal">Here's your quest overview for today.</p>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 px-4 sm:px-6">
                            <div class="flex flex-col gap-2 rounded-lg bg-card-dark p-6 border border-border-dark">
                                <p class="text-text-muted-dark text-base font-medium leading-normal">Quests Completed</p>
                                <p class="text-cream tracking-light text-3xl font-bold leading-tight" id="tasksCompleted">0</p>
                                <p class="text-primary text-base font-medium leading-normal">Total tasks done</p>
                            </div>
                            <div class="flex flex-col gap-2 rounded-lg bg-card-dark p-6 border border-border-dark">
                                <p class="text-text-muted-dark text-base font-medium leading-normal">Your Rating</p>
                                <div class="text-cream tracking-light font-bold leading-tight flex items-baseline gap-2" id="ratingDisplay">
                                    <span class="text-2xl text-text-muted-dark">Loading...</span>
                                </div>
                                <div class="flex items-center gap-1">
                                    <span class="material-symbols-outlined text-primary text-xl">star</span>
                                    <span class="material-symbols-outlined text-primary text-xl">star</span>
                                    <span class="material-symbols-outlined text-primary text-xl">star</span>
                                    <span class="material-symbols-outlined text-primary text-xl">star</span>
                                    <span class="material-symbols-outlined text-primary text-xl">star</span>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 px-4 sm:px-6">
                            <!-- Left Column: Active Quests -->
                            <div class="lg:col-span-2 flex flex-col gap-4">
                                <!-- Section Header -->
                                <h2 class="text-cream text-[22px] font-bold leading-tight tracking-[-0.015em]">My Active Quests</h2>
                                
                                <!-- Tabs -->
                                <div>
                                    <div class="flex border-b border-border-dark gap-8">
                                        <a id="inProgressTab" class="tab-link flex flex-col items-center justify-center border-b-[3px] border-b-primary text-cream pb-[13px] pt-2 cursor-pointer" data-tab="in-progress">
                                            <p class="text-cream text-sm font-bold leading-normal tracking-[0.015em]" id="inProgressCount">In Progress (0)</p>
                                        </a>
                                        <a id="postedByMeTab" class="tab-link flex flex-col items-center justify-center border-b-[3px] border-b-transparent text-text-muted-dark pb-[13px] pt-2 hover:text-cream transition-colors cursor-pointer" data-tab="posted">
                                            <p class="text-sm font-bold leading-normal tracking-[0.015em]" id="postedByMeCount">Posted by Me (0)</p>
                                        </a>
                                    </div>
                                </div>

                                <!-- Quest Cards -->
                                <div class="flex flex-col gap-4" id="activeTasksContainer">
                                    <!-- Loading state -->
                                    <div class="text-center py-12">
                                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
                                        <p class="text-text-muted-dark">Loading your active quests...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Right Column: Recently Viewed & Trending Communities -->
                            <div class="lg:col-span-1 flex flex-col gap-8">
                                <!-- Recently Viewed Communities -->
                                <div class="flex flex-col gap-4">
                                    <h2 class="text-cream text-[22px] font-bold leading-tight tracking-[-0.015em]">Recently Viewed Communities</h2>
                                    <div class="flex flex-col gap-3 rounded-lg bg-card-dark p-6 border border-border-dark min-h-[150px]" id="recentCommunitiesContainer">
                                        <div class="flex items-center justify-center h-full">
                                            <p class="text-sm text-text-muted-dark">No communities viewed yet</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Recently Viewed Tasks -->
                                <div class="flex flex-col gap-4">
                                    <h2 class="text-cream text-[22px] font-bold leading-tight tracking-[-0.015em]">Recently Viewed Quests</h2>
                                    <div class="flex flex-col gap-3 rounded-lg bg-card-dark p-6 border border-border-dark min-h-[150px]" id="recentTasksContainer">
                                        <div class="flex items-center justify-center h-full">
                                            <p class="text-sm text-text-muted-dark">No quests viewed yet</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- AI Recommended Tasks -->
                                <div class="flex flex-col gap-4">
                                    <div class="flex items-center justify-between">
                                        <h2 class="text-cream text-[22px] font-bold leading-tight tracking-[-0.015em] flex items-center gap-2">
                                            <span class="material-symbols-outlined text-primary">auto_awesome</span>
                                            AI Recommended
                                        </h2>
                                        <button id="refreshAIRecommendations" class="text-xs text-primary hover:text-primary-light transition-colors flex items-center gap-1">
                                            <span class="material-symbols-outlined text-sm">refresh</span>
                                            Refresh
                                        </button>
                                    </div>
                                    <div class="flex flex-col gap-3 rounded-lg bg-gradient-to-br from-card-dark to-primary/5 p-6 border-2 border-primary/30 min-h-[200px]" id="aiRecommendedTasksContainer">
                                        <div class="flex items-center justify-center h-full">
                                            <div class="text-center">
                                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-3"></div>
                                                <p class="text-sm text-text-muted-dark">Analyzing your profile...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            </div>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-card-dark border-2 border-border-dark rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl animate-fadeIn">
            <div class="flex items-center gap-4 mb-6">
                <div class="flex items-center justify-center size-12 rounded-full bg-primary/20">
                    <span class="material-symbols-outlined text-primary text-3xl">logout</span>
                </div>
                <div>
                    <h3 class="text-cream text-2xl font-bold">Confirm Logout</h3>
                </div>
            </div>
            <p class="text-text-muted-dark text-base mb-8">Are you sure you want to logout? You'll need to sign in again to access your dashboard.</p>
            <div class="flex gap-4">
                <button id="cancelLogoutBtn" class="flex-1 px-6 py-3 rounded-xl bg-card-dark border-2 border-border-dark text-cream font-bold hover:border-primary/50 transition-colors">
                    Cancel
                </button>
                <button id="confirmLogoutBtn" class="flex-1 px-6 py-3 rounded-xl bg-primary text-background-dark font-bold hover:bg-primary-light transition-colors">
                    Logout
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules directly
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { 
            getAuth,
            onAuthStateChanged,
            signOut,
            setPersistence,
            browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { 
            getFirestore,
            doc,
            getDoc,
            collection,
            query,
            where,
            getDocs,
            orderBy,
            limit
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCBV3CuuYD_8w843LgPQqAICGnmvDtOt5k",
            authDomain: "taskmatch-openhack2025.firebaseapp.com",
            projectId: "taskmatch-openhack2025",
            storageBucket: "taskmatch-openhack2025.firebasestorage.app",
            messagingSenderId: "1071810532798",
            appId: "1:1071810532798:web:c8e7b6b25ec68c9df8cdda",
            measurementId: "G-Y0XPDPZFY8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Enable session persistence
        setPersistence(auth, browserLocalPersistence);

        console.log('✅ Firebase initialized');
        console.log('✅ Auth:', auth ? 'OK' : 'FAILED');
        console.log('✅ Firestore:', db ? 'OK' : 'FAILED');

        // Logout function
        function logout() {
            signOut(auth).then(() => {
                console.log('✅ User logged out');
                window.location.href = '/login';
            }).catch((error) => {
                console.error('❌ Logout error:', error);
            });
        }

        // Check authentication and load dashboard
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                console.log('❌ No user logged in, redirecting to login');
                window.location.href = '/login';
                return;
            }

            console.log('✅ User authenticated:', user.uid);

            // Update UI with user info
            const welcomeText = document.getElementById('welcomeText');
            const displayName = user.displayName || user.email?.split('@')[0] || 'there';
            welcomeText.textContent = `Welcome back, ${displayName}!`;
            
            const userAvatar = document.getElementById('userAvatar');
            if (user.photoURL) {
                userAvatar.style.backgroundImage = `url("${user.photoURL}")`;
            }
            
            // Profile dropdown toggle
            const profileDropdown = document.getElementById('profileDropdown');
            userAvatar.addEventListener('click', (e) => {
                e.stopPropagation();
                profileDropdown.classList.toggle('hidden');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!profileDropdown.contains(e.target) && e.target !== userAvatar) {
                    profileDropdown.classList.add('hidden');
                }
            });

            // Create Community button
            const createCommunityBtn = document.getElementById('createCommunityBtn');
            createCommunityBtn.addEventListener('click', () => {
                window.location.href = '/create-community';
            });

            // My Communities button
            const myCommunitiesBtn = document.getElementById('myCommunitiesBtn');
            myCommunitiesBtn.addEventListener('click', () => {
                window.location.href = '/my-communities';
            });

            // Join Community button
            const joinCommunityBtn = document.getElementById('joinCommunityBtn');
            joinCommunityBtn.addEventListener('click', () => {
                window.location.href = '/communities';
            });

            // Logout modal elements
            const logoutModal = document.getElementById('logoutModal');
            const cancelLogoutBtn = document.getElementById('cancelLogoutBtn');
            const confirmLogoutBtn = document.getElementById('confirmLogoutBtn');

            // Show logout modal
            const logoutBtn = document.getElementById('logoutBtn');
            logoutBtn.addEventListener('click', () => {
                profileDropdown.classList.add('hidden');
                logoutModal.classList.remove('hidden');
            });

            // Cancel logout
            cancelLogoutBtn.addEventListener('click', () => {
                logoutModal.classList.add('hidden');
            });

            // Confirm logout
            confirmLogoutBtn.addEventListener('click', () => {
                logoutModal.classList.add('hidden');
                logout();
            });

            // Close modal when clicking outside
            logoutModal.addEventListener('click', (e) => {
                if (e.target === logoutModal) {
                    logoutModal.classList.add('hidden');
                }
            });

            // Load user data from Firestore
            try {
                const userDocRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userDocRef);
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    console.log('✅ User data loaded:', userData);

                    // Update tasks completed
                    const tasksCompleted = userData.tasksCompleted || 0;
                    document.getElementById('tasksCompleted').textContent = tasksCompleted;
                    
                    // Update rating
                    const rating = userData.rating || 0;
                    const ratingCount = userData.ratingCount || 0;
                    const ratingDisplay = document.getElementById('ratingDisplay');
                    if (ratingCount > 0) {
                        const avgRating = (rating / ratingCount).toFixed(1);
                        ratingDisplay.innerHTML = `
                            <span class="text-3xl">${avgRating}</span>
                            <span class="text-sm text-text-muted-dark">/ 5.0 (${ratingCount} reviews)</span>
                        `;
                    } else {
                        ratingDisplay.innerHTML = `
                            <span class="text-2xl text-text-muted-dark">No ratings yet</span>
                        `;
                    }

                    // Initialize tabs
                    setupTabs(user.uid);

                    // Load active tasks (tasks user is working on) - default tab
                    await loadTasks(user.uid, 'in-progress');

                    // Load recent history
                    await loadRecentCommunities();
                    await loadRecentTasks();

                    // Load notifications for admin
                    await loadNotifications(user.uid);

                    // Load AI recommendations
                    await loadAIRecommendations(user.uid);

                } else {
                    console.warn('⚠️ User document does not exist in Firestore');
                    // Set default values
                    document.getElementById('tasksCompleted').textContent = '0';
                    document.getElementById('ratingDisplay').innerHTML = `<span class="text-2xl text-text-muted-dark">No ratings yet</span>`;
                }
            } catch (error) {
                console.error('❌ Error loading user data:', error);
            }

            console.log('✅ Dashboard loaded successfully');
        });

        // Setup tab switching
        function setupTabs(userId) {
            const inProgressTab = document.getElementById('inProgressTab');
            const postedByMeTab = document.getElementById('postedByMeTab');
            
            inProgressTab.addEventListener('click', (e) => {
                e.preventDefault();
                // Update tab styles
                inProgressTab.classList.remove('border-b-transparent', 'text-text-muted-dark');
                inProgressTab.classList.add('border-b-primary', 'text-cream');
                inProgressTab.querySelector('p').classList.add('text-cream');
                
                postedByMeTab.classList.remove('border-b-primary', 'text-cream');
                postedByMeTab.classList.add('border-b-transparent', 'text-text-muted-dark');
                postedByMeTab.querySelector('p').classList.remove('text-cream');
                
                // Load in-progress tasks
                loadTasks(userId, 'in-progress');
            });
            
            postedByMeTab.addEventListener('click', (e) => {
                e.preventDefault();
                // Update tab styles
                postedByMeTab.classList.remove('border-b-transparent', 'text-text-muted-dark');
                postedByMeTab.classList.add('border-b-primary', 'text-cream');
                postedByMeTab.querySelector('p').classList.add('text-cream');
                
                inProgressTab.classList.remove('border-b-primary', 'text-cream');
                inProgressTab.classList.add('border-b-transparent', 'text-text-muted-dark');
                inProgressTab.querySelector('p').classList.remove('text-cream');
                
                // Load posted tasks
                loadTasks(userId, 'posted');
            });
        }

        // Load tasks based on tab (in-progress or posted)
        async function loadTasks(userId, tabType) {
            try {
                const tasksRef = collection(db, 'tasks');
                let q;
                
                if (tabType === 'in-progress') {
                    // Tasks assigned to the user that are in progress
                    // Simplified query - just filter by assignedTo first
                    q = query(
                        tasksRef,
                        where('assignedTo', '==', userId),
                        limit(50)
                    );
                } else if (tabType === 'posted') {
                    // Tasks created by the user
                    q = query(
                        tasksRef,
                        where('createdBy', '==', userId),
                        orderBy('createdAt', 'desc'),
                        limit(10)
                    );
                }

                const querySnapshot = await getDocs(q);
                
                // Filter in-progress tasks in memory (temporary workaround)
                let tasks = [];
                if (tabType === 'in-progress') {
                    querySnapshot.forEach((doc) => {
                        const task = doc.data();
                        if (task.status === 'in-progress' || !task.status) {
                            tasks.push({ id: doc.id, data: task });
                        }
                    });
                    // Sort by createdAt
                    tasks.sort((a, b) => {
                        const timeA = a.data.createdAt?.seconds || 0;
                        const timeB = b.data.createdAt?.seconds || 0;
                        return timeB - timeA;
                    });
                    tasks = tasks.slice(0, 10); // Limit to 10
                } else {
                    querySnapshot.forEach((doc) => {
                        tasks.push({ id: doc.id, data: doc.data() });
                    });
                }
                
                const tasksContainer = document.getElementById('activeTasksContainer');
                const inProgressCount = document.getElementById('inProgressCount');
                const postedByMeCount = document.getElementById('postedByMeCount');
                
                // Update the appropriate tab count
                const taskCount = tasks.length;
                if (tabType === 'in-progress') {
                    inProgressCount.textContent = `In Progress (${taskCount})`;
                } else {
                    postedByMeCount.textContent = `Posted by Me (${taskCount})`;
                }
                
                if (tasks.length === 0) {
                    const emptyMessage = tabType === 'in-progress' 
                        ? 'No active quests yet. Start exploring!' 
                        : 'You haven\'t posted any quests yet.';
                    
                    tasksContainer.innerHTML = `
                        <div class="text-center py-12">
                            <span class="material-symbols-outlined text-6xl text-text-muted-dark mb-4">assignment</span>
                            <p class="text-text-muted-dark">${emptyMessage}</p>
                        </div>
                    `;
                    return;
                }

                tasksContainer.innerHTML = '';
                tasks.forEach(({ id, data }) => {
                    const taskCard = createTaskCard(data, id, tabType);
                    tasksContainer.appendChild(taskCard);
                });

                console.log('✅ Loaded', tasks.length, tabType, 'tasks');
            } catch (error) {
                console.error('❌ Error loading tasks:', error);
                const tasksContainer = document.getElementById('activeTasksContainer');
                
                // Check if error is because collection doesn't exist or no permission
                // Show friendly "no tasks" message instead of error
                const emptyMessage = tabType === 'in-progress' 
                    ? 'No active quests yet. Start exploring!' 
                    : 'You haven\'t posted any quests yet.';
                
                tasksContainer.innerHTML = `
                    <div class="text-center py-12">
                        <span class="material-symbols-outlined text-6xl text-text-muted-dark mb-4">assignment</span>
                        <p class="text-text-muted-dark">${emptyMessage}</p>
                    </div>
                `;
            }
        }

        // Create task card element
        function createTaskCard(task, taskId, tabType) {
            const card = document.createElement('div');
            card.className = 'flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 rounded-lg bg-card-dark p-4 border border-border-dark hover:border-primary/50 transition-colors cursor-pointer';
            card.onclick = () => window.location.href = `/task/${taskId}`;

            // Different display based on tab type
            let statusBadge = '';
            if (tabType === 'posted') {
                const statusColors = {
                    'open': 'bg-primary/20 text-primary',
                    'in-progress': 'bg-blue-500/20 text-blue-400',
                    'completed': 'bg-green-500/20 text-green-400',
                    'cancelled': 'bg-red-500/20 text-red-400'
                };
                const statusText = task.status || 'open';
                const colorClass = statusColors[statusText] || statusColors['open'];
                statusBadge = `<span class="text-xs px-2 py-1 rounded-full ${colorClass} font-semibold">${statusText.toUpperCase()}</span>`;
            }

            card.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-md size-12" 
                         style='background-image: url("${task.imageUrl || 'https://via.placeholder.com/48?text=Quest'}");'></div>
                    <div>
                        <div class="flex items-center gap-2">
                            <p class="text-cream font-bold">${task.title || 'Untitled Quest'}</p>
                            ${statusBadge}
                        </div>
                        <p class="text-sm text-text-muted-dark">for ${task.communityName || 'Unknown Community'}</p>
                    </div>
                </div>
                <div class="flex items-center gap-6">
                    <div class="text-right">
                        <p class="font-bold text-primary">${task.reward || '0'} HLP</p>
                        <p class="text-sm text-text-muted-dark">${tabType === 'posted' ? 'Created: ' : 'Due: '}${task.deadline ? new Date(task.deadline).toLocaleDateString() : 'No deadline'}</p>
                    </div>
                    <span class="material-symbols-outlined text-text-muted-dark">chevron_right</span>
                </div>
            `;

            return card;
        }

        // Load notifications (join requests & invitations)
        async function loadNotifications(userId) {
            try {
                const notificationsList = document.getElementById('notificationsList');
                const notificationBadge = document.getElementById('notificationBadge');
                
                // Get communities where user is an admin
                const communitiesQuery = query(
                    collection(db, 'communities'),
                    where('admins', 'array-contains', userId)
                );
                const communitiesSnapshot = await getDocs(communitiesQuery);
                const adminCommunityIds = communitiesSnapshot.docs.map(doc => doc.id);

                if (adminCommunityIds.length === 0) {
                    return; // User is not an admin of any community
                }

                // Get join requests for admin communities
                const joinRequestsQuery = query(
                    collection(db, 'joinRequests'),
                    where('communityId', 'in', adminCommunityIds),
                    where('status', '==', 'pending'),
                    orderBy('createdAt', 'desc'),
                    limit(20)
                );
                const joinRequestsSnapshot = await getDocs(joinRequestsQuery);

                // Get invitations sent by user
                const invitationsQuery = query(
                    collection(db, 'invitations'),
                    where('invitedBy', '==', userId),
                    where('status', '==', 'pending'),
                    orderBy('createdAt', 'desc'),
                    limit(20)
                );
                const invitationsSnapshot = await getDocs(invitationsQuery);

                const totalNotifications = joinRequestsSnapshot.size + invitationsSnapshot.size;

                if (totalNotifications === 0) {
                    notificationsList.innerHTML = '<p class="text-center text-text-muted-dark py-4 text-sm">No notifications</p>';
                    notificationBadge.classList.add('hidden');
                    return;
                }

                // Show badge with count
                notificationBadge.textContent = totalNotifications;
                notificationBadge.classList.remove('hidden');
                
                // Update header count
                document.getElementById('notificationCount').textContent = totalNotifications;

                notificationsList.innerHTML = '';

                // Add join requests
                for (const requestDoc of joinRequestsSnapshot.docs) {
                    const request = requestDoc.data();
                    const userDoc = await getDoc(doc(db, 'users', request.userId));
                    const userName = userDoc.exists() ? userDoc.data().name : 'Unknown User';

                    const notifDiv = document.createElement('div');
                    notifDiv.className = 'p-3 border-b border-border-dark hover:bg-background-dark/50 transition-colors group';
                    notifDiv.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="flex items-center justify-center size-10 rounded-full bg-primary/20 group-hover:bg-primary/30 transition-colors">
                                <span class="material-symbols-outlined text-primary">person_add</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-cream text-sm font-medium truncate">${userName}</p>
                                <p class="text-text-muted-dark text-xs truncate">${request.communityName}</p>
                            </div>
                            <div class="flex gap-2">
                                <button class="approve-request-btn flex items-center justify-center size-8 rounded-full bg-primary hover:bg-primary-light text-background-dark transition-colors" data-request-id="${requestDoc.id}" data-user-id="${request.userId}" data-community-id="${request.communityId}" title="Approve">
                                    <span class="material-symbols-outlined text-base">check</span>
                                </button>
                                <button class="reject-request-btn flex items-center justify-center size-8 rounded-full bg-red-500/20 hover:bg-red-500/30 text-red-400 transition-colors" data-request-id="${requestDoc.id}" title="Reject">
                                    <span class="material-symbols-outlined text-base">close</span>
                                </button>
                            </div>
                        </div>
                    `;
                    notificationsList.appendChild(notifDiv);
                }

                // Add invitations status
                invitationsSnapshot.forEach(invDoc => {
                    const invitation = invDoc.data();
                    const notifDiv = document.createElement('div');
                    notifDiv.className = 'p-3 border-b border-border-dark hover:bg-background-dark/50 transition-colors group';
                    notifDiv.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="flex items-center justify-center size-10 rounded-full bg-blue-500/20 group-hover:bg-blue-500/30 transition-colors">
                                <span class="material-symbols-outlined text-blue-400">mail</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-cream text-sm font-medium truncate">${invitation.email}</p>
                                <p class="text-text-muted-dark text-xs truncate">${invitation.communityName}</p>
                            </div>
                            <div class="flex items-center justify-center size-8 rounded-full bg-yellow-500/20">
                                <span class="material-symbols-outlined text-yellow-400 text-base">schedule</span>
                            </div>
                        </div>
                    `;
                    notificationsList.appendChild(notifDiv);
                });

                // Add event listeners for approve/reject buttons
                document.querySelectorAll('.approve-request-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const requestId = btn.dataset.requestId;
                        const userId = btn.dataset.userId;
                        const communityId = btn.dataset.communityId;
                        await handleJoinRequest(requestId, userId, communityId, true);
                    });
                });

                document.querySelectorAll('.reject-request-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const requestId = btn.dataset.requestId;
                        await handleJoinRequest(requestId, null, null, false);
                    });
                });

            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        // Handle join request approval/rejection
        async function handleJoinRequest(requestId, userId, communityId, approve) {
            try {
                const requestRef = doc(db, 'joinRequests', requestId);

                if (approve) {
                    // Add user to community members
                    const communityRef = doc(db, 'communities', communityId);
                    await updateDoc(communityRef, {
                        members: arrayUnion(userId),
                        memberCount: increment(1),
                        updatedAt: serverTimestamp()
                    });

                    // Add community to user's joined communities
                    const userRef = doc(db, 'users', userId);
                    await updateDoc(userRef, {
                        joinedCommunities: arrayUnion(communityId),
                        updatedAt: serverTimestamp()
                    });

                    // Update request status
                    await updateDoc(requestRef, {
                        status: 'approved',
                        approvedAt: serverTimestamp()
                    });

                    alert('Join request approved!');
                } else {
                    // Update request status to rejected
                    await updateDoc(requestRef, {
                        status: 'rejected',
                        rejectedAt: serverTimestamp()
                    });

                    alert('Join request rejected');
                }

                // Reload notifications
                await loadNotifications(currentUser.uid);

            } catch (error) {
                console.error('Error handling join request:', error);
                alert('Error processing request');
            }
        }

        // Toggle notifications dropdown
        document.getElementById('notificationsBtn').addEventListener('click', () => {
            const dropdown = document.getElementById('notificationsDropdown');
            dropdown.classList.toggle('hidden');
        });

        // Clear all notifications
        document.getElementById('markAllRead')?.addEventListener('click', () => {
            const notificationsList = document.getElementById('notificationsList');
            notificationsList.innerHTML = '<p class="text-center text-text-muted-dark py-4 text-sm">No notifications</p>';
            document.getElementById('notificationBadge').classList.add('hidden');
            document.getElementById('notificationCount').textContent = '0';
        });

        // Close notifications when clicking outside
        document.addEventListener('click', (e) => {
            const notificationsBtn = document.getElementById('notificationsBtn');
            const notificationsDropdown = document.getElementById('notificationsDropdown');
            
            if (!notificationsBtn.contains(e.target) && !notificationsDropdown.contains(e.target)) {
                notificationsDropdown.classList.add('hidden');
            }
        });

        // ===== HISTORY TRACKING =====
        
        // Save to history in localStorage
        function saveToHistory(type, item) {
            const historyKey = `${type}History`;
            let history = JSON.parse(localStorage.getItem(historyKey) || '[]');
            
            // Remove if already exists
            history = history.filter(h => h.id !== item.id);
            
            // Add to beginning
            history.unshift({
                ...item,
                viewedAt: new Date().toISOString()
            });
            
            // Keep only last 10 items
            history = history.slice(0, 10);
            
            localStorage.setItem(historyKey, JSON.stringify(history));
        }

        // Get history from localStorage
        function getHistory(type) {
            const historyKey = `${type}History`;
            return JSON.parse(localStorage.getItem(historyKey) || '[]');
        }

        // Track community visit (call this when user visits a community page)
        window.trackCommunityVisit = function(communityId, communityName, communityDescription) {
            saveToHistory('community', {
                id: communityId,
                name: communityName,
                description: communityDescription
            });
        };

        // Track task visit (call this when user visits a task page)
        window.trackTaskVisit = function(taskId, taskTitle, taskDescription, taskReward) {
            saveToHistory('task', {
                id: taskId,
                title: taskTitle,
                description: taskDescription,
                reward: taskReward
            });
        };

        // Load recent communities
        async function loadRecentCommunities() {
            const container = document.getElementById('recentCommunitiesContainer');
            const history = getHistory('community');
            
            if (history.length === 0) {
                container.innerHTML = `
                    <div class="flex items-center justify-center h-full py-8">
                        <div class="text-center">
                            <span class="material-symbols-outlined text-4xl text-text-muted-dark mb-2">communities</span>
                            <p class="text-sm text-text-muted-dark">No communities viewed yet</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            history.slice(0, 5).forEach(community => {
                const communityCard = document.createElement('a');
                communityCard.href = `/community/${community.id}`;
                communityCard.className = 'flex items-start gap-3 p-3 rounded-lg hover:bg-background-dark transition-colors cursor-pointer border border-transparent hover:border-primary/30';
                
                const timeAgo = getTimeAgo(new Date(community.viewedAt));
                
                communityCard.innerHTML = `
                    <div class="size-10 rounded-full bg-primary/20 flex items-center justify-center flex-shrink-0">
                        <span class="material-symbols-outlined text-primary">groups</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-cream font-semibold text-sm truncate">${community.name}</p>
                        <p class="text-text-muted-dark text-xs truncate">${community.description || 'Community'}</p>
                        <p class="text-text-muted-dark text-xs mt-1">${timeAgo}</p>
                    </div>
                `;
                
                container.appendChild(communityCard);
            });
        }

        // Load recent tasks
        async function loadRecentTasks() {
            const container = document.getElementById('recentTasksContainer');
            const history = getHistory('task');
            
            if (history.length === 0) {
                container.innerHTML = `
                    <div class="flex items-center justify-center h-full py-8">
                        <div class="text-center">
                            <span class="material-symbols-outlined text-4xl text-text-muted-dark mb-2">assignment</span>
                            <p class="text-sm text-text-muted-dark">No quests viewed yet</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            history.slice(0, 5).forEach(task => {
                const taskCard = document.createElement('a');
                taskCard.href = `/task/${task.id}`;
                taskCard.className = 'flex items-start gap-3 p-3 rounded-lg hover:bg-background-dark transition-colors cursor-pointer border border-transparent hover:border-primary/30';
                
                const timeAgo = getTimeAgo(new Date(task.viewedAt));
                
                taskCard.innerHTML = `
                    <div class="size-10 rounded-lg bg-primary/20 flex items-center justify-center flex-shrink-0">
                        <span class="material-symbols-outlined text-primary">task</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-cream font-semibold text-sm truncate">${task.title}</p>
                        <p class="text-text-muted-dark text-xs truncate">${task.description || 'Task'}</p>
                        <div class="flex items-center justify-between mt-1">
                            <span class="text-primary text-xs font-bold">${task.reward || 0} HLP</span>
                            <span class="text-text-muted-dark text-xs">${timeAgo}</span>
                        </div>
                    </div>
                `;
                
                container.appendChild(taskCard);
            });
        }

        // Helper function to get "time ago" string
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
            return date.toLocaleDateString();
        }

        // Load AI recommendations
        async function loadAIRecommendations(userId) {
            const container = document.getElementById('aiRecommendedTasksContainer');
            
            try {
                // Get user data for personalization
                const userDocRef = doc(db, 'users', userId);
                const userDoc = await getDoc(userDocRef);
                const userData = userDoc.data() || {};
                
                // Get user's skills and interests
                const userSkills = userData.skills || [];
                const userInterests = userData.interests || [];
                
                // Query tasks (we'll filter them based on user profile)
                const tasksRef = collection(db, 'tasks');
                const q = query(
                    tasksRef,
                    where('status', '==', 'open'),
                    limit(20)
                );
                
                const querySnapshot = await getDocs(q);
                let recommendedTasks = [];
                
                querySnapshot.forEach((doc) => {
                    const task = doc.data();
                    // Simple scoring: match skills or interests
                    let score = 0;
                    if (userSkills.some(skill => task.title?.toLowerCase().includes(skill.toLowerCase()))) {
                        score += 2;
                    }
                    if (userInterests.some(interest => task.title?.toLowerCase().includes(interest.toLowerCase()))) {
                        score += 1;
                    }
                    
                    recommendedTasks.push({ id: doc.id, data: task, score });
                });
                
                // Sort by score and take top 3
                recommendedTasks.sort((a, b) => b.score - a.score);
                recommendedTasks = recommendedTasks.slice(0, 3);
                
                if (recommendedTasks.length === 0) {
                    // Fallback: show random tasks
                    const allTasks = [];
                    querySnapshot.forEach((doc) => {
                        allTasks.push({ id: doc.id, data: doc.data() });
                    });
                    recommendedTasks = allTasks.slice(0, 3);
                }
                
                if (recommendedTasks.length === 0) {
                    container.innerHTML = `
                        <div class="flex items-center justify-center h-full">
                            <div class="text-center">
                                <span class="material-symbols-outlined text-4xl text-primary mb-2">auto_awesome</span>
                                <p class="text-sm text-text-muted-dark">No recommendations yet</p>
                                <p class="text-xs text-text-muted-dark mt-1">Complete more tasks to get personalized suggestions!</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                recommendedTasks.forEach(({ id, data, score }) => {
                    const taskCard = document.createElement('a');
                    taskCard.href = `/task/${id}`;
                    taskCard.className = 'flex flex-col gap-2 p-4 rounded-lg bg-background-dark/50 hover:bg-background-dark border border-primary/20 hover:border-primary transition-all cursor-pointer';
                    
                    taskCard.innerHTML = `
                        <div class="flex items-start justify-between gap-2">
                            <p class="text-cream font-bold text-sm line-clamp-2">${data.title || 'Untitled Task'}</p>
                            ${score > 0 ? '<span class="text-xs bg-primary/20 text-primary px-2 py-1 rounded-full font-bold flex-shrink-0">Match!</span>' : ''}
                        </div>
                        <p class="text-text-muted-dark text-xs line-clamp-2">${data.description || 'No description'}</p>
                        <div class="flex items-center justify-between mt-1">
                            <span class="text-primary font-bold text-sm">${data.reward || 0} HLP</span>
                            <span class="text-xs text-text-muted-dark">AI suggested</span>
                        </div>
                    `;
                    
                    container.appendChild(taskCard);
                });
                
            } catch (error) {
                console.error('Error loading AI recommendations:', error);
                container.innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center">
                            <span class="material-symbols-outlined text-4xl text-text-muted-dark mb-2">error</span>
                            <p class="text-sm text-text-muted-dark">Could not load recommendations</p>
                        </div>
                    </div>
                `;
            }
        }

        // Refresh AI recommendations button
        document.getElementById('refreshAIRecommendations')?.addEventListener('click', async () => {
            const currentUser = auth.currentUser;
            if (currentUser) {
                document.getElementById('aiRecommendedTasksContainer').innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-3"></div>
                            <p class="text-sm text-text-muted-dark">Refreshing...</p>
                        </div>
                    </div>
                `;
                await loadAIRecommendations(currentUser.uid);
            }
        });

    </script>
</body>
</html>