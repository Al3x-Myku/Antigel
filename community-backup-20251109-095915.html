<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community - SideQuests</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#DDD92A",
                        "primary-light": "#EAE151",
                        "background-dark": "#2D2A32",
                        "card-dark": "#3A3740",
                        "border-dark": "#4A4750",
                        "text-muted-dark": "#B0ADB5",
                        "cream": "#FAFDF6",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"]
                    },
                },
            },
        }
    </script>
</head>
<body class="font-display bg-background-dark text-cream min-h-screen">
    <!-- Header -->
    <header class="border-b border-border-dark px-6 py-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="size-6 text-primary">
                    <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                        <path d="M24 45.8096C19.6865 45.8096 15.4698 44.5305 11.8832 42.134C8.29667 39.7376 5.50128 36.3314 3.85056 32.3462C2.19985 28.361 1.76794 23.9758 2.60947 19.7452C3.451 15.5145 5.52816 11.6284 8.57829 8.5783C11.6284 5.52817 15.5145 3.45101 19.7452 2.60948C23.9758 1.76795 28.361 2.19986 32.3462 3.85057C36.3314 5.50129 39.7376 8.29668 42.134 11.8833C44.5305 15.4698 45.8096 19.6865 45.8096 24L24 24L24 45.8096Z" fill="currentColor"></path>
                    </svg>
                </div>
                <h2 class="text-xl font-bold">SideQuests</h2>
            </div>
            <a href="/my-communities" class="text-sm hover:text-primary transition-colors flex items-center gap-2">
                <span class="material-symbols-outlined text-sm">arrow_back</span>
                My Communities
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-8">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
            <p class="text-text-muted-dark">Loading community...</p>
        </div>

        <!-- Community Content -->
        <div id="communityContent" class="hidden space-y-8">
            <!-- Community Header -->
            <div class="relative rounded-xl overflow-hidden">
                <div id="communityBanner" class="h-40 bg-center bg-cover" style="background-image: url('https://via.placeholder.com/1200x160?text=Community+Banner')"></div>
                <div class="absolute inset-0 bg-gradient-to-t from-background-dark to-transparent"></div>
                <div class="absolute bottom-0 left-0 right-0 p-6">
                    <div class="flex items-end justify-between gap-4">
                        <div class="flex-1 min-w-0">
                            <h1 id="communityName" class="text-3xl font-bold mb-1 truncate">Community Name</h1>
                            <p id="communityDescription" class="text-text-muted-dark text-sm line-clamp-2">Description</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <!-- Leave Button -->
                            <button id="leaveBtn" class="hidden bg-red-500/20 hover:bg-red-500/30 border border-red-500 text-red-400 px-4 py-2 rounded-lg font-bold transition-all flex items-center gap-2">
                                <span class="material-symbols-outlined text-sm">logout</span>
                                <span class="hidden sm:inline">Leave</span>
                            </button>
                            <!-- Delete Button (Admin) -->
                            <button id="deleteBtn" class="hidden bg-red-600/20 hover:bg-red-600/30 border-2 border-red-600 text-red-500 px-4 py-2 rounded-lg font-bold transition-all flex items-center gap-2">
                                <span class="material-symbols-outlined text-sm">delete</span>
                                <span class="hidden sm:inline">Delete</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-card-dark border border-border-dark rounded-lg p-4">
                    <p class="text-text-muted-dark text-sm">Members</p>
                    <p id="memberCount" class="text-2xl font-bold">0</p>
                </div>
                <div class="bg-card-dark border border-border-dark rounded-lg p-4">
                    <p class="text-text-muted-dark text-sm">Active Tasks</p>
                    <p id="activeTasksCount" class="text-2xl font-bold">0</p>
                </div>
                <div class="bg-card-dark border border-border-dark rounded-lg p-4">
                    <p class="text-text-muted-dark text-sm">Completed</p>
                    <p id="completedTasksCount" class="text-2xl font-bold">0</p>
                </div>
                <div id="prizePoolCard" class="hidden bg-card-dark border border-primary rounded-lg p-4">
                    <p class="text-text-muted-dark text-sm">Prize Pool</p>
                    <p id="prizePool" class="text-primary text-2xl font-bold">0 HLP</p>
                </div>
            </div>

            <!-- Members Section -->
            <div class="bg-card-dark border border-border-dark rounded-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold">Members</h2>
                    <span id="totalMembers" class="text-text-muted-dark text-sm">0 members</span>
                </div>
                <div id="membersContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                    <div class="text-center py-4 col-span-full text-text-muted-dark text-sm">Loading members...</div>
                </div>
            </div>

            <!-- Tasks Section -->
            <div class="bg-card-dark border border-border-dark rounded-lg p-6">
                <h2 class="text-xl font-bold mb-4">Community Tasks</h2>
                <div id="tasksContainer" class="space-y-3">
                    <div class="text-center py-4 text-text-muted-dark text-sm">Loading tasks...</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Leave Modal -->
    <div id="leaveModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-card-dark border-2 border-red-500/50 rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="flex items-center gap-4 mb-6">
                <div class="size-12 rounded-full bg-red-500/20 flex items-center justify-center">
                    <span class="material-symbols-outlined text-red-400 text-3xl">logout</span>
                </div>
                <h3 class="text-2xl font-bold">Leave Community?</h3>
            </div>
            <p class="text-text-muted-dark mb-8">
                Are you sure you want to leave this community? You'll lose access to all tasks and discussions.
            </p>
            <div class="flex gap-4">
                <button id="cancelLeaveBtn" class="flex-1 px-6 py-3 rounded-xl bg-card-dark border-2 border-border-dark font-bold hover:border-primary transition-colors">
                    Cancel
                </button>
                <button id="confirmLeaveBtn" class="flex-1 px-6 py-3 rounded-xl bg-red-500 text-white font-bold hover:bg-red-600 transition-colors">
                    Leave
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-card-dark border-2 border-red-600 rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="flex items-center gap-4 mb-6">
                <div class="size-12 rounded-full bg-red-600/20 flex items-center justify-center">
                    <span class="material-symbols-outlined text-red-500 text-3xl">delete_forever</span>
                </div>
                <h3 class="text-2xl font-bold">Delete Community?</h3>
            </div>
            <p class="text-text-muted-dark mb-4">
                ⚠️ This action is <span class="text-red-500 font-bold">PERMANENT</span> and cannot be undone!
            </p>
            <p class="text-text-muted-dark text-sm mb-6">
                All tasks, members, and data will be deleted. Type <strong class="text-cream">DELETE</strong> to confirm:
            </p>
            <input type="text" id="deleteConfirmInput" class="w-full bg-background-dark border-2 border-red-500 rounded-lg px-4 py-3 text-cream mb-6 outline-none focus:border-red-400" placeholder="Type DELETE">
            <div class="flex gap-4">
                <button id="cancelDeleteBtn" class="flex-1 px-6 py-3 rounded-xl bg-card-dark border-2 border-border-dark font-bold hover:border-primary transition-colors">
                    Cancel
                </button>
                <button id="confirmDeleteBtn" class="flex-1 px-6 py-3 rounded-xl bg-red-600 text-white font-bold hover:bg-red-700 transition-colors">
                    Delete Forever
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, updateDoc, deleteDoc, 
            arrayRemove, increment, collection, query, where, getDocs 
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCBV3CuuYD_8w843LgPQqAICGnmvDtOt5k",
            authDomain: "taskmatch-openhack2025.firebaseapp.com",
            projectId: "taskmatch-openhack2025",
            storageBucket: "taskmatch-openhack2025.firebasestorage.app",
            messagingSenderId: "1071810532798",
            appId: "1:1071810532798:web:c8e7b6b25ec68c9df8cdda"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let communityId = null;
        let communityData = null;
        let isAdmin = false;
        let isMember = false;

        // Get community ID from URL
        const pathParts = window.location.pathname.split('/');
        communityId = pathParts[pathParts.length - 1];

        if (!communityId) {
            alert('Invalid community URL');
            window.location.href = '/my-communities';
        }

        // Auth check
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = '/login';
                return;
            }
            currentUser = user;
            await loadCommunity();
        });

        async function loadCommunity() {
            try {
                console.log('Loading community:', communityId);
                
                // Get community data
                const communityRef = doc(db, 'communities', communityId);
                const communitySnap = await getDoc(communityRef);

                if (!communitySnap.exists()) {
                    alert('Community not found');
                    window.location.href = '/my-communities';
                    return;
                }

                communityData = { id: communitySnap.id, ...communitySnap.data() };
                
                // Check user permissions
                isMember = communityData.members && communityData.members.includes(currentUser.uid);
                isAdmin = communityData.admins && communityData.admins.includes(currentUser.uid);

                console.log('Is member:', isMember, 'Is admin:', isAdmin);

                // Update UI
                document.getElementById('communityName').textContent = communityData.name || 'Unnamed Community';
                document.getElementById('communityDescription').textContent = communityData.description || 'No description';
                document.getElementById('memberCount').textContent = communityData.memberCount || 0;
                
                // Show prize pool if applicable
                if (communityData.type === 'prize-pool') {
                    document.getElementById('prizePoolCard').classList.remove('hidden');
                    document.getElementById('prizePool').textContent = `${communityData.prizePool || 0} HLP`;
                }

                // Show leave button for members
                if (isMember) {
                    document.getElementById('leaveBtn').classList.remove('hidden');
                }

                // Show delete button for admins
                if (isAdmin) {
                    document.getElementById('deleteBtn').classList.remove('hidden');
                }

                // Load members and tasks
                await loadMembers();
                await loadTasks();

                // Show content
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('communityContent').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading community:', error);
                alert('Error loading community: ' + error.message);
                window.location.href = '/my-communities';
            }
        }

        async function loadMembers() {
            const container = document.getElementById('membersContainer');
            const memberIds = communityData.members || [];
            
            document.getElementById('totalMembers').textContent = `${memberIds.length} member${memberIds.length !== 1 ? 's' : ''}`;

            if (memberIds.length === 0) {
                container.innerHTML = '<p class="text-text-muted-dark text-center py-4 col-span-full text-sm">No members yet</p>';
                return;
            }

            container.innerHTML = '';

            for (const memberId of memberIds) {
                try {
                    const userRef = doc(db, 'users', memberId);
                    const userSnap = await getDoc(userRef);

                    if (!userSnap.exists()) continue;

                    const userData = userSnap.data();
                    const isUserAdmin = communityData.admins && communityData.admins.includes(memberId);

                    const memberCard = document.createElement('div');
                    memberCard.className = 'flex items-center gap-3 p-3 rounded-lg bg-background-dark border border-border-dark hover:border-primary/30 transition-colors';
                    
                    const initial = (userData.displayName || userData.email || 'U')[0].toUpperCase();
                    const displayName = userData.displayName || userData.email?.split('@')[0] || 'User';
                    const tasksCompleted = userData.tasksCompleted || 0;

                    memberCard.innerHTML = `
                        <div class="size-10 rounded-full bg-primary/20 flex items-center justify-center flex-shrink-0">
                            <span class="text-primary font-bold">${initial}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-cream font-semibold truncate text-sm">${displayName}</p>
                            <p class="text-text-muted-dark text-xs">${tasksCompleted} task${tasksCompleted !== 1 ? 's' : ''} completed</p>
                        </div>
                        ${isUserAdmin ? '<span class="text-xs px-2 py-1 rounded-full bg-primary/20 text-primary font-semibold">Admin</span>' : ''}
                    `;

                    container.appendChild(memberCard);
                } catch (error) {
                    console.error('Error loading member:', memberId, error);
                }
            }
        }

        async function loadTasks() {
            const container = document.getElementById('tasksContainer');
            
            try {
                // Query all tasks for this community
                const tasksRef = collection(db, 'tasks');
                const q = query(tasksRef, where('communityId', '==', communityId));
                const querySnapshot = await getDocs(q);

                console.log('Found', querySnapshot.size, 'tasks');

                if (querySnapshot.empty) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <span class="material-symbols-outlined text-4xl text-text-muted-dark mb-2">assignment</span>
                            <p class="text-text-muted-dark text-sm">No tasks yet</p>
                        </div>
                    `;
                    document.getElementById('activeTasksCount').textContent = '0';
                    document.getElementById('completedTasksCount').textContent = '0';
                    return;
                }

                container.innerHTML = '';
                let activeTasks = 0;
                let completedTasks = 0;

                querySnapshot.forEach((taskDoc) => {
                    const task = taskDoc.data();
                    
                    if (task.status === 'completed') {
                        completedTasks++;
                    } else {
                        activeTasks++;
                    }

                    const taskCard = document.createElement('div');
                    taskCard.className = 'flex items-center justify-between p-4 rounded-lg bg-background-dark border border-border-dark hover:border-primary/50 transition-colors cursor-pointer';
                    taskCard.onclick = () => window.location.href = `/task/${taskDoc.id}`;

                    const statusColor = task.status === 'completed' ? 'text-green-400' : 
                                       task.status === 'in-progress' ? 'text-blue-400' : 
                                       'text-primary';
                    const statusText = task.status || 'open';

                    taskCard.innerHTML = `
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <p class="text-cream font-bold truncate">${task.title || 'Untitled Task'}</p>
                                <span class="text-xs px-2 py-1 rounded-full ${statusColor} bg-current bg-opacity-20 font-semibold uppercase flex-shrink-0">${statusText}</span>
                            </div>
                            <p class="text-text-muted-dark text-sm truncate">${task.description || 'No description'}</p>
                        </div>
                        <div class="flex items-center gap-4 flex-shrink-0 ml-4">
                            <div class="text-right">
                                <p class="text-primary font-bold">${task.reward || 0} HLP</p>
                                ${task.assignedTo ? '<p class="text-text-muted-dark text-xs">Assigned</p>' : '<p class="text-text-muted-dark text-xs">Available</p>'}
                            </div>
                            <span class="material-symbols-outlined text-text-muted-dark">chevron_right</span>
                        </div>
                    `;

                    container.appendChild(taskCard);
                });

                document.getElementById('activeTasksCount').textContent = activeTasks;
                document.getElementById('completedTasksCount').textContent = completedTasks;

            } catch (error) {
                console.error('Error loading tasks:', error);
                container.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-red-400 text-sm">Error loading tasks</p>
                        <p class="text-text-muted-dark text-xs mt-2">${error.message}</p>
                    </div>
                `;
            }
        }

        // Leave Community
        document.getElementById('leaveBtn').addEventListener('click', () => {
            document.getElementById('leaveModal').classList.remove('hidden');
        });

        document.getElementById('cancelLeaveBtn').addEventListener('click', () => {
            document.getElementById('leaveModal').classList.add('hidden');
        });

        document.getElementById('confirmLeaveBtn').addEventListener('click', async () => {
            try {
                const communityRef = doc(db, 'communities', communityId);
                const userRef = doc(db, 'users', currentUser.uid);

                await updateDoc(communityRef, {
                    members: arrayRemove(currentUser.uid),
                    memberCount: increment(-1)
                });

                await updateDoc(userRef, {
                    joinedCommunities: arrayRemove(communityId)
                });

                alert('You have left the community');
                window.location.href = '/my-communities';
            } catch (error) {
                console.error('Error leaving community:', error);
                alert('Error: ' + error.message);
            }
        });

        // Delete Community
        document.getElementById('deleteBtn').addEventListener('click', () => {
            document.getElementById('deleteModal').classList.remove('hidden');
        });

        document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
            document.getElementById('deleteModal').classList.add('hidden');
            document.getElementById('deleteConfirmInput').value = '';
        });

        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            const confirmText = document.getElementById('deleteConfirmInput').value;
            
            if (confirmText !== 'DELETE') {
                alert('Please type DELETE to confirm');
                return;
            }

            try {
                await deleteDoc(doc(db, 'communities', communityId));
                alert('Community deleted successfully');
                window.location.href = '/my-communities';
            } catch (error) {
                console.error('Error deleting community:', error);
                alert('Error: ' + error.message);
            }
        });

        // Close modals on outside click
        document.getElementById('leaveModal').addEventListener('click', (e) => {
            if (e.target.id === 'leaveModal') {
                document.getElementById('leaveModal').classList.add('hidden');
            }
        });

        document.getElementById('deleteModal').addEventListener('click', (e) => {
            if (e.target.id === 'deleteModal') {
                document.getElementById('deleteModal').classList.add('hidden');
                document.getElementById('deleteConfirmInput').value = '';
            }
        });
    </script>
</body>
</html>
