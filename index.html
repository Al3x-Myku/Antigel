<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SideQuests · Community Task Manager</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#1337ec",
                        "background-light": "#f6f6f8",
                        "background-dark": "#101322",
                    },
                    fontFamily: {
                        display: ["Space Grotesk", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: "1rem",
                        lg: "2rem",
                        xl: "3rem",
                        full: "9999px",
                    },
                },
            },
        };
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }
        body { font-family: 'Space Grotesk', sans-serif; }
    </style>
    <meta name="color-scheme" content="dark light" />
    <meta name="theme-color" content="#101322" />
</head>
<body class="bg-background-light dark:bg-background-dark text-[#9da1b9] min-h-screen">

    <!-- Login Screen (shown until wallet connected) -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center px-4">
        <div class="w-full max-w-xl bg-white/5 border border-white/10 rounded-lg p-8 text-center backdrop-blur-sm">
            <div class="mx-auto mb-6 size-12 text-primary">
                <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                    <path d="M24 45.8096C19.6865 45.8096 15.4698 44.5305 11.8832 42.134C8.29667 39.7376 5.50128 36.3314 3.85056 32.3462C2.19985 28.361 1.76794 23.9758 2.60947 19.7452C3.451 15.5145 5.52816 11.6284 8.57829 8.5783C11.6284 5.52817 15.5145 3.45101 19.7452 2.60948C23.9758 1.76795 28.361 2.19986 32.3462 3.85057C36.3314 5.50129 39.7376 8.29668 42.134 11.8833C44.5305 15.4698 45.8096 19.6865 45.8096 24L24 24L24 45.8096Z" fill="currentColor"></path>
                </svg>
            </div>
            <h1 class="text-white text-3xl font-black mb-2 tracking-tight">SideQuests</h1>
            <p class="text-sm mb-6">Connect your wallet on Sepolia to create and complete quests.</p>
            <button id="loginButton" class="flex w-full items-center justify-center gap-3 h-12 rounded-full bg-primary text-white font-bold">
                <span class="material-symbols-outlined">account_balance_wallet</span>
                Connect Wallet
            </button>
            <div class="mt-6 p-4 bg-white/5 border border-white/10 rounded-lg text-left text-sm">
                <p class="mb-1">Network: <span class="text-white font-semibold">Sepolia Testnet</span></p>
                <a class="text-primary hover:underline" href="https://sepoliafaucet.com/" target="_blank" rel="noreferrer">Get Sepolia ETH</a>
            </div>
        </div>
    </div>

    <!-- Main App (hidden until logged in) -->
    <div id="mainApp" class="hidden flex min-h-screen flex-col">
        <!-- Header -->
        <header class="sticky top-0 z-50 flex items-center justify-between whitespace-nowrap border-b border-white/10 px-4 sm:px-8 md:px-10 py-3 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm">
            <div class="flex items-center gap-4 text-white">
                <div class="size-6 text-primary">
                    <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                        <path d="M24 45.8096C19.6865 45.8096 15.4698 44.5305 11.8832 42.134C8.29667 39.7376 5.50128 36.3314 3.85056 32.3462C2.19985 28.361 1.76794 23.9758 2.60947 19.7452C3.451 15.5145 5.52816 11.6284 8.57829 8.5783C11.6284 5.52817 15.5145 3.45101 19.7452 2.60948C23.9758 1.76795 28.361 2.19986 32.3462 3.85057C36.3314 5.50129 39.7376 8.29668 42.134 11.8833C44.5305 15.4698 45.8096 19.6865 45.8096 24L24 24L24 45.8096Z" fill="currentColor"></path>
                    </svg>
                </div>
                <h2 class="text-white text-lg font-bold leading-tight tracking-[-0.015em]">SideQuests</h2>
            </div>
            <div class="hidden lg:flex flex-1 justify-center gap-8">
                <div class="flex items-center gap-9">
                    <a class="text-white/80 hover:text-white transition-colors text-sm font-medium leading-normal" href="#">Dashboard</a>
                    <a class="text-white text-sm font-medium leading-normal" href="#">Quests</a>
                    <a class="text-white/80 hover:text-white transition-colors text-sm font-medium leading-normal" href="#">Communities</a>
                    <a class="text-white/80 hover:text-white transition-colors text-sm font-medium leading-normal" href="#">Rewards</a>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <div class="hidden sm:flex items-center gap-2 mr-2">
                    <span class="hidden md:inline text-xs text-white/70">Addr:</span>
                    <span id="userAddress" class="text-white/90 text-xs font-mono truncate max-w-[180px]"></span>
                    <span class="mx-1 text-white/20">•</span>
                    <span id="userBalance" class="text-white/90 text-xs font-mono"></span>
                </div>
                <button id="disconnectWallet" class="hidden sm:flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-white/10 hover:bg-white/20 text-white text-sm font-bold leading-normal tracking-[0.015em]">
                    <span class="truncate">Disconnect</span>
                </button>
                <button class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 bg-white/10 hover:bg-white/20 text-white gap-2 text-sm font-bold leading-normal tracking-[0.015em] min-w-0 px-2.5">
                    <span class="material-symbols-outlined text-xl">notifications</span>
                </button>
                <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuAM3aqSFMwPhnnBGZw35sWWb_mzWAExLvlRpTKGDk4WoqIvRAI_a5O7Z121wCafikJL8-1R-VB0_H-fQupjEcz6NoIyc6faF5WO1StgIyQNl6tILG9ZRodpx_X9A1aFLCCAP7amTRVKRPgjZDc_NdVDzXsOhSCsG8nEy_yhNuaNQ6qnMTve7PPiiqnGFgq1mkjqRjQ22R-y8XB7UShaIwhbuj-286aPfMOxzMPj6valE0QfO70PtIYoPfN56m59MRCK1XxyC3-3");'></div>
            </div>
        </header>

        <main class="flex-1 px-4 sm:px-8 md:px-10 py-8 lg:py-12">
            <div class="max-w-7xl mx-auto">
                <div class="flex flex-wrap gap-2 mb-4">
                    <a class="hover:text-white transition-colors text-sm font-medium leading-normal" href="#">Web3 Community</a>
                    <span class="text-sm font-medium leading-normal">/</span>
                    <a class="hover:text-white transition-colors text-sm font-medium leading-normal" href="#">Quests</a>
                    <span class="text-sm font-medium leading-normal">/</span>
                    <span class="text-white text-sm font-medium leading-normal">Create Quest</span>
                </div>
                <div class="flex flex-wrap justify-between items-center gap-3 mb-8">
                    <p class="text-white text-4xl font-black leading-tight tracking-[-0.033em] min-w-72">Create a New Quest</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:gap-12 items-start">
                    <!-- Left: Create form -->
                    <div class="lg:col-span-2 flex flex-col gap-8">
                        <!-- The Basics -->
                        <div class="bg-background-light dark:bg-white/5 border border-transparent dark:border-white/10 rounded-lg p-6">
                            <h3 class="text-white text-lg font-bold leading-tight tracking-[-0.015em] mb-6">Create New Task</h3>
                            <form id="createTaskForm" class="flex flex-col gap-6">
                                <label class="flex flex-col">
                                    <p class="text-white text-base font-medium leading-normal pb-2">Task Description</p>
                                    <textarea id="taskDescription" placeholder="Describe the task..." rows="4" class="form-input bg-[#1c1d27] border-[#3b3f54] focus:border-primary focus:ring-primary/50 text-white rounded px-4 py-3"></textarea>
                                    <span class="text-xs text-white/50 pt-2">Provide a clear description of what needs to be done.</span>
                                </label>

                                <!-- Reward Amount -->
                                <label class="flex flex-col">
                                    <p class="text-white text-base font-medium leading-normal pb-2">Reward Amount</p>
                                    <div class="relative">
                                        <input id="rewardAmount" type="number" value="100" placeholder="100" class="form-input h-12 w-full bg-[#1c1d27] border-[#3b3f54] focus:border-primary focus:ring-primary/50 text-white rounded pl-4 pr-24" />
                                        <div class="absolute inset-y-0 right-0 flex items-center pr-4 pointer-events-none">
                                            <span class="text-white font-bold">HLP Tokens</span>
                                        </div>
                                    </div>
                                    <span class="text-xs text-white/50 pt-2">Amount of HLP tokens to reward upon completion (in wei, e.g., 100 = 100 tokens).</span>
                                </label>

                                <div id="createTaskResult" class="hidden mt-1 p-3 rounded bg-white/5 border border-white/10 text-sm"></div>

                                <!-- Submit button -->
                                <div>
                                    <button type="submit" class="flex w-full items-center justify-center gap-2 h-12 rounded-full bg-primary hover:brightness-110 text-white font-bold">
                                        <span class="material-symbols-outlined">add_task</span>
                                        Create Task
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Task Actions -->
                        <div class="bg-background-light dark:bg-white/5 border border-transparent dark:border-white/10 rounded-lg p-6">
                            <h3 class="text-white text-lg font-bold leading-tight tracking-[-0.015em] mb-6">Task Actions</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Apply for Task -->
                                <div class="flex flex-col gap-2">
                                    <label class="text-white text-sm font-medium">Apply for Task</label>
                                    <div class="flex gap-2">
                                        <input id="applyTaskId" type="number" placeholder="Task ID" class="form-input h-12 flex-1 bg-[#1c1d27] border-[#3b3f54] focus:border-primary focus:ring-primary/50 text-white rounded px-3" />
                                        <button id="applyTaskBtn" class="h-12 px-4 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-bold whitespace-nowrap">Apply</button>
                                    </div>
                                    <span class="text-xs text-white/50">Apply to work on a task</span>
                                    <div id="applyResult" class="hidden text-xs"></div>
                                </div>

                                <!-- Assign Task (Creator Only) -->
                                <div class="flex flex-col gap-2">
                                    <label class="text-white text-sm font-medium">Assign Task</label>
                                    <div class="flex gap-2">
                                        <input id="assignTaskId" type="number" placeholder="Task ID" class="form-input h-10 flex-1 bg-[#1c1d27] border-[#3b3f54] focus:border-primary focus:ring-primary/50 text-white rounded px-3 text-sm" />
                                    </div>
                                    <div class="flex gap-2">
                                        <input id="assignWorkerAddress" type="text" placeholder="Worker Address (0x...)" class="form-input h-10 flex-1 bg-[#1c1d27] border-[#3b3f54] focus:border-primary focus:ring-primary/50 text-white rounded px-3 text-sm" />
                                        <button id="assignTaskBtn" class="h-10 px-4 rounded-lg bg-purple-600 hover:bg-purple-500 text-white font-bold text-sm whitespace-nowrap">Assign</button>
                                    </div>
                                    <span class="text-xs text-white/50">Creator assigns task to applicant</span>
                                    <div id="assignResult" class="hidden text-xs"></div>
                                </div>

                                <!-- Complete Task & Mint Rewards (Creator Only) -->
                                <div class="flex flex-col gap-2">
                                    <label class="text-white text-sm font-medium">Complete & Reward</label>
                                    <div class="flex gap-2">
                                        <input id="completeTaskId" type="number" placeholder="Task ID" class="form-input h-12 flex-1 bg-[#1c1d27] border-[#3b3f54] focus:border-primary focus:ring-primary/50 text-white rounded px-3" />
                                        <button id="completeTaskBtn" class="h-12 px-4 rounded-lg bg-green-600 hover:bg-green-500 text-white font-bold whitespace-nowrap">Complete</button>
                                    </div>
                                    <span class="text-xs text-white/50">Creator completes task & mints rewards</span>
                                    <div id="completeResult" class="hidden text-xs"></div>
                                </div>

                                <!-- Cancel Task (Creator Only) -->
                                <div class="flex flex-col gap-2">
                                    <label class="text-white text-sm font-medium">Cancel Task</label>
                                    <div class="flex gap-2">
                                        <input id="cancelTaskId" type="number" placeholder="Task ID" class="form-input h-12 flex-1 bg-[#1c1d27] border-[#3b3f54] focus:border-primary focus:ring-primary/50 text-white rounded px-3" />
                                        <button id="cancelTaskBtn" class="h-12 px-4 rounded-lg bg-red-600 hover:bg-red-500 text-white font-bold whitespace-nowrap">Cancel</button>
                                    </div>
                                    <span class="text-xs text-white/50">Creator cancels unassigned task</span>
                                    <div id="cancelResult" class="hidden text-xs"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Task list -->
                    <div class="lg:col-span-1 lg:sticky top-28">
                        <div class="bg-background-light dark:bg-white/5 border border-transparent dark:border-white/10 rounded-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-white text-lg font-bold leading-tight tracking-[-0.015em]">Task List</h3>
                                <button id="refreshTasks" class="h-9 px-3 rounded-full bg-white/10 hover:bg-white/20 text-white text-sm font-medium">Refresh</button>
                            </div>
                            <div id="taskList" class="space-y-3 max-h-[28rem] overflow-y-auto">
                                <p class="text-center py-8">Connect wallet to view tasks</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- My Rewards -->
                <div class="mt-8 bg-background-light dark:bg-white/5 border border-transparent dark:border-white/10 rounded-lg p-6">
                    <h3 class="text-white text-lg font-bold leading-tight tracking-[-0.015em] mb-4">My Rewards</h3>
                    <div id="rewardsList" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <p class="text-center py-8 col-span-3">Connect wallet to view rewards</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer actions -->
        <footer class="sticky bottom-0 z-40 mt-auto bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm border-t border-white/10 py-4">
            <div class="max-w-7xl mx-auto px-4 sm:px-8 md:px-10 flex items-center justify-end gap-4">
                <button class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-6 bg-white/10 hover:bg-white/20 text-white text-base font-bold">
                    <span class="truncate">Save as Draft</span>
                </button>
                <button type="submit" form="createTaskForm" class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-6 bg-primary text-white text-base font-bold gap-2">
                    <span class="truncate">Publish Quest</span>
                    <span class="material-symbols-outlined">arrow_forward</span>
                </button>
            </div>
        </footer>
    </div>

    <script>
        // Contract addresses and ABIs from deployment.json
        const REWARD_CONTRACT_ADDRESS = "0x05b9635A081086540954e7e965db5EA2714be86d";
        const TASK_CONTRACT_ADDRESS = "0x826a184E74fF54130B7Cb27EE5Ec8c15Df5c5d47";
        
        const TASK_CONTRACT_ABI = [{"inputs":[{"internalType":"address","name":"_rewardToken","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"taskId","type":"uint256"},{"indexed":false,"internalType":"address","name":"applicant","type":"address"}],"name":"TaskApplied","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"taskId","type":"uint256"},{"indexed":false,"internalType":"address","name":"worker","type":"address"}],"name":"TaskAssigned","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"taskId","type":"uint256"}],"name":"TaskCancelled","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"taskId","type":"uint256"},{"indexed":false,"internalType":"address","name":"worker","type":"address"},{"indexed":false,"internalType":"uint256","name":"reward","type":"uint256"}],"name":"TaskCompleted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"taskId","type":"uint256"},{"indexed":false,"internalType":"string","name":"description","type":"string"},{"indexed":false,"internalType":"uint256","name":"reward","type":"uint256"},{"indexed":false,"internalType":"address","name":"creator","type":"address"}],"name":"TaskCreated","type":"event"},{"inputs":[{"internalType":"uint256","name":"_taskId","type":"uint256"}],"name":"applyForTask","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_taskId","type":"uint256"},{"internalType":"address","name":"_worker","type":"address"}],"name":"assignTask","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_taskId","type":"uint256"}],"name":"cancelTask","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_taskId","type":"uint256"}],"name":"completeTask","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_description","type":"string"},{"internalType":"uint256","name":"_reward","type":"uint256"}],"name":"createTask","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_taskId","type":"uint256"}],"name":"getTask","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"description","type":"string"},{"internalType":"uint256","name":"reward","type":"uint256"},{"internalType":"bool","name":"completed","type":"bool"},{"internalType":"address","name":"worker","type":"address"},{"internalType":"address","name":"creator","type":"address"}],"internalType":"struct TaskContract.TaskStruct","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_taskId","type":"uint256"}],"name":"getTaskApplicants","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTasksCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getUserTasks","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasApplied","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"rewardToken","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_rewardToken","type":"address"}],"name":"setRewardToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"taskApplicants","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"taskCounter","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"tasks","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"description","type":"string"},{"internalType":"uint256","name":"reward","type":"uint256"},{"internalType":"bool","name":"completed","type":"bool"},{"internalType":"address","name":"worker","type":"address"},{"internalType":"address","name":"creator","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"userTasks","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}];
        
        const REWARD_CONTRACT_ABI = [{"inputs":[{"internalType":"address","name":"admin","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"previousAdminRole","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"newAdminRole","type":"bytes32"}],"name":"RoleAdminChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"}],"name":"RoleGranted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"}],"name":"RoleRevoked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[],"name":"DEFAULT_ADMIN_ROLE","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MINTER_ROLE","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"burn","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"burnFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"subtractedValue","type":"uint256"}],"name":"decreaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"}],"name":"getRoleAdmin","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"grantMinterRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"grantRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"hasRole","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"addedValue","type":"uint256"}],"name":"increaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"mint","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"renounceRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"revokeMinterRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"revokeRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"}];

        let provider;
        let signer;
        let userAddress;
        let taskContract;
        let rewardContract;

    const statusLabels = ['Created', 'InProgress', 'Completed', 'Verified'];
    const statusColors = ['bg-blue-600', 'bg-yellow-500', 'bg-purple-600', 'bg-green-600'];

        // Login with MetaMask
        document.getElementById('loginButton').addEventListener('click', async () => {
            if (typeof window.ethereum === 'undefined') {
                alert('MetaMask is not installed!\n\nPlease install MetaMask extension to continue.\n\nVisit: https://metamask.io');
                return;
            }

            const loginBtn = document.getElementById('loginButton');
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<span class="material-symbols-outlined animate-pulse">progress_activity</span> Connecting...';

            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                // Check network - Sepolia chainId is 11155111
                const network = await provider.getNetwork();
                if (network.chainId !== 11155111) {
                    alert('⚠️ Wrong Network!\n\nPlease switch to Sepolia Testnet in MetaMask.\n\nCurrent network: ' + network.name);
                    
                    // Try to switch network automatically
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0xaa36a7' }], // 11155111 in hex
                        });
                        // Reload after switch
                        window.location.reload();
                    } catch (switchError) {
                        console.error('Network switch error:', switchError);
                        loginBtn.disabled = false;
                        loginBtn.innerHTML = `
                            <svg class="w-8 h-8" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M38 20C38 29.9411 29.9411 38 20 38C10.0589 38 2 29.9411 2 20C2 10.0589 10.0589 2 20 2C29.9411 2 38 10.0589 38 20Z" fill="#E17726" stroke="#E17726" stroke-width="0.25"/>
                                <path d="M20 2L14 16L20 20L26 16L20 2Z" fill="#E27625"/>
                                <path d="M20 20L14 16L11 23L20 27L29 23L26 16L20 20Z" fill="#F5841F"/>
                                <path d="M20 27L11 23L9 31L20 38L31 31L29 23L20 27Z" fill="#C0AC9D"/>
                            </svg>
                            Connect with MetaMask
                        `;
                    }
                    return;
                }
                
                taskContract = new ethers.Contract(TASK_CONTRACT_ADDRESS, TASK_CONTRACT_ABI, signer);
                rewardContract = new ethers.Contract(REWARD_CONTRACT_ADDRESS, REWARD_CONTRACT_ABI, signer);

                const balance = await provider.getBalance(userAddress);
                
                const shortAddr = userAddress.slice(0,6) + '...' + userAddress.slice(-4);
                document.getElementById('userAddress').textContent = shortAddr;
                document.getElementById('userBalance').textContent = ethers.utils.formatEther(balance) + ' ETH';
                
                // Hide login screen, show main app
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');

                await loadTasks();
                await loadRewards();
            } catch (error) {
                console.error('Connection error:', error);
                
                let errorMsg = 'Failed to connect wallet';
                if (error.code === 4001) {
                    errorMsg = 'Connection rejected.\n\nPlease approve the connection in MetaMask to continue.';
                } else if (error.message) {
                    errorMsg = error.message;
                }
                
                alert('❌ ' + errorMsg);
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<span class="material-symbols-outlined">account_balance_wallet</span> Connect Wallet';
            }
        });

        // Disconnect Wallet
        document.getElementById('disconnectWallet').addEventListener('click', () => {
            // Clear state
            provider = null;
            signer = null;
            userAddress = null;
            taskContract = null;
            rewardContract = null;
            
            // Show login screen, hide main app
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        });

        // Create Task
        document.getElementById('createTaskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!taskContract) {
                alert('Please connect wallet first');
                return;
            }

            const description = document.getElementById('taskDescription').value;
            const rewardAmount = document.getElementById('rewardAmount').value;

            if (!description || !rewardAmount) {
                alert('Please fill in all fields');
                return;
            }

            const resultDiv = document.getElementById('createTaskResult');
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<span class="text-yellow-400">⏳ Creating task...</span>';

            try {
                const tx = await taskContract.createTask(description, rewardAmount);
                resultDiv.innerHTML = '<span class="text-blue-400">⏳ Waiting for confirmation...</span>';
                
                const receipt = await tx.wait();
                resultDiv.innerHTML = '<span class="text-green-400">✅ Task created successfully!</span>';
                
                document.getElementById('createTaskForm').reset();
                setTimeout(() => {
                    loadTasks();
                    resultDiv.classList.add('hidden');
                }, 2000);
            } catch (error) {
                console.error('Create task error:', error);
                resultDiv.innerHTML = `<span class="text-red-400">❌ Error: ${error.message}</span>`;
            }
        });

        // Load Tasks
        async function loadTasks() {
            if (!taskContract) return;

            try {
                const taskCount = await taskContract.getTasksCount();
                const taskListDiv = document.getElementById('taskList');
                
                if (taskCount.eq(0)) {
                    taskListDiv.innerHTML = '<p class="text-gray-400 text-center py-8">No tasks yet. Create the first one!</p>';
                    return;
                }

                taskListDiv.innerHTML = '';
                
                for (let i = 1; i <= taskCount.toNumber(); i++) {
                    try {
                        const task = await taskContract.getTask(i);
                        
                        const taskCard = document.createElement('div');
                        taskCard.className = 'bg-gray-700/50 rounded-lg p-4 border border-gray-600 hover:border-primary transition';
                        
                        const statusBadge = task.completed ? 
                            '<span class="bg-green-600 text-xs px-2 py-1 rounded-full">Completed</span>' :
                            task.worker !== ethers.constants.AddressZero ?
                            '<span class="bg-yellow-500 text-xs px-2 py-1 rounded-full">Assigned</span>' :
                            '<span class="bg-blue-600 text-xs px-2 py-1 rounded-full">Open</span>';
                        
                        taskCard.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-semibold text-lg text-white">Task #${i}</h3>
                                ${statusBadge}
                            </div>
                            <p class="text-sm text-gray-300 mb-3">${task.description}</p>
                            <div class="text-xs text-gray-400 space-y-1">
                                <p>Creator: ${task.creator.slice(0, 6)}...${task.creator.slice(-4)}</p>
                                ${task.worker !== ethers.constants.AddressZero ? `<p>Worker: ${task.worker.slice(0, 6)}...${task.worker.slice(-4)}</p>` : '<p>Worker: Not assigned</p>'}
                                <p class="text-primary font-semibold">Reward: ${task.reward} HLP</p>
                            </div>
                        `;
                        taskListDiv.appendChild(taskCard);
                    } catch (err) {
                        console.log(`Task ${i} not found or deleted`);
                    }
                }
            } catch (error) {
                console.error('Load tasks error:', error);
            }
        }

        // Apply for Task
        document.getElementById('applyTaskBtn').addEventListener('click', async () => {
            if (!taskContract) {
                alert('Please connect wallet first');
                return;
            }

            const taskId = document.getElementById('applyTaskId').value;
            const resultDiv = document.getElementById('applyResult');
            
            if (!taskId) {
                alert('Please enter a task ID');
                return;
            }

            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<span class="text-yellow-400">⏳ Applying for task...</span>';

            try {
                const tx = await taskContract.applyForTask(taskId);
                resultDiv.innerHTML = '<span class="text-blue-400">⏳ Confirming...</span>';
                await tx.wait();
                resultDiv.innerHTML = '<span class="text-green-400">✅ Applied successfully!</span>';
                setTimeout(() => {
                    loadTasks();
                    resultDiv.classList.add('hidden');
                }, 2000);
            } catch (error) {
                console.error('Apply error:', error);
                resultDiv.innerHTML = `<span class="text-red-400">❌ ${error.message}</span>`;
            }
        });

        // Assign Task
        document.getElementById('assignTaskBtn').addEventListener('click', async () => {
            if (!taskContract) {
                alert('Please connect wallet first');
                return;
            }

            const taskId = document.getElementById('assignTaskId').value;
            const workerAddress = document.getElementById('assignWorkerAddress').value;
            const resultDiv = document.getElementById('assignResult');
            
            if (!taskId || !workerAddress) {
                alert('Please enter task ID and worker address');
                return;
            }

            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<span class="text-yellow-400">⏳ Assigning task...</span>';

            try {
                const tx = await taskContract.assignTask(taskId, workerAddress);
                resultDiv.innerHTML = '<span class="text-blue-400">⏳ Confirming...</span>';
                await tx.wait();
                resultDiv.innerHTML = '<span class="text-green-400">✅ Task assigned!</span>';
                setTimeout(() => {
                    loadTasks();
                    resultDiv.classList.add('hidden');
                }, 2000);
            } catch (error) {
                console.error('Assign error:', error);
                resultDiv.innerHTML = `<span class="text-red-400">❌ ${error.message}</span>`;
            }
        });

        // Complete Task
        document.getElementById('completeTaskBtn').addEventListener('click', async () => {
            if (!taskContract) {
                alert('Please connect wallet first');
                return;
            }

            const taskId = document.getElementById('completeTaskId').value;
            const resultDiv = document.getElementById('completeResult');
            
            if (!taskId) {
                alert('Please enter a task ID');
                return;
            }

            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<span class="text-yellow-400">⏳ Completing task and minting rewards...</span>';

            try {
                const tx = await taskContract.completeTask(taskId);
                resultDiv.innerHTML = '<span class="text-blue-400">⏳ Confirming...</span>';
                await tx.wait();
                resultDiv.innerHTML = '<span class="text-green-400">✅ Task completed & rewards minted!</span>';
                setTimeout(() => {
                    loadTasks();
                    loadRewards();
                    resultDiv.classList.add('hidden');
                }, 2000);
            } catch (error) {
                console.error('Complete error:', error);
                resultDiv.innerHTML = `<span class="text-red-400">❌ ${error.message}</span>`;
            }
        });

        // Cancel Task
        document.getElementById('cancelTaskBtn').addEventListener('click', async () => {
            if (!taskContract) {
                alert('Please connect wallet first');
                return;
            }

            const taskId = document.getElementById('cancelTaskId').value;
            const resultDiv = document.getElementById('cancelResult');
            
            if (!taskId) {
                alert('Please enter a task ID');
                return;
            }

            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<span class="text-yellow-400">⏳ Cancelling task...</span>';

            try {
                const tx = await taskContract.cancelTask(taskId);
                resultDiv.innerHTML = '<span class="text-blue-400">⏳ Confirming...</span>';
                await tx.wait();
                resultDiv.innerHTML = '<span class="text-green-400">✅ Task cancelled!</span>';
                setTimeout(() => {
                    loadTasks();
                    resultDiv.classList.add('hidden');
                }, 2000);
            } catch (error) {
                console.error('Cancel error:', error);
                resultDiv.innerHTML = `<span class="text-red-400">❌ ${error.message}</span>`;
            }
        });

        // Load Rewards
        async function loadRewards() {
            if (!rewardContract || !account) return;

            try {
                const balance = await rewardContract.balanceOf(account);
                const rewardListDiv = document.getElementById('rewardList');
                
                rewardListDiv.innerHTML = `
                    <div class="bg-gray-700/50 rounded-lg p-6 text-center border border-gray-600">
                        <h3 class="text-3xl font-bold text-primary mb-2">${balance}</h3>
                        <p class="text-gray-400">HLP Tokens</p>
                    </div>
                `;
            } catch (error) {
                console.error('Load rewards error:', error);
            }
        }

        // Refresh Tasks
        document.getElementById('refreshTasks').addEventListener('click', loadTasks);

        // Check if already connected on page load
        window.addEventListener('load', async () => {
            if (window.ethereum && window.ethereum.selectedAddress) {
                // Auto-login if already connected
                document.getElementById('loginButton').click();
            }
        });

        // Listen for account changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    // User disconnected
                    document.getElementById('disconnectWallet').click();
                } else {
                    // Account changed, reload
                    window.location.reload();
                }
            });

            window.ethereum.on('chainChanged', () => {
                // Network changed, reload
                window.location.reload();
            });
        }
    </script>

</body>
</html>
