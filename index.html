<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SideQuests ¬∑ Community Task Manager</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#1337ec",
                        "background-light": "#f6f6f8",
                        "background-dark": "#101322",
                    },
                    fontFamily: {
                        display: ["Space Grotesk", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: "1rem",
                        lg: "2rem",
                        xl: "3rem",
                        full: "9999px",
                    },
                },
            },
        };
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }
        body { font-family: 'Space Grotesk', sans-serif; }
    </style>
    <meta name="color-scheme" content="dark light" />
    <meta name="theme-color" content="#101322" />
</head>
<body class="bg-background-light dark:bg-background-dark text-[#9da1b9] min-h-screen">

    <div id="loginScreen" class="min-h-screen flex items-center justify-center px-4">
        <div class="w-full max-w-xl bg-white/5 border border-white/10 rounded-lg p-8 text-center backdrop-blur-sm">
            <div class="mx-auto mb-6 size-12 text-primary">
                <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                    <path d="M24 45.8096C19.6865 45.8096 15.4698 44.5305 11.8832 42.134C8.29667 39.7376 5.50128 36.3314 3.85056 32.3462C2.19985 28.361 1.76794 23.9758 2.60947 19.7452C3.451 15.5145 5.52816 11.6284 8.57829 8.5783C11.6284 5.52817 15.5145 3.45101 19.7452 2.60948C23.9758 1.76795 28.361 2.19986 32.3462 3.85057C36.3314 5.50129 39.7376 8.29668 42.134 11.8833C44.5305 15.4698 45.8096 19.6865 45.8096 24L24 24L24 45.8096Z" fill="currentColor"></path>
                </svg>
            </div>
            <h1 class="text-white text-3xl font-black mb-2 tracking-tight">SideQuests</h1>
            <p class="text-sm mb-6">Connect your wallet on Sepolia to create and complete quests.</p>
            <button id="loginButton" class="flex w-full items-center justify-center gap-3 h-12 rounded-full bg-primary text-white font-bold">
                <span class="material-symbols-outlined">account_balance_wallet</span>
                Connect Wallet
            </button>
            <div class="mt-6 p-4 bg-white/5 border border-white/10 rounded-lg text-left text-sm">
                <p class="mb-1">Network: <span class="text-white font-semibold">Sepolia Testnet</span></p>
                <a class="text-primary hover:underline" href="https://sepoliafaucet.com/" target="_blank" rel="noreferrer">Get Sepolia ETH</a>
            </div>
        </div>
    </div>

    <div id="mainApp" class="hidden flex min-h-screen flex-col">
        <header class="sticky top-0 z-50 flex items-center justify-between whitespace-nowrap border-b border-white/10 px-4 sm:px-8 md:px-10 py-3 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm">
            <div class="flex items-center gap-4 text-white">
                <div class="size-6 text-primary">
                    <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                        <path d="M24 45.8096C19.6865 45.8096 15.4698 44.5305 11.8832 42.134C8.29667 39.7376 5.50128 36.3314 3.85056 32.3462C2.19985 28.361 1.76794 23.9758 2.60947 19.7452C3.451 15.5145 5.52816 11.6284 8.57829 8.5783C11.6284 5.52817 15.5145 3.45101 19.7452 2.60948C23.9758 1.76795 28.361 2.19986 32.3462 3.85057C36.3314 5.50129 39.7376 8.29668 42.134 11.8833C44.5305 15.4698 45.8096 19.6865 45.8096 24L24 24L24 45.8096Z" fill="currentColor"></path>
                    </svg>
                </div>
                <h2 class="text-white text-lg font-bold leading-tight tracking-[-0.015em]">SideQuests</h2>
            </div>
            <div class="hidden lg:flex flex-1 justify-center gap-8">
                <div class="flex items-center gap-9">
                    <a class="text-white/80 hover:text-white transition-colors text-sm font-medium leading-normal" href="#">Dashboard</a>
                    <a class="text-white text-sm font-medium leading-normal" href="#">Quests</a>
                    <a class="text-white/80 hover:text-white transition-colors text-sm font-medium leading-normal" href="#">Communities</a>
                    <a class="text-white/80 hover:text-white transition-colors text-sm font-medium leading-normal" href="#">Achievements</a>
                    <a class="text-white/80 hover:text-white transition-colors text-sm font-medium leading-normal" href="#">Rewards</a>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <div class="hidden sm:flex items-center gap-2 mr-2">
                    <span class="hidden md:inline text-xs text-white/70">Addr:</span>
                    <span id="userAddress" class="text-white/90 text-xs font-mono truncate max-w-[180px]"></span>
                    <span class="mx-1 text-white/20">‚Ä¢</span>
                    <span id="userBalance" class="text-white/90 text-xs font-mono"></span>
                </div>
                <!-- Token Management Buttons -->
                <button id="addHLPToken" class="hidden sm:flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-3 bg-blue-600/20 hover:bg-blue-600/30 text-blue-200 text-xs font-medium leading-normal tracking-[0.015em]" title="Add HLP Token to MetaMask">
                    <span class="material-symbols-outlined text-sm mr-1">add_card</span>
                    <span class="truncate">HLP</span>
                </button>
                <button id="addNFTToken" class="hidden sm:flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-3 bg-purple-600/20 hover:bg-purple-600/30 text-purple-200 text-xs font-medium leading-normal tracking-[0.015em]" title="Add Achievement NFTs to MetaMask">
                    <span class="material-symbols-outlined text-sm mr-1">emoji_events</span>
                    <span class="truncate">NFT</span>
                </button>
                <button id="disconnectWallet" class="hidden sm:flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-white/10 hover:bg-white/20 text-white text-sm font-bold leading-normal tracking-[0.015em]">
                    <span class="truncate">Disconnect</span>
                </button>
                <!-- Mobile-friendly dropdown for token management -->
                <div class="relative sm:hidden">
                    <button id="mobileMenuBtn" class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 bg-white/10 hover:bg-white/20 text-white gap-2 text-sm font-bold leading-normal tracking-[0.015em] min-w-0 px-2.5">
                        <span class="material-symbols-outlined text-xl">more_vert</span>
                    </button>
                    <div id="mobileDropdown" class="absolute right-0 top-12 hidden bg-[#1c1d27] border border-gray-600 rounded-lg shadow-lg min-w-[200px] z-50">
                        <button id="mobileAddHLP" class="w-full flex items-center px-4 py-3 text-blue-200 hover:bg-blue-600/20 text-sm transition-colors">
                            <span class="material-symbols-outlined text-sm mr-2">add_card</span>
                            Add HLP Token
                        </button>
                        <button id="mobileAddNFT" class="w-full flex items-center px-4 py-3 text-purple-200 hover:bg-purple-600/20 text-sm transition-colors">
                            <span class="material-symbols-outlined text-sm mr-2">emoji_events</span>
                            Add Achievement NFTs
                        </button>
                        <div class="border-t border-gray-600"></div>
                        <button id="mobileDisconnect" class="w-full flex items-center px-4 py-3 text-red-200 hover:bg-red-600/20 text-sm transition-colors">
                            <span class="material-symbols-outlined text-sm mr-2">logout</span>
                            Disconnect Wallet
                        </button>
                    </div>
                </div>
                <!-- Desktop notification button -->
                <button class="hidden sm:flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 bg-white/10 hover:bg-white/20 text-white gap-2 text-sm font-bold leading-normal tracking-[0.015em] min-w-0 px-2.5">
                    <span class="material-symbols-outlined text-xl">notifications</span>
                </button>
                <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuAM3aqSFMwPhnnBGZw35sWWb_mzWAExLvlRpTKGDk4WoqIvRAI_a5O7Z121wCafikJL8-1R-VB0_H-fQupjEcz6NoIyc6faF5WO1StgIyQNl6tILG9ZRodpx_X9A1aFLCCAP7amTRVKRPgjZDc_NdVDzXsOhSCsG8nEy_yhNuaNQ6qnMTve7PPiiqnGFgq1mkjqRjQ22R-y8XB7UShaIwhbuj-286aPfMOxzMPj6valE0QfO70PtIYoPfN56m59MRCK1XxyC3-3");'></div>
            </div>
        </header>

        <main class="flex-1 px-4 sm:px-8 md:px-10 py-8 lg:py-12">
            <div class="max-w-7xl mx-auto">
                <div class="flex flex-wrap gap-2 mb-4">
                    <a class="hover:text-white transition-colors text-sm font-medium leading-normal" href="#">Web3 Community</a>
                    <span class="text-sm font-medium leading-normal">/</span>
                    <a class="hover:text-white transition-colors text-sm font-medium leading-normal" href="#">Quests</a>
                    <span class="text-sm font-medium leading-normal">/</span>
                    <span class="text-white text-sm font-medium leading-normal">Create Quest</span>
                </div>
                <div class="flex flex-wrap justify-between items-center gap-3 mb-8">
                    <p class="text-white text-4xl font-black leading-tight tracking-[-0.033em] min-w-72">Create a New Quest</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:gap-12 items-start">
                    <div class="lg:col-span-2 flex flex-col gap-8">
                        <div class="bg-background-light dark:bg-white/5 border border-transparent dark:border-white/10 rounded-lg p-6">
                            <h3 class="text-white text-lg font-bold leading-tight tracking-[-0.015em] mb-6">Create New Task</h3>
                            <form id="createTaskForm" class="flex flex-col gap-6">
                                <label class="flex flex-col">
                                    <p class="text-white text-base font-medium leading-normal pb-2">Task Description</p>
                                    <textarea id="taskDescription" placeholder="Describe the task..." rows="4" class="form-input bg-[#1c1d27] border-[#3b3f54] focus:border-primary focus:ring-primary/50 text-white rounded px-4 py-3"></textarea>
                                    <span class="text-xs text-white/50 pt-2">Provide a clear description of what needs to be done.</span>
                                </label>

                                <label class="flex flex-col">
                                    <p class="text-white text-base font-medium leading-normal pb-2">Reward Amount</p>
                                    <div class="relative">
                                        <input id="rewardAmount" type="number" value="100" placeholder="100" class="form-input h-12 w-full bg-[#1c1d27] border-[#3b3f54] focus:border-primary focus:ring-primary/50 text-white rounded pl-4 pr-24" />
                                        <div class="absolute inset-y-0 right-0 flex items-center pr-4 pointer-events-none">
                                            <span class="text-white font-bold">HLP Tokens</span>
                                        </div>
                                    </div>
                                    <span class="text-xs text-white/50 pt-2">Amount of HLP tokens to reward upon completion (in wei, e.g., 100 = 100 tokens).</span>
                                </label>

                                <div id="createTaskResult" class="hidden mt-1 p-3 rounded bg-white/5 border border-white/10 text-sm"></div>

                                <div>
                                    <button type="submit" class="flex w-full items-center justify-center gap-2 h-12 rounded-full bg-primary hover:brightness-110 text-white font-bold">
                                        <span class="material-symbols-outlined">add_task</span>
                                        Create Task
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div class="bg-background-light dark:bg-white/5 border border-transparent dark:border-white/10 rounded-lg p-6">
                            <h3 class="text-white text-lg font-bold leading-tight tracking-[-0.015em] mb-6">Task Actions</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="flex flex-col gap-2">
                                    <label class="text-white text-sm font-medium">Apply for Task</label>
                                    <div class="flex gap-2">
                                        <input id="applyTaskId" type="number" placeholder="Task ID" class="form-input h-12 flex-1 bg-[#1c1d27] border-[#3b3f54] focus:border-primary focus:ring-primary/50 text-white rounded px-3" />
                                        <button id="applyTaskBtn" class="h-12 px-4 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-bold whitespace-nowrap">Apply</button>
                                    </div>
                                    <span class="text-xs text-white/50">Apply to work on a task</span>
                                    <div id="applyResult" class="hidden text-xs"></div>
                                </div>

                                <div class="flex flex-col gap-2">
                                    <label class="text-white text-sm font-medium">Assign Task</label>
                                    <div class="flex gap-2">
                                        <input id="assignTaskId" type="number" placeholder="Task ID" class="form-input h-10 flex-1 bg-[#1c1d27] border-[#3b3f54] focus:border-primary focus:ring-primary/50 text-white rounded px-3 text-sm" />
                                    </div>
                                    <div class="flex gap-2">
                                        <input id="assignWorkerAddress" type="text" placeholder="Worker Address (0x...)" class="form-input h-10 flex-1 bg-[#1c1d27] border-[#3b3f54] focus:border-primary focus:ring-primary/50 text-white rounded px-3 text-sm" />
                                        <button id="assignTaskBtn" class="h-10 px-4 rounded-lg bg-purple-600 hover:bg-purple-500 text-white font-bold text-sm whitespace-nowrap">Assign</button>
                                    </div>
                                    <span class="text-xs text-white/50">Creator assigns task to applicant</span>
                                    <div id="assignResult" class="hidden text-xs"></div>
                                </div>

                                <div class="flex flex-col gap-2">
                                    <label class="text-white text-sm font-medium">Complete & Reward</label>
                                    <div class="flex gap-2">
                                        <input id="completeTaskId" type="number" placeholder="Task ID" class="form-input h-12 flex-1 bg-[#1c1d27] border-[#3b3f54] focus:border-primary focus:ring-primary/50 text-white rounded px-3" />
                                        <button id="completeTaskBtn" class="h-12 px-4 rounded-lg bg-green-600 hover:bg-green-500 text-white font-bold whitespace-nowrap">Complete</button>
                                    </div>
                                    <span class="text-xs text-white/50">Creator completes task & mints rewards</span>
                                    <div id="completeResult" class="hidden text-xs"></div>
                                </div>

                                <div class="flex flex-col gap-2">
                                    <label class="text-white text-sm font-medium">Cancel Task</label>
                                    <div class="flex gap-2">
                                        <input id="cancelTaskId" type="number" placeholder="Task ID" class="form-input h-12 flex-1 bg-[#1c1d27] border-[#3b3f54] focus:border-primary focus:ring-primary/50 text-white rounded px-3" />
                                        <button id="cancelTaskBtn" class="h-12 px-4 rounded-lg bg-red-600 hover:bg-red-500 text-white font-bold whitespace-nowrap">Cancel</button>
                                    </div>
                                    <span class="text-xs text-white/50">Creator cancels unassigned task</span>
                                    <div id="cancelResult" class="hidden text-xs"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-1 lg:sticky top-28">
                        <div class="bg-background-light dark:bg-white/5 border border-transparent dark:border-white/10 rounded-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-white text-lg font-bold leading-tight tracking-[-0.015em]">Task List</h3>
                                <button id="refreshTasks" class="h-9 px-3 rounded-full bg-white/10 hover:bg-white/20 text-white text-sm font-medium">Refresh</button>
                            </div>
                            <div id="taskList" class="space-y-3 max-h-[28rem] overflow-y-auto">
                                <p class="text-center py-8">Connect wallet to view tasks</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 bg-background-light dark:bg-white/5 border border-transparent dark:border-white/10 rounded-lg p-6">
                    <h3 class="text-white text-lg font-bold leading-tight tracking-[-0.015em] mb-4">My Rewards & Achievements</h3>
                    
                    <!-- Token Rewards -->
                    <div class="mb-8">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-white text-md font-semibold">üí∞ Tokens</h4>
                            
                            <!-- MetaMask Helper Info -->
                            <div id="metamaskTokenHelper" class="hidden bg-blue-600/10 border border-blue-600/20 rounded-lg px-3 py-2 text-xs text-blue-200">
                                <span class="material-symbols-outlined text-sm mr-1">info</span>
                                Add tokens to MetaMask using the 
                                <span class="inline-flex items-center mx-1 px-1 bg-blue-600/20 rounded text-xs">
                                    <span class="material-symbols-outlined text-xs mr-0.5">add_card</span>HLP
                                </span>
                                and
                                <span class="inline-flex items-center mx-1 px-1 bg-purple-600/20 rounded text-xs">
                                    <span class="material-symbols-outlined text-xs mr-0.5">emoji_events</span>NFT
                                </span>
                                buttons above
                            </div>
                        </div>
                        
                        <div id="rewardsList" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <p class="text-center py-8 col-span-3">Connect wallet to view rewards</p>
                        </div>
                    </div>

                    <!-- User Stats -->
                    <div class="mb-8">
                        <h4 class="text-white text-md font-semibold mb-4">üìä Statistics</h4>
                        <div id="userStats" class="grid grid-cols-2 md:grid-cols-5 gap-4">
                            <p class="text-center py-8 col-span-5">Connect wallet to view stats</p>
                        </div>
                    </div>

                    <!-- Achievement Badges -->
                    <div>
                        <h4 class="text-white text-md font-semibold mb-4">üèÜ Achievement Badges</h4>
                        <div id="achievementsList" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <p class="text-center py-8 col-span-4">Connect wallet to view achievements</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="sticky bottom-0 z-40 mt-auto bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm border-t border-white/10 py-4">
            <div class="max-w-7xl mx-auto px-4 sm:px-8 md:px-10 flex items-center justify-end gap-4">
                <button class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-6 bg-white/10 hover:bg-white/20 text-white text-base font-bold">
                    <span class="truncate">Save as Draft</span>
                </button>
                <button type="submit" form="createTaskForm" class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-6 bg-primary text-white text-base font-bold gap-2">
                    <span class="truncate">Publish Quest</span>
                    <span class="material-symbols-outlined">arrow_forward</span>
                </button>
            </div>
        </footer>
    </div>

    <script>
        // Contract addresses and ABIs from deployment.json
        const REWARD_CONTRACT_ADDRESS = "0x81Dad8CD9C33c29A532bb1Fc2f0465AC98B92cF2";
        const TASK_CONTRACT_ADDRESS = "0x89859493D3519d51BC856f268423aA61cfc889aD";
        const ACHIEVEMENT_CONTRACT_ADDRESS = "0xC41451BBb7511202DC34aaa161527604e279d5D5";
        
        const TASK_CONTRACT_ABI = [{"inputs":[{"internalType":"address","name":"_rewardToken","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"taskId","type":"uint256"},{"indexed":false,"internalType":"address","name":"applicant","type":"address"}],"name":"TaskApplied","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"taskId","type":"uint256"},{"indexed":false,"internalType":"address","name":"worker","type":"address"}],"name":"TaskAssigned","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"taskId","type":"uint256"}],"name":"TaskCancelled","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"taskId","type":"uint256"},{"indexed":false,"internalType":"address","name":"worker","type":"address"},{"indexed":false,"internalType":"uint256","name":"reward","type":"uint256"}],"name":"TaskCompleted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"taskId","type":"uint256"},{"indexed":false,"internalType":"string","name":"description","type":"string"},{"indexed":false,"internalType":"uint256","name":"reward","type":"uint256"},{"indexed":false,"internalType":"address","name":"creator","type":"address"}],"name":"TaskCreated","type":"event"},{"inputs":[{"internalType":"uint256","name":"_taskId","type":"uint256"}],"name":"applyForTask","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_taskId","type":"uint256"},{"internalType":"address","name":"_worker","type":"address"}],"name":"assignTask","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_taskId","type":"uint256"}],"name":"cancelTask","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_taskId","type":"uint256"}],"name":"completeTask","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_description","type":"string"},{"internalType":"uint256","name":"_reward","type":"uint256"}],"name":"createTask","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_taskId","type":"uint256"}],"name":"getTask","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"description","type":"string"},{"internalType":"uint256","name":"reward","type":"uint256"},{"internalType":"bool","name":"completed","type":"bool"},{"internalType":"address","name":"worker","type":"address"},{"internalType":"address","name":"creator","type":"address"}],"internalType":"struct TaskContract.TaskStruct","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_taskId","type":"uint256"}],"name":"getTaskApplicants","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTasksCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getUserTasks","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasApplied","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"rewardToken","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_rewardToken","type":"address"}],"name":"setRewardToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint2Message"}],"name":"taskApplicants","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"taskCounter","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"tasks","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"description","type":"string"},{"internalType":"uint256","name":"reward","type"
:"uint256"},{"internalType":"bool","name":"completed","type":"bool"},{"internalType":"address","name":"worker","type":"address"},{"internalType":"address","name":"creator","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"userTasks","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}];
        
        const REWARD_CONTRACT_ABI = [{"inputs":[{"internalType":"address","name":"admin","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"previousAdminRole","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"newAdminRole","type":"bytes32"}],"name":"RoleAdminChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"}],"name":"RoleGranted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"}],"name":"RoleRevoked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[],"name":"DEFAULT_ADMIN_ROLE","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MINTER_ROLE","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"burn","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"burnFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"subtractedValue","type":"uint256"}],"name":"decreaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"}],"name":"getRoleAdmin","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"grantMinterRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"grantRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"hasRole","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"addedValue","type":"uint256"}],"name":"increaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"mint","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"renounceRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"revokeMinterRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"revokeRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"}];

        const ACHIEVEMENT_CONTRACT_ABI = [{"inputs":[{"internalType":"address","name":"admin","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"approved","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"recipient","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"},{"indexed":false,"internalType":"uint8","name":"achievementType","type":"uint8"}],"name":"BadgeMinted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint8","name":"achievementType","type":"uint8"}],"name":"MilestoneReached","type":"event"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserBadges","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserStats","outputs":[{"internalType":"uint256","name":"_tasksCompleted","type":"uint256"},{"internalType":"uint256","name":"_tokensEarned","type":"uint256"},{"internalType":"uint256","name":"_tasksCreated","type":"uint256"},{"internalType":"uint256","name":"_currentStreak","type":"uint256"},{"internalType":"uint256","name":"_maxStreak","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"badges","outputs":[{"internalType":"uint8","name":"achievementType","type":"uint8"},{"internalType":"string","name":"title","type":"string"},{"internalType":"string","name":"description","type":"string"},{"internalType":"string","name":"imageURI","type":"string"},{"internalType":"uint256","name":"mintedAt","type":"uint256"},{"internalType":"uint256","name":"rarity","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"}];

        let provider;
        let signer;
        let userAddress;
        let taskContract;
        let rewardContract;
        let achievementContract;

    const statusLabels = ['Created', 'InProgress', 'Completed', 'Verified'];
    const statusColors = ['bg-blue-600', 'bg-yellow-500', 'bg-purple-600', 'bg-green-600'];

    // Achievement type mapping (matches the contract enum)
    const achievementTypes = {
        0: { name: 'First Quest', icon: 'üéØ', description: 'Complete your first task' },
        1: { name: 'Getting Started', icon: '‚≠ê', description: 'Complete 5 tasks' },
        2: { name: 'Task Hunter', icon: 'üî•', description: 'Complete 10 tasks' },
        3: { name: 'Dedicated Worker', icon: 'üí™', description: 'Complete 25 tasks' },
        4: { name: 'Veteran Quester', icon: 'üèÖ', description: 'Complete 50 tasks' },
        5: { name: 'Quest Master', icon: 'üëë', description: 'Complete 100 tasks' },
        6: { name: 'Early Adopter', icon: 'üöÄ', description: 'One of first 100 users' },
        7: { name: 'Token Collector', icon: 'üí∞', description: 'Earn 100 HLP tokens' },
        8: { name: 'Wealth Builder', icon: 'üíé', description: 'Earn 500 HLP tokens' },
        9: { name: 'Token Whale', icon: 'üêã', description: 'Earn 1000 HLP tokens' },
        10: { name: 'Community Builder', icon: 'üèóÔ∏è', description: 'Create 10 tasks' },
        11: { name: 'Mentor', icon: 'üë®‚Äçüè´', description: 'Have 10 tasks completed by others' },
        12: { name: 'Week Warrior', icon: '‚ö°', description: 'Complete tasks 7 days in a row' },
        13: { name: 'Monthly Champion', icon: 'üî•', description: 'Complete tasks 30 days in a row' },
        14: { name: 'Top Performer', icon: 'ü•á', description: 'Top 10 performer monthly' },
        15: { name: 'Helpful Reviewer', icon: 'ü§ù', description: 'Review/verify 50 tasks' }
    };

        // Function to detect MetaMask
        async function detectMetaMask() {
            if (typeof window.ethereum !== 'undefined') {
                return window.ethereum;
            }
            
            // Wait for MetaMask to load (up to 3 seconds)
            for (let i = 0; i < 30; i++) {
                await new Promise(resolve => setTimeout(resolve, 100));
                if (typeof window.ethereum !== 'undefined') {
                    return window.ethereum;
                }
            }
            
            return null;
        }

        // Function to suggest adding HLP Token to MetaMask
        async function suggestAddHLPToken() {
            if (!window.ethereum || !window.ethereum.isMetaMask) {
                console.log('MetaMask not available for token suggestion');
                return false;
            }

            try {
                // First check if token is already added by checking user balance
                const tokenContract = new ethers.Contract(REWARD_CONTRACT_ADDRESS, REWARD_CONTRACT_ABI, provider);
                const tokenName = await tokenContract.name();
                const tokenSymbol = await tokenContract.symbol();
                const tokenDecimals = await tokenContract.decimals();

                const wasAdded = await window.ethereum.request({
                    method: 'wallet_watchAsset',
                    params: {
                        type: 'ERC20',
                        options: {
                            address: REWARD_CONTRACT_ADDRESS,
                            symbol: tokenSymbol,
                            decimals: tokenDecimals,
                            image: 'https://raw.githubusercontent.com/Al3x-Myku/Antigel/main/assets/hlp-token-logo.png' // You can update this to your actual token logo URL
                        },
                    },
                });

                if (wasAdded) {
                    console.log(`‚úÖ ${tokenSymbol} token added to MetaMask successfully!`);
                    
                    // Show success notification
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-4 left-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center gap-2';
                    notification.innerHTML = `
                        <span class="material-symbols-outlined">account_balance_wallet</span>
                        <span>${tokenSymbol} token added to MetaMask!</span>
                    `;
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.remove();
                    }, 4000);
                    
                    return true;
                } else {
                    console.log(`‚ùå User declined to add ${tokenSymbol} token to MetaMask`);
                    return false;
                }
            } catch (error) {
                console.error('Error suggesting HLP token:', error);
                return false;
            }
        }

        // Function to suggest adding Achievement NFT to MetaMask
        async function suggestAddAchievementNFT() {
            if (!window.ethereum || !window.ethereum.isMetaMask) {
                console.log('MetaMask not available for NFT suggestion');
                return false;
            }

            try {
                const wasAdded = await window.ethereum.request({
                    method: 'wallet_watchAsset',
                    params: {
                        type: 'ERC721',
                        options: {
                            address: ACHIEVEMENT_CONTRACT_ADDRESS,
                            tokenId: '1', // You might want to use a dynamic token ID if user has badges
                        },
                    },
                });

                if (wasAdded) {
                    console.log('‚úÖ Achievement NFT collection added to MetaMask successfully!');
                    
                    // Show success notification
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-4 left-4 bg-purple-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center gap-2';
                    notification.innerHTML = `
                        <span class="material-symbols-outlined">emoji_events</span>
                        <span>Achievement NFTs added to MetaMask!</span>
                    `;
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.remove();
                    }, 4000);
                    
                    return true;
                } else {
                    console.log('‚ùå User declined to add Achievement NFT to MetaMask');
                    return false;
                }
            } catch (error) {
                console.error('Error suggesting Achievement NFT:', error);
                return false;
            }
        }

        // Function to suggest adding all tokens to MetaMask
        async function suggestAddTokensToMetaMask() {
            if (!window.ethereum || !window.ethereum.isMetaMask) {
                console.log('MetaMask not available for token suggestions');
                return;
            }

            // Wait a moment after connection to ensure everything is ready
            await new Promise(resolve => setTimeout(resolve, 1000));

            try {
                // Ask user if they want to add tokens
                const addTokens = confirm(
                    'ü™ô Add Tokens to MetaMask?\n\n' +
                    'Would you like to add HLP reward tokens and Achievement NFTs to your MetaMask wallet?\n\n' +
                    'This will make it easier to view your rewards and achievements directly in MetaMask.\n\n' +
                    'Click OK to add tokens, or Cancel to skip.'
                );

                if (!addTokens) {
                    console.log('User chose not to add tokens to MetaMask');
                    return;
                }

                // Add HLP Token
                console.log('Suggesting HLP Token...');
                await suggestAddHLPToken();

                // Wait a moment between suggestions
                await new Promise(resolve => setTimeout(resolve, 1500));

                // Add Achievement NFT Collection
                console.log('Suggesting Achievement NFTs...');
                await suggestAddAchievementNFT();

            } catch (error) {
                console.error('Error in token suggestion flow:', error);
            }
        }

        // Function to manually trigger token addition (can be called from UI buttons)
        async function addTokenToMetaMask(tokenType = 'HLP') {
            if (tokenType === 'HLP') {
                return await suggestAddHLPToken();
            } else if (tokenType === 'NFT') {
                return await suggestAddAchievementNFT();
            }
            return false;
        }

        // Login with MetaMask
        document.getElementById('loginButton').addEventListener('click', async () => {
            const ethereum = await detectMetaMask();
            
            if (!ethereum) {
                const installMetaMask = confirm(
                    'ü¶ä MetaMask Not Found!\n\n' +
                    'MetaMask extension is required to use this application.\n\n' +
                    'If you have MetaMask installed, please refresh the page.\n\n' +
                    'Click OK to visit MetaMask website for installation instructions.'
                );
                
                if (installMetaMask) {
                    window.open('https://metamask.io/download/', '_blank');
                }
                return;
            }

            // Check if MetaMask is the provider we want to use
            if (ethereum.isMetaMask) {
                window.ethereum = ethereum;
            }

            const loginBtn = document.getElementById('loginButton');
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<span class="material-symbols-outlined animate-pulse">progress_activity</span> Connecting...';

            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                // Check network - Sepolia chainId is 11155111
                const network = await provider.getNetwork();
                if (network.chainId !== 11155111) {
                    // Try to switch network automatically first
                    try {
                        loginBtn.innerHTML = '<span class="material-symbols-outlined animate-pulse">swap_horiz</span> Switching Network...';
                        
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0xaa36a7' }], // 11155111 in hex
                        });
                        
                        // Wait a moment for network switch to complete
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                        // Refresh provider and continue
                        provider = new ethers.providers.Web3Provider(window.ethereum);
                        signer = provider.getSigner();
                        
                    } catch (switchError) {
                        console.error('Network switch error:', switchError);
                        
                        let errorMessage = '‚ö†Ô∏è Wrong Network!\n\nPlease manually switch to Sepolia Testnet in MetaMask.';
                        
                        if (switchError.code === 4902) {
                            // Network not added to MetaMask, try to add it
                            try {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: '0xaa36a7',
                                        chainName: 'Sepolia Testnet',
                                        rpcUrls: ['https://sepolia.infura.io/v3/9aa3d95b3bc440fa88ea12eaa4456161'],
                                        nativeCurrency: {
                                            name: 'Sepolia ETH',
                                            symbol: 'SEP',
                                            decimals: 18
                                        },
                                        blockExplorerUrls: ['https://sepolia.etherscan.io/']
                                    }]
                                });
                                
                                // Try switching again after adding
                                await window.ethereum.request({
                                    method: 'wallet_switchEthereumChain',
                                    params: [{ chainId: '0xaa36a7' }]
                                });
                                
                                // Refresh and continue
                                provider = new ethers.providers.Web3Provider(window.ethereum);
                                signer = provider.getSigner();
                                
                            } catch (addError) {
                                console.error('Add network error:', addError);
                                errorMessage = '‚ö†Ô∏è Please add and switch to Sepolia Testnet manually in MetaMask settings.';
                            }
                        }
                        
                        if (switchError.code === 4001 || switchError.code === -32002) {
                            errorMessage = '‚ö†Ô∏è Network switch cancelled.\n\nPlease switch to Sepolia Testnet manually.';
                        }
                        
                        alert(errorMessage);
                        loginBtn.disabled = false;
                        loginBtn.innerHTML = '<span class="material-symbols-outlined">account_balance_wallet</span> Connect Wallet';
                        return;
                    }
                }
                
                taskContract = new ethers.Contract(TASK_CONTRACT_ADDRESS, TASK_CONTRACT_ABI, signer);
                rewardContract = new ethers.Contract(REWARD_CONTRACT_ADDRESS, REWARD_CONTRACT_ABI, signer);
                achievementContract = new ethers.Contract(ACHIEVEMENT_CONTRACT_ADDRESS, ACHIEVEMENT_CONTRACT_ABI, signer);

                loginBtn.innerHTML = '<span class="material-symbols-outlined animate-pulse">sync</span> Loading...';

                const balance = await provider.getBalance(userAddress);
                
                const shortAddr = userAddress.slice(0,6) + '...' + userAddress.slice(-4);
                document.getElementById('userAddress').textContent = shortAddr;
                
                // Format balance with better precision
                const formattedBalance = parseFloat(ethers.utils.formatEther(balance)).toFixed(4);
                document.getElementById('userBalance').textContent = formattedBalance + ' ETH';
                
                // Hide login screen, show main app
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');

                // Show success message briefly
                const successMsg = document.createElement('div');
                successMsg.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                successMsg.textContent = '‚úÖ Wallet connected successfully!';
                document.body.appendChild(successMsg);
                
                setTimeout(() => {
                    successMsg.remove();
                }, 3000);

                // Suggest adding tokens to MetaMask
                await suggestAddTokensToMetaMask();

                await loadTasks();
                await loadRewards();
                await loadAchievements();
            } catch (error) {
                console.error('Connection error:', error);
                
                let errorMsg = 'Failed to connect wallet';
                
                switch (error.code) {
                    case 4001:
                        errorMsg = 'Connection rejected.\n\nPlease approve the connection in MetaMask to continue.';
                        break;
                    case -32002:
                        errorMsg = 'Connection request pending.\n\nPlease check MetaMask extension and approve the pending request.';
                        break;
                    case 4100:
                        errorMsg = 'Unauthorized.\n\nPlease ensure you have an account connected in MetaMask.';
                        break;
                    case 4900:
                        errorMsg = 'Disconnected.\n\nMetaMask is disconnected from all chains.';
                        break;
                    default:
                        if (error.message) {
                            if (error.message.includes('User rejected')) {
                                errorMsg = 'Connection rejected by user.\n\nPlease try connecting again.';
                            } else if (error.message.includes('No Ethereum provider')) {
                                errorMsg = 'MetaMask not detected.\n\nPlease install MetaMask extension.';
                            } else {
                                errorMsg = error.message;
                            }
                        }
                        break;
                }
                
                alert('‚ùå ' + errorMsg);
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<span class="material-symbols-outlined">account_balance_wallet</span> Connect Wallet';
            }
        });

        // Add HLP Token to MetaMask
        document.getElementById('addHLPToken').addEventListener('click', async () => {
            const button = document.getElementById('addHLPToken');
            const originalContent = button.innerHTML;
            
            try {
                button.innerHTML = '<span class="material-symbols-outlined animate-pulse text-sm">sync</span>';
                button.disabled = true;
                
                const success = await addTokenToMetaMask('HLP');
                
                if (success) {
                    button.innerHTML = '<span class="material-symbols-outlined text-sm text-green-400">check</span>';
                    setTimeout(() => {
                        button.innerHTML = originalContent;
                        button.disabled = false;
                    }, 2000);
                } else {
                    button.innerHTML = '<span class="material-symbols-outlined text-sm text-red-400">close</span>';
                    setTimeout(() => {
                        button.innerHTML = originalContent;
                        button.disabled = false;
                    }, 2000);
                }
            } catch (error) {
                console.error('Error adding HLP token:', error);
                button.innerHTML = '<span class="material-symbols-outlined text-sm text-red-400">error</span>';
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.disabled = false;
                }, 2000);
            }
        });

        // Add NFT Collection to MetaMask
        document.getElementById('addNFTToken').addEventListener('click', async () => {
            const button = document.getElementById('addNFTToken');
            const originalContent = button.innerHTML;
            
            try {
                button.innerHTML = '<span class="material-symbols-outlined animate-pulse text-sm">sync</span>';
                button.disabled = true;
                
                const success = await addTokenToMetaMask('NFT');
                
                if (success) {
                    button.innerHTML = '<span class="material-symbols-outlined text-sm text-green-400">check</span>';
                    setTimeout(() => {
                        button.innerHTML = originalContent;
                        button.disabled = false;
                    }, 2000);
                } else {
                    button.innerHTML = '<span class="material-symbols-outlined text-sm text-red-400">close</span>';
                    setTimeout(() => {
                        button.innerHTML = originalContent;
                        button.disabled = false;
                    }, 2000);
                }
            } catch (error) {
                console.error('Error adding NFT collection:', error);
                button.innerHTML = '<span class="material-symbols-outlined text-sm text-red-400">error</span>';
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.disabled = false;
                }, 2000);
            }
        });

        // Mobile menu toggle
        document.getElementById('mobileMenuBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            const dropdown = document.getElementById('mobileDropdown');
            dropdown.classList.toggle('hidden');
        });

        // Close mobile dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('mobileDropdown');
            const menuBtn = document.getElementById('mobileMenuBtn');
            if (!dropdown.contains(e.target) && !menuBtn.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });

        // Mobile HLP Token button
        document.getElementById('mobileAddHLP').addEventListener('click', async () => {
            document.getElementById('mobileDropdown').classList.add('hidden');
            await addTokenToMetaMask('HLP');
        });

        // Mobile NFT Token button
        document.getElementById('mobileAddNFT').addEventListener('click', async () => {
            document.getElementById('mobileDropdown').classList.add('hidden');
            await addTokenToMetaMask('NFT');
        });

        // Mobile disconnect button
        document.getElementById('mobileDisconnect').addEventListener('click', () => {
            document.getElementById('mobileDropdown').classList.add('hidden');
            // Trigger the same disconnect logic
            document.getElementById('disconnectWallet').click();
        });

        // Disconnect Wallet
        document.getElementById('disconnectWallet').addEventListener('click', () => {
            // Clear state
            provider = null;
            signer = null;
            userAddress = null;
            taskContract = null;
            rewardContract = null;
            achievementContract = null;
            
            // Show login screen, hide main app
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        });

        // Create Task
        document.getElementById('createTaskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!taskContract) {
                alert('Please connect wallet first');
                return;
            }

            const description = document.getElementById('taskDescription').value;
            const rewardAmount = document.getElementById('rewardAmount').value;

            if (!description || !rewardAmount) {
                alert('Please fill in all fields');
                return;
            }

            const resultDiv = document.getElementById('createTaskResult');
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<span class="text-yellow-400">‚è≥ Creating task...</span>';

            try {
                const tx = await taskContract.createTask(description, rewardAmount);
                resultDiv.innerHTML = '<span class="text-blue-400">‚è≥ Waiting for confirmation...</span>';
                
                const receipt = await tx.wait();
                resultDiv.innerHTML = '<span class="text-green-400">‚úÖ Task created successfully!</span>';
                
                document.getElementById('createTaskForm').reset();
                setTimeout(() => {
                    loadTasks();
                    resultDiv.classList.add('hidden');
                }, 2000);
            } catch (error) {
                console.error('Create task error:', error);
                resultDiv.innerHTML = `<span class="text-red-400">‚ùå Error: ${error.message}</span>`;
            }
        });

        // Get applicants for a task
        async function getTaskApplicants(taskId) {
            try {
                const applicants = await taskContract.getTaskApplicants(taskId);
                return applicants;
            } catch (error) {
                console.error(`Error getting applicants for task ${taskId}:`, error);
                return [];
            }
        }

        // Load Tasks
        async function loadTasks() {
            if (!taskContract) return;

            try {
                const taskCount = await taskContract.getTasksCount();
                const taskListDiv = document.getElementById('taskList');
                
                if (taskCount.eq(0)) {
                    taskListDiv.innerHTML = '<p class="text-gray-400 text-center py-8">No tasks yet. Create the first one!</p>';
                    return;
                }

                taskListDiv.innerHTML = '';
                
                for (let i = 1; i <= taskCount.toNumber(); i++) {
                    try {
                        const task = await taskContract.getTask(i);
                        const currentTaskId = i; // Store the actual task ID
                        
                        // Check if current user has applied for this task
                        let hasApplied = false;
                        try {
                            hasApplied = await taskContract.hasApplied(currentTaskId, userAddress);
                        } catch (err) {
                            console.log(`Could not check application status for task ${currentTaskId}`);
                        }

                        // Get applicants for this specific task
                        const applicants = await getTaskApplicants(currentTaskId);
                        console.log(`Task ${currentTaskId} has ${applicants.length} applicants:`, applicants);
                        
                        const taskCard = document.createElement('div');
                        taskCard.className = 'bg-gray-700/50 rounded-lg p-4 border border-gray-600 hover:border-primary transition';
                        
                        let statusBadges = '';
                        
                        if (task.completed) {
                            statusBadges = '<span class="bg-green-600 text-xs px-2 py-1 rounded-full">Completed</span>';
                        } else if (task.worker !== ethers.constants.AddressZero) {
                            if (task.worker.toLowerCase() === userAddress.toLowerCase()) {
                                statusBadges = '<span class="bg-purple-600 text-xs px-2 py-1 rounded-full">Assigned to You</span>';
                            } else {
                                statusBadges = '<span class="bg-yellow-500 text-xs px-2 py-1 rounded-full">Assigned</span>';
                            }
                        } else {
                            statusBadges = '<span class="bg-blue-600 text-xs px-2 py-1 rounded-full">Open</span>';
                            if (hasApplied) {
                                statusBadges += ' <span class="bg-orange-600 text-xs px-2 py-1 rounded-full ml-1">Applied</span>';
                            }
                        }
                        
                        // Check if user is the creator
                        const isCreator = task.creator.toLowerCase() === userAddress.toLowerCase();
                        if (isCreator) {
                            statusBadges += ' <span class="bg-indigo-600 text-xs px-2 py-1 rounded-full ml-1">Your Task</span>';
                        }

                        // Show applicant count
                        if (applicants.length > 0 && !task.completed) {
                            statusBadges += ` <span class="bg-cyan-600 text-xs px-2 py-1 rounded-full ml-1">${applicants.length} Applicant${applicants.length > 1 ? 's' : ''}</span>`;
                        }

                        // Create applicants section
                        let applicantsSection = '';
                        if (applicants.length > 0) {
                            applicantsSection = `
                                <div class="mt-3 pt-3 border-t border-gray-600">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-xs font-semibold text-gray-300">Applicants (${applicants.length})</span>
                                        <button onclick="toggleApplicants(${currentTaskId})" class="text-xs text-primary hover:underline">
                                            <span id="toggle-${currentTaskId}">Show</span>
                                        </button>
                                    </div>
                                    <div id="applicants-${currentTaskId}" class="hidden space-y-2">
                                        ${applicants.map((applicant, index) => `
                                            <div class="flex flex-col bg-gray-800/50 rounded p-2 space-y-1">
                                                <div class="flex items-center justify-between">
                                                    <div class="text-xs">
                                                        <span class="text-white font-mono break-all">${applicant}</span>
                                                        ${applicant.toLowerCase() === userAddress.toLowerCase() ? 
                                                            '<span class="text-orange-400 ml-2 font-bold">(You)</span>' : ''}
                                                    </div>
                                                    ${isCreator && task.worker === ethers.constants.AddressZero ? 
                                                        `<button onclick="quickAssign(${currentTaskId}, '${applicant}')" 
                                                            class="text-xs bg-primary hover:bg-primary/80 text-white px-3 py-1 rounded ml-2 flex-shrink-0">
                                                            Assign
                                                        </button>` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }
                        
                        taskCard.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-semibold text-lg text-white">Task #${currentTaskId}</h3>
                                <div class="flex flex-wrap gap-1">
                                    ${statusBadges}
                                </div>
                            </div>
                            <p class="text-sm text-gray-300 mb-3">${task.description}</p>
                            <div class="text-xs text-gray-400 space-y-1">
                                <p>Creator: <span class="font-mono text-white">${task.creator}</span></p>
                                ${task.worker !== ethers.constants.AddressZero ? `<p>Worker: <span class="font-mono text-white">${task.worker}</span></p>` : '<p>Worker: Not assigned</p>'}
                                <p class="text-primary font-semibold">Reward: ${task.reward} HLP</p>
                            </div>
                            ${applicantsSection}
                        `;
                        taskListDiv.appendChild(taskCard);
                    } catch (err) {
                        console.log(`Task ${i} not found or deleted`);
                    }
                }
            } catch (error) {
                console.error('Load tasks error:', error);
            }
        }

        // Apply for Task
        document.getElementById('applyTaskBtn').addEventListener('click', async () => {
            if (!taskContract) {
                alert('Please connect wallet first');
                return;
            }

            const taskId = document.getElementById('applyTaskId').value;
            const resultDiv = document.getElementById('applyResult');
            
            if (!taskId) {
                alert('Please enter a task ID');
                return;
            }

            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<span class="text-yellow-400">‚è≥ Checking application status...</span>';

            try {
                // First, check if user has already applied
                const hasAlreadyApplied = await taskContract.hasApplied(taskId, userAddress);
                
                if (hasAlreadyApplied) {
                    resultDiv.innerHTML = '<span class="text-blue-400">‚ÑπÔ∏è You have already applied for this task</span>';
                    setTimeout(() => {
                        resultDiv.classList.add('hidden');
                    }, 3000);
                    return;
                }

                // Check if task exists and get task details
                try {
                    const task = await taskContract.getTask(taskId);
                    
                    if (task.completed) {
                        resultDiv.innerHTML = '<span class="text-gray-400">‚ÑπÔ∏è This task is already completed</span>';
                        setTimeout(() => {
                            resultDiv.classList.add('hidden');
                        }, 3000);
                        return;
                    }

                    if (task.worker !== ethers.constants.AddressZero) {
                        resultDiv.innerHTML = '<span class="text-orange-400">‚ÑπÔ∏è This task is already assigned to someone</span>';
                        setTimeout(() => {
                            resultDiv.classList.add('hidden');
                        }, 3000);
                        return;
                    }

                    if (task.creator.toLowerCase() === userAddress.toLowerCase()) {
                        resultDiv.innerHTML = '<span class="text-red-400">‚ùå You cannot apply for your own task</span>';
                        setTimeout(() => {
                            resultDiv.classList.add('hidden');
                        }, 3000);
                        return;
                    }

                } catch (taskError) {
                    resultDiv.innerHTML = '<span class="text-red-400">‚ùå Task not found or invalid task ID</span>';
                    setTimeout(() => {
                        resultDiv.classList.add('hidden');
                    }, 3000);
                    return;
                }

                resultDiv.innerHTML = '<span class="text-yellow-400">‚è≥ Submitting application...</span>';
                
                const tx = await taskContract.applyForTask(taskId);
                resultDiv.innerHTML = '<span class="text-blue-400">‚è≥ Confirming transaction...</span>';
                await tx.wait();
                resultDiv.innerHTML = '<span class="text-green-400">‚úÖ Applied successfully!</span>';
                
                // Clear the input field
                document.getElementById('applyTaskId').value = '';
                
                setTimeout(() => {
                    loadTasks();
                    resultDiv.classList.add('hidden');
                }, 2000);
                
            } catch (error) {
                console.error('Apply error:', error);
                
                let errorMessage = 'Failed to apply for task';
                
                if (error.message) {
                    if (error.message.includes('Already applied for this task')) {
                        errorMessage = 'You have already applied for this task';
                    } else if (error.message.includes('Task does not exist')) {
                        errorMessage = 'Task not found - please check the task ID';
                    } else if (error.message.includes('Task is completed')) {
                        errorMessage = 'This task is already completed';
                    } else if (error.message.includes('Task is already assigned')) {
                        errorMessage = 'This task is already assigned to someone';
                    } else if (error.message.includes('user rejected')) {
                        errorMessage = 'Transaction cancelled by user';
                    } else if (error.message.includes('insufficient funds')) {
                        errorMessage = 'Insufficient funds for transaction';
                    } else {
                        errorMessage = error.message;
                    }
                }
                
                resultDiv.innerHTML = `<span class="text-red-400">‚ùå ${errorMessage}</span>`;
                
                setTimeout(() => {
                    resultDiv.classList.add('hidden');
                }, 5000);
            }
        });

        // Assign Task
        document.getElementById('assignTaskBtn').addEventListener('click', async () => {
            if (!taskContract) {
                alert('Please connect wallet first');
                return;
            }

            const taskId = document.getElementById('assignTaskId').value;
            const workerAddress = document.getElementById('assignWorkerAddress').value;
            const resultDiv = document.getElementById('assignResult');
            
            if (!taskId || !workerAddress) {
                alert('Please enter task ID and worker address');
                return;
            }

            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<span class="text-yellow-400">‚è≥ Assigning task...</span>';

            try {
                const tx = await taskContract.assignTask(taskId, workerAddress);
                resultDiv.innerHTML = '<span class="text-blue-400">‚è≥ Confirming...</span>';
                await tx.wait();
                resultDiv.innerHTML = '<span class="text-green-400">‚úÖ Task assigned!</span>';
                setTimeout(() => {
                    loadTasks();
                    resultDiv.classList.add('hidden');
                }, 2000);
            } catch (error) {
                console.error('Assign error:', error);
                resultDiv.innerHTML = `<span class="text-red-400">‚ùå ${error.message}</span>`;
            }
        });

        // Complete Task
        document.getElementById('completeTaskBtn').addEventListener('click', async () => {
            if (!taskContract) {
                alert('Please connect wallet first');
                return;
            }

            const taskId = document.getElementById('completeTaskId').value;
            const resultDiv = document.getElementById('completeResult');
            
            if (!taskId) {
                alert('Please enter a task ID');
                return;
            }

            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<span class="text-yellow-400">‚è≥ Completing task and minting rewards...</span>';

            try {
                const tx = await taskContract.completeTask(taskId);
                resultDiv.innerHTML = '<span class="text-blue-400">‚è≥ Confirming...</span>';
                await tx.wait();
                resultDiv.innerHTML = '<span class="text-green-400">‚úÖ Task completed & rewards minted!</span>';
                setTimeout(() => {
                    loadTasks();
                    loadRewards();
                    loadAchievements();
                    resultDiv.classList.add('hidden');
                }, 2000);
            } catch (error) {
                console.error('Complete error:', error);
                resultDiv.innerHTML = `<span class="text-red-400">‚ùå ${error.message}</span>`;
            }
        });

        // Cancel Task
        document.getElementById('cancelTaskBtn').addEventListener('click', async () => {
            if (!taskContract) {
                alert('Please connect wallet first');
                return;
            }

            const taskId = document.getElementById('cancelTaskId').value;
            const resultDiv = document.getElementById('cancelResult');
            
            if (!taskId) {
                alert('Please enter a task ID');
                return;
            }

            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<span class="text-yellow-400">‚è≥ Cancelling task...</span>';

            try {
                const tx = await taskContract.cancelTask(taskId);
                resultDiv.innerHTML = '<span class="text-blue-400">‚è≥ Confirming...</span>';
                await tx.wait();
                resultDiv.innerHTML = '<span class="text-green-400">‚úÖ Task cancelled!</span>';
                setTimeout(() => {
                    loadTasks();
                    resultDiv.classList.add('hidden');
                }, 2000);
            } catch (error) {
                console.error('Cancel error:', error);
                resultDiv.innerHTML = `<span class="text-red-400">‚ùå ${error.message}</span>`;
            }
        });

        // Load Rewards
        async function loadRewards() {
            if (!rewardContract || !userAddress) return;

            try {
                const balance = await rewardContract.balanceOf(userAddress);
                const rewardListDiv = document.getElementById('rewardsList');
                
                // Show the MetaMask helper info
                const helperDiv = document.getElementById('metamaskTokenHelper');
                if (helperDiv) {
                    helperDiv.classList.remove('hidden');
                }
                
                rewardListDiv.innerHTML = `
                    <div class="bg-gray-700/50 rounded-lg p-6 text-center border border-gray-600">
                        <h3 class="text-3xl font-bold text-primary mb-2">${balance}</h3>
                        <p class="text-gray-400">HLP Tokens</p>
                    </div>
                `;
            } catch (error) {
                console.error('Load rewards error:', error);
            }
        }

        // Load Achievements
        async function loadAchievements() {
            if (!achievementContract || !userAddress) return;

            try {
                // Load user stats
                const stats = await achievementContract.getUserStats(userAddress);
                const statsDiv = document.getElementById('userStats');
                
                statsDiv.innerHTML = `
                    <div class="bg-gray-700/50 rounded-lg p-4 text-center border border-gray-600">
                        <h3 class="text-2xl font-bold text-blue-400 mb-1">${stats._tasksCompleted}</h3>
                        <p class="text-xs text-gray-400">Tasks Completed</p>
                    </div>
                    <div class="bg-gray-700/50 rounded-lg p-4 text-center border border-gray-600">
                        <h3 class="text-2xl font-bold text-green-400 mb-1">${stats._tokensEarned}</h3>
                        <p class="text-xs text-gray-400">Tokens Earned</p>
                    </div>
                    <div class="bg-gray-700/50 rounded-lg p-4 text-center border border-gray-600">
                        <h3 class="text-2xl font-bold text-purple-400 mb-1">${stats._tasksCreated}</h3>
                        <p class="text-xs text-gray-400">Tasks Created</p>
                    </div>
                    <div class="bg-gray-700/50 rounded-lg p-4 text-center border border-gray-600">
                        <h3 class="text-2xl font-bold text-orange-400 mb-1">${stats._currentStreak}</h3>
                        <p class="text-xs text-gray-400">Current Streak</p>
                    </div>
                    <div class="bg-gray-700/50 rounded-lg p-4 text-center border border-gray-600">
                        <h3 class="text-2xl font-bold text-yellow-400 mb-1">${stats._maxStreak}</h3>
                        <p class="text-xs text-gray-400">Max Streak</p>
                    </div>
                `;

                // Load user badges
                const badgeIds = await achievementContract.getUserBadges(userAddress);
                const achievementsDiv = document.getElementById('achievementsList');
                
                if (badgeIds.length === 0) {
                    achievementsDiv.innerHTML = `
                        <div class="col-span-4 text-center py-8 text-gray-400">
                            <div class="text-6xl mb-4">üéØ</div>
                            <p class="text-lg mb-2">No achievements yet!</p>
                            <p class="text-sm">Complete tasks to earn your first badge</p>
                        </div>
                    `;
                    return;
                }

                achievementsDiv.innerHTML = '';
                
                for (const tokenId of badgeIds) {
                    try {
                        const badge = await achievementContract.badges(tokenId);
                        const rarityColors = {
                            1: 'border-gray-500 bg-gray-600/20',      // Common
                            2: 'border-blue-500 bg-blue-600/20',     // Rare  
                            3: 'border-purple-500 bg-purple-600/20', // Epic
                            4: 'border-yellow-500 bg-yellow-600/20'  // Legendary
                        };
                        
                        const rarityNames = {
                            1: 'Common',
                            2: 'Rare', 
                            3: 'Epic',
                            4: 'Legendary'
                        };

                        const badgeCard = document.createElement('div');
                        badgeCard.className = `rounded-lg p-4 border-2 ${rarityColors[badge.rarity] || rarityColors[1]} transition hover:scale-105 cursor-pointer`;
                        
                        const mintDate = new Date(badge.mintedAt * 1000).toLocaleDateString();
                        const achievementInfo = achievementTypes[badge.achievementType] || { name: badge.title, icon: 'üèÜ', description: badge.description };
                        
                        badgeCard.innerHTML = `
                            <div class="text-center">
                                <div class="text-4xl mb-3">${achievementInfo.icon}</div>
                                <h4 class="text-white font-bold text-sm mb-1">${achievementInfo.name}</h4>
                                <p class="text-xs text-gray-300 mb-2">${achievementInfo.description}</p>
                                <div class="flex justify-between items-center text-xs">
                                    <span class="text-${badge.rarity === 4 ? 'yellow' : badge.rarity === 3 ? 'purple' : badge.rarity === 2 ? 'blue' : 'gray'}-400 font-semibold">
                                        ${rarityNames[badge.rarity]}
                                    </span>
                                    <span class="text-gray-500">${mintDate}</span>
                                </div>
                            </div>
                        `;
                        
                        // Add click event to show badge details
                        badgeCard.addEventListener('click', () => {
                            alert(`üèÜ ${achievementInfo.name}\n\n${achievementInfo.description}\n\nRarity: ${rarityNames[badge.rarity]}\nEarned: ${mintDate}\nToken ID: #${tokenId}`);
                        });
                        
                        achievementsDiv.appendChild(badgeCard);
                    } catch (error) {
                        console.error(`Error loading badge ${tokenId}:`, error);
                    }
                }

            } catch (error) {
                console.error('Load achievements error:', error);
                document.getElementById('achievementsList').innerHTML = `
                    <div class="col-span-4 text-center py-8 text-red-400">
                        <p>Error loading achievements</p>
                    </div>
                `;
            }
        }

        // Toggle applicants visibility
        function toggleApplicants(taskId) {
            const applicantsDiv = document.getElementById(`applicants-${taskId}`);
            const toggleBtn = document.getElementById(`toggle-${taskId}`);
            
            if (applicantsDiv.classList.contains('hidden')) {
                applicantsDiv.classList.remove('hidden');
                toggleBtn.textContent = 'Hide';
            } else {
                applicantsDiv.classList.add('hidden');
                toggleBtn.textContent = 'Show';
            }
        }

        // Quick assign function
        async function quickAssign(taskId, workerAddress) {
            if (!taskContract) {
                alert('Please connect wallet first');
                return;
            }

            try {
                const confirmed = confirm(`Assign Task #${taskId} to ${workerAddress.slice(0, 6)}...${workerAddress.slice(-4)}?`);
                if (!confirmed) return;

                const tx = await taskContract.assignTask(taskId, workerAddress);
                
                // Show loading notification
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                notification.textContent = '‚è≥ Assigning task...';
                document.body.appendChild(notification);
                
                await tx.wait();
                
                notification.textContent = '‚úÖ Task assigned successfully!';
                notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                
                setTimeout(() => {
                    notification.remove();
                    loadTasks();
                }, 2000);
                
            } catch (error) {
                console.error('Quick assign error:', error);
                
                let errorMessage = 'Failed to assign task';
                if (error.message.includes('user rejected')) {
                    errorMessage = 'Assignment cancelled by user';
                } else if (error.message.includes('insufficient funds')) {
                    errorMessage = 'Insufficient funds for transaction';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                alert(`‚ùå ${errorMessage}`);
            }
        }

        // Make functions globally available
        window.toggleApplicants = toggleApplicants;
        window.quickAssign = quickAssign;

        // Refresh Tasks
        document.getElementById('refreshTasks').addEventListener('click', () => {
            loadTasks();
            loadRewards();
            loadAchievements();
        });

        // Check if already connected on page load
        window.addEventListener('load', async () => {
            // Wait a moment for extensions to load
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const ethereum = await detectMetaMask();
            if (ethereum) {
                try {
                    const accounts = await ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        console.log('Auto-connecting to existing wallet connection...');
                        // Auto-login if already connected
                        document.getElementById('loginButton').click();
                    }
                } catch (error) {
                    console.log('No existing wallet connection found');
                }
            }
        });

        // Setup event listeners for MetaMask
        async function setupMetaMaskListeners() {
            const ethereum = await detectMetaMask();
            if (ethereum) {
                ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        // User disconnected
                        console.log('User disconnected wallet');
                        document.getElementById('disconnectWallet').click();
                    } else if (userAddress && accounts[0] !== userAddress) {
                        // Account changed
                        console.log('Account changed from', userAddress, 'to', accounts[0]);
                        
                        // Show notification
                        const notification = document.createElement('div');
                        notification.className = 'fixed top-4 right-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                        notification.textContent = 'üîÑ Account changed, reloading...';
                        document.body.appendChild(notification);
                        
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    }
                });

                ethereum.on('chainChanged', (chainId) => {
                    console.log('Network changed to:', chainId);
                    
                    // Show notification
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-4 right-4 bg-orange-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                    notification.textContent = 'üåê Network changed, reloading...';
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                });
            }
        }

        // Initialize event listeners
        setupMetaMaskListeners();
    </script>

</body>
</html>
