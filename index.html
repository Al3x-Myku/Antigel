<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SideQuests ¬∑ Community Task Manager</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#1337ec",
                        "background-light": "#f6f6f8",
                        "background-dark": "#101322",
                    },
                    fontFamily: {
                        display: ["Space Grotesk", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: "1rem",
                        lg: "2rem",
                        xl: "3rem",
                        full: "9999px",
                    },
                },
            },
        };
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }
        body { font-family: 'Space Grotesk', sans-serif; }
    </style>
    <meta name="color-scheme" content="dark light" />
    <meta name="theme-color" content="#101322" />
</head>
<body class="bg-background-light dark:bg-background-dark text-[#9da1b9] min-h-screen">

    <!-- Login Screen (shown until wallet connected) -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center px-4">
        <div class="w-full max-w-xl bg-white/5 border border-white/10 rounded-lg p-8 text-center backdrop-blur-sm">
            <div class="mx-auto mb-6 size-12 text-primary">
                <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                    <path d="M24 45.8096C19.6865 45.8096 15.4698 44.5305 11.8832 42.134C8.29667 39.7376 5.50128 36.3314 3.85056 32.3462C2.19985 28.361 1.76794 23.9758 2.60947 19.7452C3.451 15.5145 5.52816 11.6284 8.57829 8.5783C11.6284 5.52817 15.5145 3.45101 19.7452 2.60948C23.9758 1.76795 28.361 2.19986 32.3462 3.85057C36.3314 5.50129 39.7376 8.29668 42.134 11.8833C44.5305 15.4698 45.8096 19.6865 45.8096 24L24 24L24 45.8096Z" fill="currentColor"></path>
                </svg>
            </div>
            <h1 class="text-white text-3xl font-black mb-2 tracking-tight">SideQuests</h1>
            <p class="text-sm mb-6">Connect your wallet on Sepolia to create and complete quests.</p>
            <button id="loginButton" class="flex w-full items-center justify-center gap-3 h-12 rounded-full bg-primary text-white font-bold">
                <span class="material-symbols-outlined">account_balance_wallet</span>
                Connect Wallet
            </button>
            <div class="mt-6 p-4 bg-white/5 border border-white/10 rounded-lg text-left text-sm">
                <p class="mb-1">Network: <span class="text-white font-semibold">Sepolia Testnet</span></p>
                <a class="text-primary hover:underline" href="https://sepoliafaucet.com/" target="_blank" rel="noreferrer">Get Sepolia ETH</a>
            </div>
        </div>
    </div>

    <!-- Main App (hidden until logged in) -->
    <div id="mainApp" class="hidden flex min-h-screen flex-col">
        <!-- Header -->
        <header class="sticky top-0 z-50 flex items-center justify-between whitespace-nowrap border-b border-white/10 px-4 sm:px-8 md:px-10 py-3 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm">
            <div class="flex items-center gap-4 text-white">
                <div class="size-6 text-primary">
                    <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                        <path d="M24 45.8096C19.6865 45.8096 15.4698 44.5305 11.8832 42.134C8.29667 39.7376 5.50128 36.3314 3.85056 32.3462C2.19985 28.361 1.76794 23.9758 2.60947 19.7452C3.451 15.5145 5.52816 11.6284 8.57829 8.5783C11.6284 5.52817 15.5145 3.45101 19.7452 2.60948C23.9758 1.76795 28.361 2.19986 32.3462 3.85057C36.3314 5.50129 39.7376 8.29668 42.134 11.8833C44.5305 15.4698 45.8096 19.6865 45.8096 24L24 24L24 45.8096Z" fill="currentColor"></path>
                    </svg>
                </div>
                <h2 class="text-white text-lg font-bold leading-tight tracking-[-0.015em]">SideQuests</h2>
            </div>
            <div class="hidden lg:flex flex-1 justify-center gap-8">
                <div class="flex items-center gap-9">
                    <a class="text-white/80 hover:text-white transition-colors text-sm font-medium leading-normal" href="#">Dashboard</a>
                    <a class="text-white text-sm font-medium leading-normal" href="#">Quests</a>
                    <a class="text-white/80 hover:text-white transition-colors text-sm font-medium leading-normal" href="#">Communities</a>
                    <a class="text-white/80 hover:text-white transition-colors text-sm font-medium leading-normal" href="#">Rewards</a>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <div class="hidden sm:flex items-center gap-2 mr-2">
                    <span class="hidden md:inline text-xs text-white/70">Addr:</span>
                    <span id="userAddress" class="text-white/90 text-xs font-mono truncate max-w-[180px]"></span>
                    <span class="mx-1 text-white/20">‚Ä¢</span>
                    <span id="userBalance" class="text-white/90 text-xs font-mono"></span>
                </div>
                <button id="disconnectWallet" class="hidden sm:flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-white/10 hover:bg-white/20 text-white text-sm font-bold leading-normal tracking-[0.015em]">
                    <span class="truncate">Disconnect</span>
                </button>
                <button class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 bg-white/10 hover:bg-white/20 text-white gap-2 text-sm font-bold leading-normal tracking-[0.015em] min-w-0 px-2.5">
                    <span class="material-symbols-outlined text-xl">notifications</span>
                </button>
                <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuAM3aqSFMwPhnnBGZw35sWWb_mzWAExLvlRpTKGDk4WoqIvRAI_a5O7Z121wCafikJL8-1R-VB0_H-fQupjEcz6NoIyc6faF5WO1StgIyQNl6tILG9ZRodpx_X9A1aFLCCAP7amTRVKRPgjZDc_NdVDzXsOhSCsG8nEy_yhNuaNQ6qnMTve7PPiiqnGFgq1mkjqRjQ22R-y8XB7UShaIwhbuj-286aPfMOxzMPj6valE0QfO70PtIYoPfN56m59MRCK1XxyC3-3");'></div>
            </div>
        </header>

        <main class="flex-1 px-4 sm:px-8 md:px-10 py-8 lg:py-12">
            <div class="max-w-7xl mx-auto">
                <div class="flex flex-wrap gap-2 mb-4">
                    <a class="hover:text-white transition-colors text-sm font-medium leading-normal" href="#">Web3 Community</a>
                    <span class="text-sm font-medium leading-normal">/</span>
                    <a class="hover:text-white transition-colors text-sm font-medium leading-normal" href="#">Quests</a>
                    <span class="text-sm font-medium leading-normal">/</span>
                    <span class="text-white text-sm font-medium leading-normal">Create Quest</span>
                </div>
                <div class="flex flex-wrap justify-between items-center gap-3 mb-8">
                    <p class="text-white text-4xl font-black leading-tight tracking-[-0.033em] min-w-72">Create a New Quest</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:gap-12 items-start">
                    <!-- Left: Create form -->
                    <div class="lg:col-span-2 flex flex-col gap-8">
                        <!-- The Basics -->
                        <div class="bg-background-light dark:bg-white/5 border border-transparent dark:border-white/10 rounded-lg p-6">
                            <h3 class="text-white text-lg font-bold leading-tight tracking-[-0.015em] mb-6">The Basics</h3>
                            <form id="createTaskForm" class="flex flex-col gap-6">
                                <label class="flex flex-col">
                                    <p class="text-white text-base font-medium leading-normal pb-2">Quest Metadata URI</p>
                                    <input id="taskMetadata" placeholder="ipfs://Qm..." class="form-input h-12 bg-[#1c1d27] border-[#3b3f54] focus:border-primary focus:ring-primary/50 text-white rounded px-4" />
                                    <span class="text-xs text-white/50 pt-2">Store your quest description on IPFS and paste the URI.</span>
                                </label>

                                <!-- Details & Rewards -->
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                    <label class="flex flex-col">
                                        <p class="text-white text-base font-medium leading-normal pb-2">Reward Amount</p>
                                        <div class="relative">
                                            <input id="rewardAmount" type="number" value="100" placeholder="100" class="form-input h-12 w-full bg-[#1c1d27] border-[#3b3f54] focus:border-primary focus:ring-primary/50 text-white rounded pl-4 pr-16" />
                                            <div class="absolute inset-y-0 right-0 flex items-center pr-4 pointer-events-none">
                                                <span class="text-white font-bold">$HELP</span>
                                            </div>
                                        </div>
                                        <span class="text-xs text-white/50 pt-2">Amount in tokens for fungible rewards.</span>
                                    </label>
                                    <label class="flex flex-col">
                                        <p class="text-white text-base font-medium leading-normal pb-2">Reward Token ID</p>
                                        <input id="rewardId" type="number" value="0" placeholder="0 (Community Token)" class="form-input h-12 bg-[#1c1d27] border-[#3b3f54] focus:border-primary focus:ring-primary/50 text-white rounded px-4" />
                                        <span class="text-xs text-white/50 pt-2">0 = Community Token, 1+ = NFT Badges.</span>
                                    </label>
                                </div>

                                <div id="createTaskResult" class="hidden mt-1 p-3 rounded bg-white/5 border border-white/10 text-sm"></div>

                                <!-- Submit is handled in sticky footer too; keep an in-form button for accessibility -->
                                <div>
                                    <button type="submit" class="flex w-full items-center justify-center gap-2 h-12 rounded-full bg-primary hover:brightness-110 text-white font-bold">
                                        <span class="material-symbols-outlined">send</span>
                                        Create Task
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Task Actions -->
                        <div class="bg-background-light dark:bg-white/5 border border-transparent dark:border-white/10 rounded-lg p-6">
                            <h3 class="text-white text-lg font-bold leading-tight tracking-[-0.015em] mb-6">Task Actions</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <!-- Claim Task -->
                                <div class="flex flex-col gap-2">
                                    <label class="text-white text-sm">Claim Task</label>
                                    <div class="flex gap-2">
                                        <input id="claimTaskId" type="number" placeholder="Task ID" class="form-input h-12 flex-1 bg-[#1c1d27] border-[#3b3f54] focus:border-primary focus:ring-primary/50 text-white rounded px-3" />
                                        <button id="claimTaskBtn" class="h-12 px-4 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-bold">Claim</button>
                                    </div>
                                    <div id="claimResult" class="hidden text-xs"></div>
                                </div>
                                <!-- Complete Task -->
                                <div class="flex flex-col gap-2">
                                    <label class="text-white text-sm">Complete Task</label>
                                    <div class="flex gap-2">
                                        <input id="completeTaskId" type="number" placeholder="Task ID" class="form-input h-12 flex-1 bg-[#1c1d27] border-[#3b3f54] focus:border-primary focus:ring-primary/50 text-white rounded px-3" />
                                        <button id="completeTaskBtn" class="h-12 px-4 rounded-lg bg-yellow-500 hover:bg-yellow-400 text-white font-bold">Complete</button>
                                    </div>
                                    <div id="completeResult" class="hidden text-xs"></div>
                                </div>
                                <!-- Verify & Reward -->
                                <div class="flex flex-col gap-2">
                                    <label class="text-white text-sm">Verify & Reward</label>
                                    <div class="flex gap-2">
                                        <input id="verifyTaskId" type="number" placeholder="Task ID" class="form-input h-12 flex-1 bg-[#1c1d27] border-[#3b3f54] focus:border-primary focus:ring-primary/50 text-white rounded px-3" />
                                        <button id="verifyTaskBtn" class="h-12 px-4 rounded-lg bg-green-600 hover:bg-green-500 text-white font-bold">Verify</button>
                                    </div>
                                    <div id="verifyResult" class="hidden text-xs"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Task list -->
                    <div class="lg:col-span-1 lg:sticky top-28">
                        <div class="bg-background-light dark:bg-white/5 border border-transparent dark:border-white/10 rounded-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-white text-lg font-bold leading-tight tracking-[-0.015em]">Task List</h3>
                                <button id="refreshTasks" class="h-9 px-3 rounded-full bg-white/10 hover:bg-white/20 text-white text-sm font-medium">Refresh</button>
                            </div>
                            <div id="taskList" class="space-y-3 max-h-[28rem] overflow-y-auto">
                                <p class="text-center py-8">Connect wallet to view tasks</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- My Rewards -->
                <div class="mt-8 bg-background-light dark:bg-white/5 border border-transparent dark:border-white/10 rounded-lg p-6">
                    <h3 class="text-white text-lg font-bold leading-tight tracking-[-0.015em] mb-4">My Rewards</h3>
                    <div id="rewardsList" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <p class="text-center py-8 col-span-3">Connect wallet to view rewards</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer actions -->
        <footer class="sticky bottom-0 z-40 mt-auto bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm border-t border-white/10 py-4">
            <div class="max-w-7xl mx-auto px-4 sm:px-8 md:px-10 flex items-center justify-end gap-4">
                <button class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-6 bg-white/10 hover:bg-white/20 text-white text-base font-bold">
                    <span class="truncate">Save as Draft</span>
                </button>
                <button type="submit" form="createTaskForm" class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-6 bg-primary text-white text-base font-bold gap-2">
                    <span class="truncate">Publish Quest</span>
                    <span class="material-symbols-outlined">arrow_forward</span>
                </button>
            </div>
        </footer>
    </div>

    <script>
        // Contract addresses and ABIs from deployment.json
        const REWARD_CONTRACT_ADDRESS = "0x8a564BdbbbD1Faf313a3380B10d373c1e2622167";
        const TASK_CONTRACT_ADDRESS = "0xa564E0967A252E813051Cb278BF84fE567617D2E";
        
        const TASK_CONTRACT_ABI = [{"inputs":[{"internalType":"address","name":"_rewardContractAddress","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":true,"internalType":"address","name":"completer","type":"address"}],"name":"TaskClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":true,"internalType":"address","name":"completer","type":"address"}],"name":"TaskCompleted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":true,"internalType":"address","name":"creator","type":"address"},{"indexed":false,"internalType":"string","name":"metadataURI","type":"string"}],"name":"TaskCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":true,"internalType":"address","name":"verifier","type":"address"}],"name":"TaskVerified","type":"event"},{"inputs":[{"internalType":"uint256","name":"_taskId","type":"uint256"}],"name":"claimTask","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_taskId","type":"uint256"}],"name":"completeTask","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_metadataURI","type":"string"},{"internalType":"uint256[]","name":"_rewardIds","type":"uint256[]"},{"internalType":"uint256[]","name":"_rewardAmounts","type":"uint256[]"}],"name":"createTask","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_taskId","type":"uint256"}],"name":"getTask","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"creator","type":"address"},{"internalType":"address","name":"completer","type":"address"},{"internalType":"string","name":"metadataURI","type":"string"},{"internalType":"enum TaskContract.TaskStatus","name":"status","type":"uint8"},{"internalType":"uint256[]","name":"rewardIds","type":"uint256[]"},{"internalType":"uint256[]","name":"rewardAmounts","type":"uint256[]"}],"internalType":"struct TaskContract.Task","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"rewardContract","outputs":[{"internalType":"contract IRewardContract","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"taskCounter","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"tasks","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"creator","type":"address"},{"internalType":"address","name":"completer","type":"address"},{"internalType":"string","name":"metadataURI","type":"string"},{"internalType":"enum TaskContract.TaskStatus","name":"status","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_taskId","type":"uint256"}],"name":"verifyTask","outputs":[],"stateMutability":"nonpayable","type":"function"}];
        
        const REWARD_CONTRACT_ABI = [{"inputs":[{"internalType":"address","name":"admin","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Paused","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"previousAdminRole","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"newAdminRole","type":"bytes32"}],"name":"RoleAdminChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"}],"name":"RoleGranted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"}],"name":"RoleRevoked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256[]","name":"ids","type":"uint256[]"},{"indexed":false,"internalType":"uint256[]","name":"values","type":"uint256[]"}],"name":"TransferBatch","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"TransferSingle","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"value","type":"string"},{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"}],"name":"URI","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Unpaused","type":"event"},{"inputs":[],"name":"COMMUNITY_TOKE_ID","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"DEFAULT_ADMIN_ROLE","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MINTER_ROLE","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"PAUSER_ROLE","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"id","type":"uint256"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address[]","name":"accounts","type":"address[]"},{"internalType":"uint256[]","name":"ids","type":"uint256[]"}],"name":"balanceOfBatch","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"}],"name":"getRoleAdmin","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"grantRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"hasRole","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256[]","name":"ids","type":"uint256[]"},{"internalType":"uint256[]","name":"amounts","type":"uint256[]"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"mintBatchReward","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"mintReward","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"pause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"renounceRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"revokeRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256[]","name":"ids","type":"uint256[]"},{"internalType":"uint256[]","name":"amounts","type":"uint256[]"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"safeBatchTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"unpause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"uri","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"}];

        let provider;
        let signer;
        let userAddress;
        let taskContract;
        let rewardContract;

    const statusLabels = ['Created', 'InProgress', 'Completed', 'Verified'];
    const statusColors = ['bg-blue-600', 'bg-yellow-500', 'bg-purple-600', 'bg-green-600'];

        // Login with MetaMask
        document.getElementById('loginButton').addEventListener('click', async () => {
            if (typeof window.ethereum === 'undefined') {
                alert('MetaMask is not installed!\n\nPlease install MetaMask extension to continue.\n\nVisit: https://metamask.io');
                return;
            }

            const loginBtn = document.getElementById('loginButton');
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<span class="material-symbols-outlined animate-pulse">progress_activity</span> Connecting...';

            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                // Check network - Sepolia chainId is 11155111
                const network = await provider.getNetwork();
                if (network.chainId !== 11155111) {
                    alert('‚ö†Ô∏è Wrong Network!\n\nPlease switch to Sepolia Testnet in MetaMask.\n\nCurrent network: ' + network.name);
                    
                    // Try to switch network automatically
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0xaa36a7' }], // 11155111 in hex
                        });
                        // Reload after switch
                        window.location.reload();
                    } catch (switchError) {
                        console.error('Network switch error:', switchError);
                        loginBtn.disabled = false;
                        loginBtn.innerHTML = `
                            <svg class="w-8 h-8" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M38 20C38 29.9411 29.9411 38 20 38C10.0589 38 2 29.9411 2 20C2 10.0589 10.0589 2 20 2C29.9411 2 38 10.0589 38 20Z" fill="#E17726" stroke="#E17726" stroke-width="0.25"/>
                                <path d="M20 2L14 16L20 20L26 16L20 2Z" fill="#E27625"/>
                                <path d="M20 20L14 16L11 23L20 27L29 23L26 16L20 20Z" fill="#F5841F"/>
                                <path d="M20 27L11 23L9 31L20 38L31 31L29 23L20 27Z" fill="#C0AC9D"/>
                            </svg>
                            Connect with MetaMask
                        `;
                    }
                    return;
                }
                
                taskContract = new ethers.Contract(TASK_CONTRACT_ADDRESS, TASK_CONTRACT_ABI, signer);
                rewardContract = new ethers.Contract(REWARD_CONTRACT_ADDRESS, REWARD_CONTRACT_ABI, signer);

                const balance = await provider.getBalance(userAddress);
                
                const shortAddr = userAddress.slice(0,6) + '...' + userAddress.slice(-4);
                document.getElementById('userAddress').textContent = shortAddr;
                document.getElementById('userBalance').textContent = ethers.utils.formatEther(balance) + ' ETH';
                
                // Hide login screen, show main app
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');

                await loadTasks();
                await loadRewards();
            } catch (error) {
                console.error('Connection error:', error);
                
                let errorMsg = 'Failed to connect wallet';
                if (error.code === 4001) {
                    errorMsg = 'Connection rejected.\n\nPlease approve the connection in MetaMask to continue.';
                } else if (error.message) {
                    errorMsg = error.message;
                }
                
                alert('‚ùå ' + errorMsg);
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<span class="material-symbols-outlined">account_balance_wallet</span> Connect Wallet';
            }
        });

        // Disconnect Wallet
        document.getElementById('disconnectWallet').addEventListener('click', () => {
            // Clear state
            provider = null;
            signer = null;
            userAddress = null;
            taskContract = null;
            rewardContract = null;
            
            // Show login screen, hide main app
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        });

        // Create Task
        document.getElementById('createTaskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!taskContract) {
                alert('Please connect wallet first');
                return;
            }

            const metadata = document.getElementById('taskMetadata').value;
            const rewardId = document.getElementById('rewardId').value;
            const rewardAmount = document.getElementById('rewardAmount').value;

            const resultDiv = document.getElementById('createTaskResult');
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<span class="text-yellow-400">‚è≥ Creating task...</span>';

            try {
                const amount = ethers.utils.parseEther(rewardAmount);
                const tx = await taskContract.createTask(metadata, [rewardId], [amount]);
                resultDiv.innerHTML = '<span class="text-blue-400">‚è≥ Waiting for confirmation...</span>';
                
                const receipt = await tx.wait();
                resultDiv.innerHTML = '<span class="text-green-400">‚úÖ Task created successfully!</span>';
                
                document.getElementById('createTaskForm').reset();
                setTimeout(() => loadTasks(), 2000);
            } catch (error) {
                console.error('Create task error:', error);
                resultDiv.innerHTML = `<span class="text-red-400">‚ùå Error: ${error.message}</span>`;
            }
        });

        // Load Tasks
        async function loadTasks() {
            if (!taskContract) return;

            try {
                const taskCount = await taskContract.taskCounter();
                const taskListDiv = document.getElementById('taskList');
                
                if (taskCount.eq(0)) {
                    taskListDiv.innerHTML = '<p class="text-gray-400 text-center py-8">No tasks yet. Create the first one!</p>';
                    return;
                }

                taskListDiv.innerHTML = '';
                
                for (let i = 1; i <= taskCount.toNumber(); i++) {
                    const task = await taskContract.getTask(i);
                    const statusIndex = task.status;
                    
                    const taskCard = document.createElement('div');
                    taskCard.className = 'bg-gray-700/50 rounded-lg p-4 border border-gray-600 hover:border-cyan-500 transition';
                    taskCard.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-semibold text-lg">Task #${i}</h3>
                            <span class="${statusColors[statusIndex]} text-xs px-2 py-1 rounded-full">${statusLabels[statusIndex]}</span>
                        </div>
                        <p class="text-sm text-gray-400 mb-2 break-all">${task.metadataURI}</p>
                        <div class="text-xs text-gray-500">
                            <p>Creator: ${task.creator.slice(0, 6)}...${task.creator.slice(-4)}</p>
                            ${task.completer !== ethers.constants.AddressZero ? `<p>Worker: ${task.completer.slice(0, 6)}...${task.completer.slice(-4)}</p>` : ''}
                            <p>Reward: ${ethers.utils.formatEther(task.rewardAmounts[0])} tokens (ID: ${task.rewardIds[0]})</p>
                        </div>
                    `;
                    taskListDiv.appendChild(taskCard);
                }
            } catch (error) {
                console.error('Load tasks error:', error);
            }
        }

        // Claim Task
        document.getElementById('claimTaskBtn').addEventListener('click', async () => {
            if (!taskContract) {
                alert('Please connect wallet first');
                return;
            }

            const taskId = document.getElementById('claimTaskId').value;
            const resultDiv = document.getElementById('claimResult');
            
            if (!taskId) {
                alert('Please enter a task ID');
                return;
            }

            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<span class="text-yellow-400">‚è≥ Claiming task...</span>';

            try {
                const tx = await taskContract.claimTask(taskId);
                resultDiv.innerHTML = '<span class="text-blue-400">‚è≥ Confirming...</span>';
                await tx.wait();
                resultDiv.innerHTML = '<span class="text-green-400">‚úÖ Task claimed!</span>';
                setTimeout(() => loadTasks(), 2000);
            } catch (error) {
                console.error('Claim error:', error);
                resultDiv.innerHTML = `<span class="text-red-400">‚ùå ${error.message}</span>`;
            }
        });

        // Complete Task
        document.getElementById('completeTaskBtn').addEventListener('click', async () => {
            if (!taskContract) {
                alert('Please connect wallet first');
                return;
            }

            const taskId = document.getElementById('completeTaskId').value;
            const resultDiv = document.getElementById('completeResult');
            
            if (!taskId) {
                alert('Please enter a task ID');
                return;
            }

            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<span class="text-yellow-400">‚è≥ Completing task...</span>';

            try {
                const tx = await taskContract.completeTask(taskId);
                resultDiv.innerHTML = '<span class="text-blue-400">‚è≥ Confirming...</span>';
                await tx.wait();
                resultDiv.innerHTML = '<span class="text-green-400">‚úÖ Task completed!</span>';
                setTimeout(() => loadTasks(), 2000);
            } catch (error) {
                console.error('Complete error:', error);
                resultDiv.innerHTML = `<span class="text-red-400">‚ùå ${error.message}</span>`;
            }
        });

        // Verify Task
        document.getElementById('verifyTaskBtn').addEventListener('click', async () => {
            if (!taskContract) {
                alert('Please connect wallet first');
                return;
            }

            const taskId = document.getElementById('verifyTaskId').value;
            const resultDiv = document.getElementById('verifyResult');
            
            if (!taskId) {
                alert('Please enter a task ID');
                return;
            }

            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<span class="text-yellow-400">‚è≥ Verifying task and minting rewards...</span>';

            try {
                const tx = await taskContract.verifyTask(taskId);
                resultDiv.innerHTML = '<span class="text-blue-400">‚è≥ Confirming...</span>';
                await tx.wait();
                resultDiv.innerHTML = '<span class="text-green-400">‚úÖ Task verified & rewards minted!</span>';
                setTimeout(() => {
                    loadTasks();
                    loadRewards();
                }, 2000);
            } catch (error) {
                console.error('Verify error:', error);
                resultDiv.innerHTML = `<span class="text-red-400">‚ùå ${error.message}</span>`;
            }
        });

        // Refresh Tasks
        document.getElementById('refreshTasks').addEventListener('click', loadTasks);

        // Load Rewards
        async function loadRewards() {
            if (!rewardContract || !userAddress) return;

            try {
                const rewardsDiv = document.getElementById('rewardsList');
                rewardsDiv.innerHTML = '';

                // Check balances for token IDs 0-10
                const tokenIds = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
                let hasRewards = false;

                for (const tokenId of tokenIds) {
                    const balance = await rewardContract.balanceOf(userAddress, tokenId);
                    
                    if (!balance.isZero()) {
                        hasRewards = true;
                        const card = document.createElement('div');
                        card.className = 'bg-gradient-to-br from-purple-600/20 to-pink-600/20 rounded-lg p-4 border border-purple-500/50';
                        card.innerHTML = `
                            <div class="text-center">
                                <div class="text-4xl mb-2">${tokenId === 0 ? 'ü™ô' : 'üèÖ'}</div>
                                <h3 class="font-semibold text-lg">${tokenId === 0 ? 'Community Tokens' : `Badge #${tokenId}`}</h3>
                                <p class="text-2xl font-bold text-cyan-400 mt-2">${ethers.utils.formatEther(balance)}</p>
                                <p class="text-xs text-gray-400 mt-1">${tokenId === 0 ? 'Fungible Token' : 'NFT Badge'}</p>
                            </div>
                        `;
                        rewardsDiv.appendChild(card);
                    }
                }

                if (!hasRewards) {
                    rewardsDiv.innerHTML = '<p class="text-gray-400 text-center py-8 col-span-3">No rewards yet. Complete and verify tasks to earn!</p>';
                }
            } catch (error) {
                console.error('Load rewards error:', error);
            }
        }

        // Check if already connected on page load
        window.addEventListener('load', async () => {
            if (window.ethereum && window.ethereum.selectedAddress) {
                // Auto-login if already connected
                document.getElementById('loginButton').click();
            }
        });

        // Listen for account changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    // User disconnected
                    document.getElementById('disconnectWallet').click();
                } else {
                    // Account changed, reload
                    window.location.reload();
                }
            });

            window.ethereum.on('chainChanged', () => {
                // Network changed, reload
                window.location.reload();
            });
        }
    </script>

</body>
</html>
